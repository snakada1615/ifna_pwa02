{% extends 'myApp/_base.html' %}
{% load static %}
{% load humanize %}
{% block content %}

  <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css"
        rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>

  <div id="stepid" hidden>{{ stepid }}</div>
  <div class="container" style="max-width: 540px;">
    <div class="row">
      <div class="col-2 my-0 px-3">
        <img src="{% static 'img/no2.png' %}">
      </div>
      <div class="col-8 my-0 px-1">
        <h5>
          agree on nutrition target for
          {{ myLocation.name }}
        </h5>
      </div>
      <div class="col-2 my-0 px-3">
        <div class="col-3>">
          <a id="btn_save" class="btn btn-warning text-dark mt-2 my-0 py-0 btn-sm">save</a>
        </div>
      </div>
    </div>
  </div>

  <div class="container" style="max-width: 540px;">
    <div id="accordion">
      <div class="card border-dark bg-light col-12 mt-2 py-0" style="max-width: 540px;">
        <div class="row">
          <div class="col-12">
            <div class="card-body py-0 px-0">
              <p class="card-text my-0">
                {{ myLocation.myCountry.NAME_0 }}
              </p>
              <p class="card-text my-0">
                {{ myLocation.myCountry.NAME_1 }}
                <span class="fb fb-help" data-toggle="tooltip" title="Tooltip message"></span>
              </p>
              <p class="card-text my-0">
                {{ myLocation.myCountry.NAME_2 }}
              </p>
              <p class="card-text my-0">
                {{ myLocation.myCountry.NAME_3 }}
              </p>
              <p class="card-text text-success my-0">
                {{ myLocation.name }}
              </p>
              <button class="btn btn-link" data-toggle="collapse" data-target="#more_info" aria-expanded="true"
                      aria-controls="more_info">
                more info
              </button>

              <div id="more_info" class="collapse" aria-labelledby="more_info1" data-parent="#accordion">
                <p class="card-text my-0">
                  stunting rate:
                  {{ myLocation.stunting_rate }}
                </p>
                <p class="card-text my-0">
                  wasting rate:
                  {{ myLocation.wasting_rate }}
                </p>
                <p class="card-text my-0">
                  anemia rate:
                  {{ myLocation.anemia_rate }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <span></span>
      </div>
    </div>
  </div>

  <div class="container border-secondary py-1 my-1"
       style="max-width: 540px; background-color:#F3F3F3;border-width: 2px;">
    {% include "./person_list_child3.html" %}

  </div>

  <style media="screen">
    /* nav-item activeの文字色 */
    .nav-tabs .nav-link.active, .nav-pills .show > .nav-link {
      color: red;
      background-color: #87BFCD;
    }

    /* number boxを読み取り専用に*/
    input[type="number"]:disabled {
      background: #dddddd;
    }

    .error {
      border: 1px solid #de1b1b;
    }

    tr td div.text-center {
      position: relative;
    }

    .tooltip-error {
      display: none;
      max-width: 200px;
      background: black;
      color: white;
      padding: 2px 5px;
      font-size: 13px;
      z-index: 9999;
      position: absolute;
      top: 42%;
      width: max-content;
      margin-left: 4px;
    }

    .tooltip-error:before {
      content: '';
      display: block;
      width: 0;
      height: 0;
      position: absolute;
      border-top: 6px solid transparent;
      border-bottom: 6px solid transparent;
      border-right: 8px solid black;
      left: -6px;
      top: 6px;
    }

    input.error:hover + span.tooltip-error {
      display: inline;
    }
  </style>

  <script type="text/javascript">
    $('[data-toggle="tooltip"]').tooltip();


    var myPop = {{ myPop|safe }};
    var myCommunity = {{ myCommunity|safe }};
    let url_tmp = window.location.href.split('/');
    url_tmp.pop();
    url_tmp.pop();
    url_tmp.pop();
    url_tmp.pop();
    url_tmp.pop();
    var myRoot = url_tmp.join("/") + '/';


    //////////////////btn_save_person
    $('#btn_save').click(function () {
      let hostUrl = myRoot + 'registPerson/';
      let mydat = getTblData_all();
      console.log(mydat);
      Set_CRSF();
      sendJson(mydat, hostUrl);
    });
    ////////btn_save_person///////////

    //////////////////getTblData
    function getTblData_all() { //
      let d = [];
      let dataPop = {};
      $('input[type="number"]').prop('title', '');
      $('table.tbl_pop tr input ').each(function (i, myRow) {
        $(myRow).removeClass('error');
        $(myRow).next().remove();
        if ($(myRow).attr('nut_group_id') < 10) {
          if (Number($(myRow).val()) > 0) {
            let dd = {};
            dd['target_scope'] = $(myRow).attr('target_scope');
            dd["myLocation"] = {{myLocation.id}};
            dd['myuser'] = {{ myuser.id }};
            dd['nut_group_id'] = $(myRow).attr('nut_group_id');
            dd['target_pop'] = $(myRow).val();
            d.push(dd);
          }
        } else {
          if ($(myRow).attr('nut_group_id')) {
            dataPop['#' + $(myRow).attr('id')] = $(myRow).val();
          }
        }
      });

      return {"myJson": d, "dataPop": dataPop};
    }

    //////////////////getTblData //// csrf_tokenの取得に+ myFamily.class7 + myFamily.class8使う//////////////
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = jQuery.trim(cookies[i]);
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    //------------------------------------
    function csrfSafeMethod(method) {
      // these HTTP methods do not require CSRF protection
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    //------------------------------------
    function Set_CRSF() {
      var csrf_token = getCookie("csrftoken");
      $.ajaxSetup({
        crossDomain: false, // obviates need for sameOrigin test
        beforeSend: function (xhr, settings) {
          if (!csrfSafeMethod(settings.type)) {
            xhr.setRequestHeader("X-CSRFToken", csrf_token);
          }
        }
      });
    }

    //////////////////sendJson////
    function sendJson(myjson, hostUrl) {
      $.ajax({
        type: 'post',
        url: hostUrl,
        data: JSON.stringify(myjson),
        contentType: 'application/JSON',
        dataType: 'JSON',
        scriptCharset: 'utf-8',
        success: function (res) {
          if (res.success) {
            return window.location.href = res.url;
          }
          let message = res.messages;
          let forcusTab = false;
          for (const prop in message) {
            $(prop).addClass('error').after('<span class="tooltip-error">' + message[prop] + '</span>');
            if (!forcusTab) {
              if ($('#tab2_link ' + prop).length > 0) {
                forcusTab = true;
                $('#tab2').click();
              } else if ($('#tab3_link ' + prop).length > 0) {
                forcusTab = true;
                $('#tab3').click();
              }
            }
          }
        },
        error: function (jqXHR, textStatus, errorThrown) {
          alert("Application encountered unknown error in target population setting");
          console.log(jqXHR.responseText);
          console.log(jqXHR.status); //例：404
          console.log(textStatus); //例：error
          console.log(errorThrown); //例：NOT FOUND
          console.log(JSON.stringify(myjson)); //例：NOT FOUND
          console.log(myjson); //例：NOT FOUND
        }
      });
    }//////////////////sendJson//// scfript end/////////////////////


    //////////////////合計----community
    $('.num_family3').on("input", function () {
      let sum = 0;
      $('.num_family3').each(function () {
        sum += Number($(this).val());
      });
      console.log('changed:' + sum);
      $("#inpNum9").val(sum);
    });


    $("#inpNum9").on("input", function () {
      let myPopChange = Object.assign({}, myPop);
      let currentVal = $(this).val();
      if (Number($(this).val()) < 0) {
        currentVal = 0;
      }
      let popFloatVal = {};
      let inputValNum = {};
      myPopChange.class3 = myPop.class4;
      myPopChange.class4 = myPop.class3;
      myPopChange.class5 = myPop.class6;
      myPopChange.class6 = myPop.class5;
      myPopChange.class7 = myPop.class3_p + myPop.class5_p;
      myPopChange.class8 = myPop.class3_l + myPop.class5_l;
      let currentNum = 0;
      for (let i = 0; i <= 8; i++) {
        let valNum = parseInt(currentVal) * myPopChange['class' + i] / 100;
        if (Math.floor(valNum) < 1) {
          if (Math.round(valNum) === 1) {
            popFloatVal['class' + i] = (valNum - Math.floor(valNum));
          } else {
            popFloatVal['class' + i] = (valNum - Math.floor(valNum)) * myPopChange['class' + i] / 100;
          }
        } else {
          popFloatVal['class' + i] = (valNum - Math.floor(valNum)) * myPopChange['class' + i] / 100;
        }
        inputValNum['class' + i] = Math.floor(valNum);
        currentNum += Math.floor(valNum);
      }
      let keyClassFloatSorted = Object.keys(popFloatVal).sort(function (a, b) {
        return popFloatVal[b] - popFloatVal[a]
      });
      for (let index in keyClassFloatSorted) {
        if (currentNum < parseInt(currentVal)) {
          currentNum++;
          inputValNum[keyClassFloatSorted[index]] += 1;
        }
        $("#inpNum" + keyClassFloatSorted[index].replace('class', '')).val(inputValNum[keyClassFloatSorted[index]]);
      }
    });

    //////////////////Communityの選択方式の決定-----
    $('#chk-autoCalk').change(function () {
      if ($('#chk-autoCalk').prop('checked')) {
        $('.input-manual').prop('disabled', true);
        $('.input-auto').prop('disabled', false);
      } else {
        $('.input-manual').prop('disabled', false);
        $('.input-auto').prop('disabled', true);
      }
    });
    //////////////////Communityの選択方式の決定-----


    //-----------initializationn -------

    // Print initial value in a div box
    $("#inpNum0").val(myCommunity.class0 || 0);
    $("#inpNum1").val(myCommunity.class1 || 0);
    $("#inpNum2").val(myCommunity.class2 || 0);
    $("#inpNum3").val(myCommunity.class3 || 0);
    $("#inpNum4").val(myCommunity.class4 || 0);
    $("#inpNum5").val(myCommunity.class5 || 0);
    $("#inpNum6").val(myCommunity.class6 || 0);
    $("#inpNum7").val(myCommunity.class7 || 0);
    $("#inpNum8").val(myCommunity.class8 || 0);
    tmp = Number($("#inpNum0").val()) + Number($("#inpNum1").val()) + Number($("#inpNum2").val())
            + Number($("#inpNum3").val()) + Number($("#inpNum4").val()) + Number($("#inpNum5").val())
            + Number($("#inpNum6").val()) + Number($("#inpNum7").val()) + Number($("#inpNum8").val());
    $("#inpNum9").val(tmp);

    if (tmp == 0) {
      $('#page_next').addClass('disabled');
    }

    //-----------initializationn -------

  </script>

{% endblock %}
