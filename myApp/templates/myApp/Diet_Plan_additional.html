{% extends 'myApp/_base.html' %}
{% load static %}
{% block content %}

  <script type="text/javascript" src="{% static 'DataTables/js/jquery.dataTables.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'DataTables/js/dataTables.select.min.js' %}"></script>
  <link rel="stylesheet" type="text/css" href="{% static 'DataTables/css/jquery.dataTables.min.css' %}"
        media="screen">
  <link rel="stylesheet" type="text/css" href="{% static 'DataTables/css/select.dataTables.min.css' %}"
        media="screen">
  <script type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
  <script type="text/javascript" src="{% static 'js/jquery.barrating.min.js' %}"></script>
  <link rel="stylesheet" href="{% static 'css/fontawesome-apple.css' %}">
  <link rel="stylesheet" href="{% static 'css/bars-1to10.css' %}">

  <!-------------title--------------------------->
  <div class="container" aria-live="polite" aria-atomic="true" style="max-width: 540px; position: relative;">

    <div class="container" style="max-width: 540px;">
      <div class="row">
        {% include "./_dialog01.html" %}
        <div class="col-2 my-0 px-3">
          <img src="{% static 'img/no7.png' %}" alt="number 4">
        </div>
        <div class="col-8 my-0 px-1">
          <h5>
            Diet planning for
            {{ myLocation.name }}
          </h5>
        </div>
        <div class="col-2 my-0 px-3">
          <div class="row">
            <div class="col-12">
              <span>
              <a class="btn btn-warning mt-2 my-0 py-0 btn-sm" mynum="100" id="btn_save_crop" href='#'>save</a>
            </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-------------location information--------------------------->
    <div class="container" style="max-width: 540px;">
      <div id="accordion">
        <div class="card  border-dark bg-light col-12 mt-2 py-0" style="max-width: 540px;">
          <div class="row">
            <div class="col-12">
              <div class="card-body py-0 px-0">
                <p class="card-text my-0">
                  {{ myLocation.myCountry.NAME_0 }}
                </p>
                <p class="card-text my-0">
                  {{ myLocation.myCountry.NAME_1 }}
                </p>
                <p class="card-text my-0">
                  {{ myLocation.myCountry.NAME_2 }}
                </p>
                <p class="card-text my-0">
                  {{ myLocation.myCountry.NAME_3 }}
                </p>
                <p class="card-text my-0">
                  {{ myLocation.name }}
                </p>
                <p class="card-text my-0">
                  {{ myLocation.nutrition_target }}
                </p>
                <button class="btn btn-link" data-toggle="collapse" data-target="#more_info" aria-expanded="true"
                        aria-controls="more_info">
                  more info
                </button>

                <div id="more_info" class="collapse" aria-labelledby="heading{{ crop.food_item_id }}"
                     data-parent="#accordion">
                  <p class="card-text my-0">
                    stunting rate:
                    {{ myLocation.stunting_rate }}
                  </p>
                  <p class="card-text my-0">
                    wasting rate:
                    {{ myLocation.wasting_rate }}
                  </p>
                  <p class="card-text my-0">
                    anemia rate:
                    {{ myLocation.anemia_rate }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <div id="container_tab_all" class="container border-secondary py-1 my-1 px-0"
         style="max-width: 540px; background-color:#F3F3F3;border-width: 2px;">
      <!-- 4個分のタブ -->
      <nav class="nav nav-pills" role="tablist" id="myTabs">
        <a class="flex-sm-fill text-sm-center nav-link active" href="#tab_individual" role="tab">individual</a>
        <a class="flex-sm-fill text-sm-center nav-link" href="#tab_family" role="tab">family</a>
        <a class="flex-sm-fill text-sm-center nav-link" href="#tab_community" role="tab">community</a>
      </nav>

      <!-- タブの移動先指定 -->
      <div class="tab-content mt-2" id="tabContent">
        <div class="tab-pane active" id="tab_individual" role="tabpanel">
          {% include "./Diet_Sub1.html" %}
        </div>
        <div class="tab-pane" id="tab_family" role="tabpanel">
          {% include "./Diet_Sub2.html" %}
        </div>
        <div class="tab-pane" id="tab_community" role="tabpanel">
          {% include "./Diet_Sub3.html" %}
        </div>
      </div>
    </div>

  </div>


  <!-- モーダルの設定 local crop ----------------------------->
  <div class="modal fade" id="Modal_localCrop1" mynum="0" tabindex="-1" role="dialog"
       aria-labelledby="Modal_localCropLabel">
    <div class="modal-dialog " role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add/remove food item</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="close">
            <span class="text-danger" aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-dark">
          <div class="my-2" id="myFilter1">Food group:
          </div>
          <table id="localCrop1" style="width: 100%">
            <thead>
            <tr>
              <th>s</th>
              <th>Name</th>
              <th>En</th>
              <th>Pr</th>
              <th>VA</th>
              <th>Fe</th>
              <th>c</th>
            </tr>
            </thead>

            <tfoot>
            <tr>
              <th>s</th>
              <th>Name</th>
              <th>En</th>
              <th>Pr</th>
              <th>VA</th>
              <th>Fe</th>
              <th>c</th>
            </tr>
            </tfoot>
          </table>
          <a id="btn_exit01" class="btn btn-outline-secondary text-dark mt-2 my-0 py-0 btn-sm" data-dismiss="modal">close</a>
        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>
  <!-- /.modal -->
  <!-------------------------------------->

  <!-- モーダルの設定 change diet volume----------------------------->
  <div class="container mx-0 my-0 px-0 py-0 ">
    <div class="modal fade" id="Modal_food_volume" tabindex="-1" role="dialog" aria-labelledby="Modal_foodVolLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-dark" id="Modal_foodVolLabel1">Determine the volume of food item</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body text-dark">
            <table border="1" class="table table-striped" id="tbl_food_SetWeight">
              <tr>
                <th>name</th>
                <th>En</th>
                <th>Pr</th>
                <th>Va</th>
                <th>Fe</th>
                <th>Wt</th>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
            </table>

            <span>*consumption target (1 portion=): <a href="#" id="btn_change_portion"></a>g</span>

            <div class="row pl-4">
              <div class="column-11">
                <select id="BR_food_count">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                  <option value="13">13</option>
                  <option value="14">14</option>
                  <option value="15">15</option>
                  <option value="16">16</option>
                  <option value="17">17</option>
                  <option value="18">18</option>
                  <option value="19">19</option>
                  <option value="20">20</option>
                </select>
              </div>
              <div class="column-1">
              <span class="fb fb-help d-inline" data-toggle="tooltip"
                    title="set volume of food by changing the number of apple icon below"></span>
              </div>
            </div>

            <div>*share (
              <span style="color: #5bc0de">production</span> /
              <span style="color: #cc1111">buy</span>):
              <img id="BR_buy_prod_pie_img" src="#" style="width: 30px" alt="">
              <span class="fb fb-help" data-toggle="tooltip" title="you can set buy or produce"></span>
            </div>

            <button type="button" class="btn btn-secondary mt-2" data-dismiss="modal">close</button>
            <button type="button" class="btn btn-primary mt-2" mynum="0" id="change_weight1">change value</button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
  </div>
  <!-------------------------------------->

  <!-- モーダルの設定 change balance ----------------------------->
  <div class="modal fade" id="Modal_Prod_Buy" tabindex="-1" role="dialog" aria-labelledby="Modal_foodVolLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-dark" id="Modal_foodVolLabel1">Where do you get food (field or market)?</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-dark">
          <label for="my_Prod_Buy" id="my_Prod_Buy-label1">*share (
            <span style="color: #cc1111">buy</span> /
            <span style="color: #5bc0de">production</span>):
          </label>
          <span class="fb fb-help" data-toggle="tooltip" title="Tooltip message"></span>

          <select id="my_Prod_Buy">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
          </select>

          <button type="button" class="btn btn-secondary mt-2" data-dismiss="modal">close</button>
          <button type="button" class="btn btn-primary mt-2" mynum="0" id="change_share1">change share</button>
        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>
  <!-- /.modal -->
  <!-------------------------------------->

  <!-- モーダルの設定 change portion ----------------------------->
  <div class="modal fade" id="Modal_Portion" tabindex="-1" role="dialog" aria-labelledby="Modal_PortionLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-dark" id="Modal_PortionLabel1">Please set minimum portion size</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-dark">

          <form>
            <div class="form-group row">
              <label for="old_portion" class="col-sm-4 col-form-label">current value (g)</label>
              <div class="col-sm-8">
                <input type="number" readonly class="form-control-plaintext" class="form-control" id="old_portion"
                       placeholder="portion size" value="30">
              </div>
              <label for="new_portion" class="col-sm-4 col-form-label">new value (g)</label>
              <div class="col-sm-8">
                <input type="number" class="form-control" id="new_portion" placeholder="ex.) 50..">
              </div>
            </div>
          </form>

          <button type="button" class="btn btn-secondary mt-2" data-dismiss="modal">cancel</button>
          <button type="button" class="btn btn-primary mt-2" mynum="0" id="btn_set_portion">change portion</button>
        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>
  <!-- /.modal -->
  <!-------------------------------------->

  <style media="screen">
    /* set common variable */
    :root {
      --td_wid_normal: 30;
    }

    /* force rotate when screen width less than 450 */
    @media screen and (min-width: 320px) and (max-width: 450px) and (orientation: portrait) {
      html {
        transform: rotate(-90deg);
        transform-origin: left top;
        width: 100vh;
        overflow-x: hidden;
        position: absolute;
        top: 100%;
        left: 0;
      }
    }

    .mod-tbl {
      max-width: 650px;
    }

    .mytable {
      table-layout: fixed;
      border: 2px grey solid;
      border-collapse: collapse;
      width: 100%;
    }

    .mytable tbody th {
      width: var(--td_wid_normal) px;
      min-width: var(--td_wid_normal) px;
      border-collapse: collapse;
      border: 2px grey solid;
    }

    .mytable td {
      width: var(--td_wid_normal) px;
      min-width: var(--td_wid_normal) px;
      border: 2px grey solid;
      border-collapse: collapse;
      text-align: center;
      vertical-align: middle;
    }

    .mytable th {
      color: whitesmoke;
      background-color: #49A0B5;
      border: 2px grey solid;
      border-collapse: collapse;
      text-align: center;
      vertical-align: middle;
    }

    .mytable tr:nth-child(odd) td {
      color: darkblue;
      text-align: left;
      background-color: #49A0B5;
    }

    .mytable tr:nth-child(even) td {
      color: white;
      background-color: #F9F9F9;
    }

    /* 行または列の非表示*/
    .tableItem_hide {
      display: none;
    }

    /* tablesorterのsortアイコン表示 */
    .tablesorter-headerUnSorted {
      background-image: url("{% static 'img/sort.png' %}");
      background-repeat: no-repeat;
      background-position: center right;
    }

    .tablesorter-headerAsc {
      background-image: url("{% static 'img/sort_up.png' %}");
      background-repeat: no-repeat;
      background-position: center right;
      border-bottom: #000 2px solid;
    }

    .tablesorter-headerDesc {
      background-image: url("{% static 'img/sort_down.png' %}");
      background-repeat: no-repeat;
      background-position: center right;
      border-bottom: #000 2px solid;
    }
  </style>



  <script type="text/javascript">


    $('[data-toggle="tooltip"]').tooltip();

    // グローバル変数の作成
    //    const myRange = [101, 102, 103, 104, 201, 202, 203, 204,
    //      301, 302, 303, 304];
    var season_count = {{ season_count }};
    var season_list = {{ season_list|safe }};
    var season12 = {{ season|safe }};
    var myFoodGrp = {{ mylist_Food_grp|safe }};
    var myRange = [];
    let c_index = 1;  // carouselのインデックス
    $.each(season_list, function (index, val) {
      myRange.push(Number(val) + 100);
    });
    $.each(season_list, function (index, val) {
      myRange.push(Number(val) + 200);
    });
    $.each(season_list, function (index, val) {
      myRange.push(Number(val) + 300);
    });
    var selected_rows_id = [];
    var myLocation = '';
    var myRoot = '';
    var json_crop_local_org = {{mylist_available|safe}};
    var json_crop_selected_org = {{mylist_selected|safe}};
    var json_crop_name = {{mylist_local_name|safe}};

    var target_en = [];
    var target_pr = [];
    var target_va = [];
    var target_fe = [];

    target_en[1] = {{dri_e1}};
    target_pr[1] = {{dri_p1}};
    target_va[1] = {{dri_v1}};
    target_fe[1] = {{dri_f1}};
    target_en[2] = {{dri_e2}};
    target_pr[2] = {{dri_p2}};
    target_va[2] = {{dri_v2}};
    target_fe[2] = {{dri_f2}};
    target_en[3] = {{dri_e3}};
    target_pr[3] = {{dri_p3}};
    target_va[3] = {{dri_v3}};
    target_fe[3] = {{dri_f3}};


    let url_tmp = window.location.href.split('/');
    let tmp1 = url_tmp[url_tmp.length - 2];
    url_tmp.pop();
    url_tmp.pop();
    url_tmp.pop();
    myRoot = url_tmp.join("/") + '/';
    var myLocation_id = tmp1;

    let $modal_localCrop = $('#Modal_localCrop1');
    let myTbl_food_Setweight = $('#tbl_food_SetWeight');
    let myfood_volume = {};
    let myfood_portion = {};
    let myfood_share = {};
    myfood_volume['modal'] = $('#Modal_food_volume');
    myfood_volume['save'] = $('#change_weight1');
    myfood_volume['portion'] = $('#btn_change_portion');
    myfood_volume['share'] = $('#BR_buy_prod_pie_img');
    myfood_volume['barrating'] = $('#my_Prod_Buy');
    myfood_share['modal'] = $('#Modal_Prod_Buy');
    myfood_share['save'] = $('#change_share1');
    myfood_portion['modal'] = $('#Modal_Portion');
    myfood_portion['save'] = $('#btn_set_portion');


    //////////////// initialize Food_grp_filter /////
    $('.myfilter-item').append('<a class="dropdown-item" href="#">--show all--</a>');
    $.each(myFoodGrp, function (index, val) {
      $('.myfilter-item').append('<a class="dropdown-item" href="#">' + val + '</a>');
    });

    //////////////// change common name -> local name/////
    let index = {};
    let json_crop_local = [];
    let json_crop_selected = [];
    json_crop_name.forEach(token => index[token.food_item_id] = token);
    json_crop_local_org.forEach(token => {
      if (index[token.food_item_id]) {
        token.Food_grp = index[token.food_item_id].Food_grp;
        token.Food_name = index[token.food_item_id].Food_name;
      }
      json_crop_local.push(token);
    });
    json_crop_selected_org.forEach(token => {
      if (index[token.food_item_id]) {
        token.Food_grp = index[token.food_item_id].Food_grp;
        token.Food_name = index[token.food_item_id].Food_name;
      }
      json_crop_selected.push(token);
    });
    console.log('初期選択品目の一覧：');
    console.log(json_crop_selected);
    console.log('初期利用可能品目の一覧：');
    console.log(json_crop_local);
    //---------------------------------------------

    //////////////// star rating/////
    $(function () {
      $('.rating_DRI').barrating({theme: 'bars-1to10', showSelectedRating: false, readonly: true}); // set barrating
      $('#my_Prod_Buy').barrating({theme: 'bars-1to10', showSelectedRating: true, readonly: false}); // set barrating)
      $('.share_Prod_Buy').barrating({theme: 'bars-1to10', showSelectedRating: true, readonly: true}); // set barrating)
      $('#BR_food_count').barrating({theme: 'fontawesome-apple'});
    });

    ///////////set nutrition target for each table  /////////////////////
    $('.lbl_target_en[myNum^=1]').text(target_en[1].toFixed(0));
    $('.lbl_target_pr[myNum^=1]').text(target_pr[1].toFixed(0));
    $('.lbl_target_va[myNum^=1]').text(target_va[1].toFixed(0));
    $('.lbl_target_fe[myNum^=1]').text(target_fe[1].toFixed(0));
    $('.lbl_target_en[myNum^=2]').text(target_en[2].toFixed(0));
    $('.lbl_target_pr[myNum^=2]').text(target_pr[2].toFixed(0));
    $('.lbl_target_va[myNum^=2]').text(target_va[2].toFixed(0));
    $('.lbl_target_fe[myNum^=2]').text(target_fe[2].toFixed(0));
    $('.lbl_target_en[myNum^=3]').text(target_en[3].toFixed(0));
    $('.lbl_target_pr[myNum^=3]').text(target_pr[3].toFixed(0));
    $('.lbl_target_va[myNum^=3]').text(target_va[3].toFixed(0));
    $('.lbl_target_fe[myNum^=3]').text(target_fe[3].toFixed(0));
    console.log('target_fe[2]=' + target_fe[2].toFixed(0));


    //    create object setup "Crop_Selected"   -------------------------------
    function Crop_Selected(num_tbl) {
      const found = myRange.find(element => element === num_tbl);
      if (found) {
        this.crops = [];
        this.num_tbl = num_tbl;
        this.sum_en = 0;
        this.sum_pr = 0;
        this.sum_va = 0;
        this.sum_fe = 0;
        this.month = 0;
        this.PFC_carbo = 0;
        this.PFC_prot = 0;
        this.PFC_fat = 0;

        let target_scope = Math.trunc(num_tbl / 100);
        this.target_en = target_en[target_scope];
        this.target_pr = target_pr[target_scope];
        this.target_va = target_va[target_scope];
        this.target_fe = target_fe[target_scope];

        //関連DOM要素の指定 lbl_target_en
        this.dom_lbl_target_en = '';
        this.dom_lbl_target_pr = '';
        this.dom_lbl_target_va = '';
        this.dom_lbl_target_fe = '';
        this.dom_myRating_en = '';
        this.dom_myRating_pr = '';
        this.dom_myRating_va = '';
        this.dom_myRating_fe = '';
        this.dom_btn_add = '';
        this.dom_lst_month = '';
        this.dom_tbl_Crop = '';
        this.dom_PFC = {};
        this.dom_diversity_check = {};
        this.dom_share = '';

        console.log('オブジェクトCrop_Selected' + num_tbl + 'を作成しました');
      } else {
        console.error('オブジェクトCrop_Selected' + num_tbl + 'を作成できません。テーブル番号が不正です');
      }
    }

    Crop_Selected.prototype.setDataDraw_Crop = function (crop_data) {
      this.setData_Crop(crop_data);
      this._drawRaw_single(crop_data.food_item_id);
    };
    Crop_Selected.prototype.setData_Crop = function (crop_data) {
      console.group('Crop_Selected.setData_Crop:');
      console.log(crop_data);
      if (crop_data.food_item_id && myRange.includes(crop_data.num_tbl)) {
        console.log('table_id(' + crop_data.num_tbl + ')に' + crop_data.Food_name + 'を追加します');
        let overwrite = this._delCrop(crop_data.food_item_id);       //重複業あれば削除
        this.crops.push(crop_data);
        console.error(this.crops);
        console.groupEnd();
        return overwrite;
      } else {
        console.error('crop_data did not registered');
        console.groupEnd();
        return false;
      }
    };
    Crop_Selected.prototype.setData_fromAvailable = function (num_tbl, mydata, drawFlag) {
      console.group('Crop_Selected.setData_fromAvailable:');
      let res = false;
      if (drawFlag) {       //rowの追加
        //データセットの作成1:buy_prod_share設定
        let tmp_share = 5;
        let tmp_val = Number(mydata['m' + myCrop[num_tbl].month]);
        if (tmp_val == 2) {
          tmp_share = 100;
        } else if (tmp_val == 3) {
          tmp_share = 99;
        }
        console.log('食品の入手先shareを' + tmp_share + 'に設定します');

        //データセットの作成2(crop_available -> crop_selected)
        let dd = {};
        dd["name"] = mydata['Food_name'];
        dd["Energy"] = mydata['Energy'];
        dd["Protein"] = mydata['Protein'];
        dd["VITA_RAE"] = mydata['VITA_RAE'];
        dd["FE"] = mydata['FE'];
        dd["food_item_id"] = mydata['food_item_id'];
        dd["portion_size"] = mydata['portion_size'];
        dd["share_prod_buy"] = tmp_share;
        dd["total_weight"] = 0;
        dd["count_prod"] = 0;
        dd["count_buy"] = 0;
        month_tmp = myCrop[num_tbl].month;
        dd["month"] = month_tmp;
        dd["month_availability"] = mydata['m' + String(month_tmp)];
        dd["myLocation"] = myLocation_id;
        dd["num_tbl"] = num_tbl;
        dd["target_scope"] = Math.trunc(Number(num_tbl) / 100);
        dd["Food_grp"] = mydata['Food_grp'];
        dd["Food_name"] = mydata['Food_name'];
        dd["Carbohydrate"] = mydata['Carbohydrate'];
        dd["Fat"] = mydata['Fat'];
        //-----

        this.setData_Crop(dd);                           //データの追加
        res = true;
      } else {
        res = false;
      }
      console.groupEnd();
      return res;
    };
    {% comment %}
        Crop_Selected.prototype.setData_fromListbox = function (num_tbl, mydata, drawFlag) {
          console.group('Crop_Selected.setData_fromListbox:');
          if (this.setData_fromAvailable(num_tbl, mydata, drawFlag)) {
            this._drawRaw_single(mydata["food_item_id"]);   //データの描画
            this._drawRaw_total();                      //合計行の描画
            console.log(mydata['Food_name'] + 'を追加しました');
          }
          console.groupEnd();
        };
    {% endcomment %}
    Crop_Selected.prototype._delCrop = function (food_item_id) {
      console.group('Crop_Selected._delCrop:');
      let del_index = -1;
      const found = this.crops.find(function (ele, i) {
        if (ele.food_item_id === Number(food_item_id)) {
          del_index = i;
        }
      });
      if (del_index > -1) {
        console.error(this.crops);
        this.crops.splice(del_index, 1);
        console.log('food_item_id(' + food_item_id + ')の作物選択を解除しました');
        console.error(this.crops);
      }
      console.groupEnd();
      return del_index;
    };
    Crop_Selected.prototype._delAll = function () {
      this.crops = [];
      this.dom_tbl_Crop.children('tbody').find('tr:not(:eq(0))').remove(); //先頭行以外を削除
      console.log('削除しました');
      this._drawRaw_total();
    };
    Crop_Selected.prototype.setMonth = function (month) {
      console.group('Crop_Selected.setMonth:');
      if ((month > -1) && (month < 12)) {
        this._delAll();    //作物を全部消去
        this.month = month;
        console.groupEnd();
        return true;
      }
      console.groupEnd();
      return false;
    };

    Crop_Selected.prototype.getCropList = function () {
      console.group('Crop_Selected.getCropList:');
      let found = [];
      this.crops.forEach(function (ele) {
        found.push(ele.food_item_id);
      });
      console.groupEnd();
      return found || 'none';
    };
    Crop_Selected.prototype._getCrop_byID = function (food_item_id) {
      console.group('Crop_Selected._getCrop_byID:');
      console.log('food_item_idl:' + food_item_id);
      const found = this.crops.find(element => element.food_item_id === Number(food_item_id));
      console.groupEnd();
      return found || 'none';
    };
    Crop_Selected.prototype._getCrop_byRow = function (row_id) {
      let myrow = this.dom_tbl_Crop.find('tr').eq(row_id);
      console.log(myrow.children('td').eq(7).text());
      return this._getCrop_byID(myrow.children('td').eq(7).text());
    };
    Crop_Selected.prototype.drawTable = function () {
      console.group('Crop_Selected.drawTable:');
      this.dom_tbl_Crop.children('tbody').find('tr').remove(); //全ての行を削除
      // 追加行の挿入
      for (let mycrop in this.crops) {
        let mycrop_html = this._drawRaw_setHtml(this.crops[mycrop]);
        this.dom_tbl_Crop.find('tbody').append(mycrop_html);
      }
      // 合計行の再計算の挿入
      this._drawRaw_total();
      console.groupEnd();
    };
    Crop_Selected.prototype._drawRaw_erase = function (food_item_id) {
      console.group('Crop_Selected._drawRaw_erase:');
      let del_flag = -1;
      this.dom_tbl_Crop.find('tbody tr').each(function (j, myRow) {
        if ($(myRow).children('td').eq(7).text() === String(food_item_id)) { // 指定行が存在した場合
          del_flag = j;
        }
      });
      if (del_flag > -1) {
        this.dom_tbl_Crop.find('tbody tr').eq(del_flag).remove()
      }
      console.groupEnd();
      return del_flag;
    };
    Crop_Selected.prototype._drawRaw_eraseLast = function () {
      console.group('Crop_Selected._drawRaw_eraseLast:');
      // 合計行を削除
      let lastrow = this.dom_tbl_Crop.find('tbody tr').last();
      if (lastrow.children('td').eq(0).text() === 'total') {
        lastrow.remove();
      }
      console.groupEnd();
    };
    Crop_Selected.prototype._drawRaw_single = function (food_item_id) {
      console.group('Crop_Selected._drawRaw_single:');

      let total = '';
      let add_data = this._getCrop_byID(food_item_id);
      if (add_data !== 'none') {
        // 最終行を削除
        this._drawRaw_eraseLast();
        // 重複行があレバ削除
        let rowNum = this._drawRaw_erase(food_item_id);
        console.error(rowNum);
        // 追加行の作成
        const add_data_html = this._drawRaw_setHtml(add_data);
        // 追加行の挿入
        console.error(rowNum);
        if (rowNum == 0) {
          this.dom_tbl_Crop.find('tbody tr:first').before(add_data_html);
        } else if (rowNum > 0) {
          this.dom_tbl_Crop.find('tbody tr').eq(rowNum - 1).after(add_data_html);
        } else {
          this.dom_tbl_Crop.find('tbody').append(add_data_html);
        }
        // 合計行の作成と挿入
        this._drawRaw_total();
        console.log('行の追加と合計行の再計算を終えました');
      } else {
        console.error('指定されたfood_item_id(' + food_item_id + ')は存在しません');
      }
      console.groupEnd();
    };
    Crop_Selected.prototype._drawRaw_setHtml = function (add_data) {
      console.group('Crop_Selected._drawRaw_setHtml:');
      //行の色指定
      const rowcolor = {
        '1': 'bg-success text-white',
        '2': 'bg-info text-white',
        '3': 'table-info',
        '0': 'table-secondary',
      };
      let tmp = '';

      // 追加行の作成
      let cr = '';
      cr += '<tr class="' + rowcolor[add_data.month_availability] + '">';
      cr += '<td>' + add_data.name + '</td>';
      cr += '<td>' + Math.round(add_data.Energy * add_data.total_weight / 100, 1) + '</td>';
      cr += '<td>' + Math.round(add_data.Protein * add_data.total_weight / 100, 1) + '</td>';
      cr += '<td>' + Math.round(add_data.VITA_RAE * add_data.total_weight / 100, 1) + '</td>';
      cr += '<td>' + Math.round(add_data.FE * add_data.total_weight / 100, 1) + '</td>';
      cr += '<td>' + add_data.total_weight + '</td>';
      cr += '<td class="tableItem_hide"></td>';
      cr += '<td class="tableItem_hide">' + add_data.food_item_id + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.portion_size + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.count_prod + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.count_buy + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.Energy + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.Protein + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.VITA_RAE + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.FE + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.share_prod_buy + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.Food_grp + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.month_availability + '</td>';
      cr += '</tr>';

      console.groupEnd();
      return cr;
    };
    Crop_Selected.prototype._drawRaw_total = function () {
      console.group('Crop_Selected._drawRaw_total:');
      // 合計行を削除
      this._drawRaw_eraseLast();
      // 合計行の再計算
      this._Sum_Nutrition();
      // 合計行の挿入
      target_scope = Math.trunc(this.num_tbl / 100);
      total = '<tr><td>total</td>' +
              this._setCellColor(Math.round(this.sum_en), target_en[target_scope]) +
              this._setCellColor(Math.round(this.sum_pr), target_pr[target_scope]) +
              this._setCellColor(Math.round(this.sum_va), target_va[target_scope]) +
              this._setCellColor(Math.round(this.sum_fe), target_fe[target_scope]) +
              '<td></td><td class="tableItem_hide"><' + '/td><td class="tableItem_hide">' +
              '</td><td class="tableItem_hide"></td><td class="tableItem_hide">' +
              '</td><td class="tableItem_hide"></td><td class="tableItem_hide"></td></tr>';
      this.dom_tbl_Crop.append(total);
      // Barratingセット
      this._SetBarrating();

      // PFCの挿入
      try {
        this.dom_PFC[1].text(this.PFC_carbo);
        this.dom_PFC[2].text(this.PFC_prot);
        this.dom_PFC[3].text(this.PFC_fat);
      } catch (e) {
        console.log(e);
        console.log('dom_PFCが見つかりません');
      }

      console.log('合計を再計算しました');
      console.groupEnd();
    };
    Crop_Selected.prototype._SetBarrating = function () {
      console.group('Crop_Selected._SetBarrating:');
      let rate_en = Math.round(this.sum_en * 10 / this.target_en);
      if (rate_en > 10) {
        rate_en = 10;
      } else if (rate_en < 1) {
        rate_en = 1;
      }
      let rate_pr = Math.round(this.sum_pr * 10 / this.target_pr);
      if (rate_pr > 10) {
        rate_pr = 10;
      } else if (rate_pr < 1) {
        rate_pr = 1;
      }
      let rate_va = Math.round(this.sum_va * 10 / this.target_va);
      if (rate_va > 10) {
        rate_va = 10;
      } else if (rate_va < 1) {
        rate_va = 1;
      }
      let rate_fe = Math.round(this.sum_fe * 10 / this.target_fe);
      if (rate_fe > 10) {
        rate_fe = 10;
      } else if (rate_fe < 1) {
        rate_fe = 1;
      }
      this.dom_myRating_en.barrating('set', rate_en); // set barrating
      this.dom_myRating_pr.barrating('set', rate_pr); // set barrating
      this.dom_myRating_va.barrating('set', rate_va); // set barrating
      this.dom_myRating_fe.barrating('set', rate_fe); // set barrating
      console.groupEnd();
    };
    Crop_Selected.prototype._setCellColor = function (i_cell, i_target) {
      let res = '';
      cNum = parseInt(i_cell * 100 / i_target, 10);
      switch (true) {
        case 0 <= cNum && cNum < 50:
          res = '<td style="color:red;">' + i_cell + '</td>';
          break;

        case 50 <= cNum && cNum < 100:
          res = '<td style="color:orange;">' + i_cell + '</td>';
          break;

        case 100 <= cNum:
          res = '<td style="color:green;">' + i_cell + '</td>';
          break;

        default:
          res = '<td>' + i_cell + '</td>';
          break;
      }
      return res;
    };
    Crop_Selected.prototype._Sum_Nutrition = function () {
      console.group('Crop_Selected:_Sum_Nutrition');
      let sum_en_tmp = 0;
      let sum_pr_tmp = 0;
      let sum_va_tmp = 0;
      let sum_fe_tmp = 0;
      let sum_pfc_carbo_tmp = 0;
      let sum_pfc_prot_tmp = 0;
      let sum_pfc_fat_tmp = 0;
      let share_prod = 0;
      let share_buy = 0;
      let weight = 0;
      let _this = this;
      let myGrp = [
        'Grains, roots and tubers ',
        'Legumes and nuts ',
        'Dairy products ',
        'Flesh foods ',
        'Eggs ',
        'Vitamin A rich fruits and Vegetable ',
        'Other fruits and vegetables '
      ];
      try {
        this.dom_diversity_check[1].prop('checked', false);
        this.dom_diversity_check[2].prop('checked', false);
        this.dom_diversity_check[3].prop('checked', false);
        this.dom_diversity_check[4].prop('checked', false);
        this.dom_diversity_check[5].prop('checked', false);
        this.dom_diversity_check[6].prop('checked', false);
        this.dom_diversity_check[7].prop('checked', false);
      } catch (error) {
        console.error(error);
      }

      this.crops.forEach(function (elem) {
        weight = elem.total_weight;
        sum_en_tmp += elem.Energy * weight / 100;
        sum_pr_tmp += elem.Protein * weight / 100;
        sum_va_tmp += elem.VITA_RAE * weight / 100;
        sum_fe_tmp += elem.FE * weight / 100;
        sum_pfc_carbo_tmp += elem.Carbohydrate * weight / 100;
        sum_pfc_prot_tmp += elem.Protein * weight / 100;
        sum_pfc_fat_tmp += elem.Fat * weight / 100;
        share_prod += elem.portion_size * elem.count_prod;
        share_buy += elem.portion_size * elem.count_buy;
        let food_grp_tmp = elem.Food_grp;
        console.log(elem);
        console.log(food_grp_tmp);
        console.log(myGrp.indexOf(food_grp_tmp));
        try {
          _this.dom_diversity_check[Number(myGrp.indexOf(food_grp_tmp) + 1)].prop('checked', true);
        } catch (error) {
          console.error(error);
        }
      });
      this.sum_en = sum_en_tmp;
      this.sum_pr = sum_pr_tmp;
      this.sum_va = sum_va_tmp;
      this.sum_fe = sum_fe_tmp;
      let sum = sum_pfc_carbo_tmp + sum_pfc_prot_tmp + sum_pfc_fat_tmp;
      let sum_source = share_buy + share_prod;
      console.log('sum_pfc_carbo_tmp=' + sum_pfc_carbo_tmp);
      console.log('sum_pfc_prot_tmp=' + sum_pfc_prot_tmp);
      console.log('sum_pfc_fat_tmp=' + sum_pfc_fat_tmp);
      this.PFC_carbo = Math.round(sum_pfc_carbo_tmp * 100 / sum) || 0;
      this.PFC_prot = Math.round(sum_pfc_prot_tmp * 100 / sum) || 0;
      this.PFC_fat = Math.round(sum_pfc_fat_tmp * 100 / sum) || 0;
      this.dom_share.barrating('set', Math.round(share_prod * 10 / sum_source) || 1); // set barrating

      console.groupEnd();
    };
    Crop_Selected.prototype._setDiversity = function (index, setCheck) {
      console.group('Crop_Selected:_setDiversity');
      if (index < 8 && index > 0) {
        let myDom = "";
        switch (index) {
          case 1:
            myDom = this.dom_diversity_check1;
            break;
          case 2:
            myDom = this.dom_diversity_check2;
            break;
          case 3:
            myDom = this.dom_diversity_check3;
            break;
          case 4:
            myDom = this.dom_diversity_check4;
            break;
          case 5:
            myDom = this.dom_diversity_check5;
            break;
          case 6:
            myDom = this.dom_diversity_check6;
            break;
          case 7:
            myDom = this.dom_diversity_check7;
            break;
        }
        if (setCheck) {
          myDom.prop('checked', true);

        } else {

        }
      } else {
        console.error('Index out of range')
      }
      this.dom_diversity_check1.removeAttr('checked');
      this.dom_diversity_check2.removeAttr('checked');
      this.dom_diversity_check3.removeAttr('checked');
      this.dom_diversity_check4.removeAttr('checked');
      this.dom_diversity_check5.removeAttr('checked');
      this.dom_diversity_check6.removeAttr('checked');
      this.dom_diversity_check7.removeAttr('checked');

      console.groupEnd();
    };
    Crop_Selected.prototype._getPFC = function (food_item_id) {
      console.group('Crop_Selected:_getPFC');
      const crop = json_crop_local.filter(function (element) {
        return element.food_item_id === Number(food_item_id);
      });

      let carbo = 0;
      let prot = 0;
      let fat = 0;

      try {
        console.log(crop[0].Food_name + 'のPFCバランスをチェックします');
        // console.log(crop[0]);
        carbo = crop[0].Carbohydrate || 0;
        prot = crop[0].Protein || 0;
        fat = crop[0].Fat || 0;
      } catch (e) {
        console.error(e);
        console.error('該当作物が見つかりません');
      }
      console.groupEnd();
      return {carbo: carbo, prot: prot, fat: fat}
    };


    Crop_Selected.prototype.myfilter = function (key) {
      console.log('Crop_Selected.myfilterにFilterを適用します');

      this.dom_tbl_Crop.find('tr').each(function (index, val) {
        let tmpval = $(val).children('td').eq(16).text();
        if (key === '--show all--' || tmpval === key) {
          $(val).removeClass('tableItem_hide');
        } else {
          $(val).addClass('tableItem_hide');
        }
      });
      console.groupEnd();
    };

    Crop_Selected.prototype.sayhello = function () {
    };


    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///////
    ///////   ここから下のDatatablesは、今後使わない
    ///////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    var Crop_available = $('#localCrop1').DataTable({
      "data": json_crop_local,
      "autoWidth": true,
      "myFeeling": "Happy",
      "pageLength": 50,
      "columns": [
        {
          "data": "selected_status"
        }, {
          "data": "Food_name"
        }, {
          "data": "Energy"
        }, {
          "data": "Protein"
        }, {
          "data": "VITA_RAE"
        }, {
          "data": "FE"
        }, {
          "data": "Food_grp"
        }, {
          "data": "Weight"
        }, {
          "data": "portion_size"
        }, {
          "data": "m1"
        }, {
          "data": "m2"
        }, {
          "data": "m3"
        }, {
          "data": "m4"
        }, {
          "data": "m5"
        }, {
          "data": "m6"
        }, {
          "data": "m7"
        }, {
          "data": "m8"
        }, {
          "data": "m9"
        }, {
          "data": "m10"
        }, {
          "data": "m11"
        }, {
          "data": "m12"
        }, {
          "data": "food_item_id"
        }, {
          "data": "count_prod"
        }, {
          "data": "count_buy"
        }
      ],

      "columnDefs": [
        {
          targets: [
            1, 2, 3, 4, 5
          ],
          visible: true
        }, {
          targets: '_all',
          bVisible: false
        }, {
          "orderSequence": ["desc"],
          "targets": [2]
        }, {
          "orderSequence": ["desc"],
          "targets": [3]
        }, {
          "orderSequence": ["desc"],
          "targets": [4]
        }, {
          "orderSequence": ["desc"],
          "targets": [5]
        }
      ],

      "initComplete": function (settings, json) {
        // ////add filtering dropdown list
        this.api().columns([6]).every(function () {
          var column = this;
          var select = $('<select style="border: 1px grey double;"><option value=""></option></select>').appendTo($('#myFilter1')).on('change', function () {
            var val = $.fn.dataTable.util.escapeRegex($(this).val());

            column.search(
                    val
                            ? '^' + val + '$'
                            : '',
                    true,
                    false
            ).draw();
          });
          column.data().unique().sort().each(function (d, j) {
            select.append('<option value="' + d + '">' + d + '</option>');
          });
        });
      },
    });

    $.fn.dataTable.Api.register('hello()', function (a) {
      console.log(a);
    });

    $.fn.dataTable.Api.register('receive_Selection()', function (month, num_table, selected_list) {
      let myMonth = 0;
      if (num_table < 200) {
        myMonth = $('.lst_month[myNum=' + num_table + ']').prop("selectedIndex");
      } else {
        myMonth = $('.lst_month[myNum=' + num_table + ']').text() - 1;
      }
      $modal_localCrop.attr('myNum', num_table);      //table番号の記録
      $modal_localCrop.attr('myMonth', month);  //該当月の記録

      this.rows().deselect();

      //filter crop by month//
      for (var i = 9; i < 21; i++) {
        this.column(i).search('').columns().search('').draw();
      }
      this.column(myMonth + 9).search('[123]', true, false).draw();

      /// give selected status to the currently selected item//
      this.rows().every(function (rowIdx, tableLoop, rowLoop) {
        let myrow = this.data();
        if (selected_list.indexOf(myrow.food_item_id) >= 0) {
          this.select();
        }
      });
    });

    $.fn.dataTable.Api.register('send_Selection()', function (id_row) {

      console.log(a);
    });
    $.fn.dataTable.Api.register('hello()', function (a) {
      console.log(a);
    });

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///////
    ///////   ここまで不要。
    ///////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


    /////    create object setup "Crop_Selected"   -------------------------------
    function Crop_individual(num_tbl) {
      const found = myRange.find(element => element === num_tbl);
      if (found) {
        this.num_tbl = num_tbl;
        this.data = {};

        //関連DOM要素の指定 lbl_target_en
        this.dom_tbl = myTbl_food_Setweight;
        this.dom_modal = myfood_volume.modal;
        this.dom_btn_save = myfood_volume['save'];
        this.dom_btn_por = myfood_volume['portion'];
        this.dom_br_count = $('#BR_food_count');
        this.dom_img_pie = myfood_volume['share'];

        console.log('オブジェクトCrop_individual(' + num_tbl + ')を作成しました');
      } else {
        console.error('オブジェクトCrop_individual(' + num_tbl + ')を作成できません。テーブル番号が不正です');
      }
    }

    Crop_individual.prototype.setData = function (data) {
      console.group('Crop_individual:init');
      this.data = data;
      this.dom_tbl.children('tbody').children('tr').remove(); //tbl_food_SetWeightのテーブル初期化

      let cr = '<tr><th>name</th><th>En</th><th>Pr</th><th>Va</th><th>Fe</th><th class="tableItem_hide">por</th>'
              + '<th class="tableItem_hide">count_p</th><th class="tableItem_hide">count_b</th></tr>';
      cr += '<tr>';
      cr += '<td>' + data.name + '</td>';
      cr += '<td>' + Math.round(data.Energy * data.total_weight / 100, 1) + '</td>';
      cr += '<td>' + Math.round(data.Protein * data.total_weight / 100, 1) + '</td>';
      cr += '<td>' + Math.round(data.VITA_RAE * data.total_weight / 100, 1) + '</td>';
      cr += '<td>' + Math.round(data.FE * data.total_weight / 100, 1) + '</td>';
      cr += '<td class="tableItem_hide portion_size">' + data.portion_size + '</td>';
      cr += '<td class="tableItem_hide count_prod">' + data.count_prod + '</td>';
      cr += '<td class="tableItem_hide count_buy">' + data.count_buy + '</td>';
      cr += '<td class="tableItem_hide share_prod_buy">' + data.share_prod_buy + '</td>';
      cr += '</tr>';

      console.log('作物(' + data.name + ')を描画します');
      console.log(data);
      this.dom_tbl.append(cr);
      this.dom_btn_por.text(data.portion_size); //ポーションサイズ設定
//      this.dom_br_count.barrating('set', data.count_prod + data.count_buy); //摂取量の設定
      let count_all = Number(data.count_prod + data.count_buy) || 1;
      this.dom_br_count.barrating('set', count_all); //摂取量の設定
      this.setPie_img(data.share_prod_buy); //Buy＿Prod _shaeの設定

      console.groupEnd();
    };
    Crop_individual.prototype.setData_portion = function (data) {
      console.group('Crop_individual:receive_portion');
      let por = data.portion_size;
      if (por) {
        this.data.portion_size = por;
        this.dom_btn_por.text(por);
        this.dom_tbl.find('tr').eq(1).children('td').eq(5).text(por);
        console.log('portion_sizeを' + por + 'に変更しました');
      } else {
        console.error('portion_sizeを変更できません');
      }
      console.groupEnd();
    };
    Crop_individual.prototype.setPie_img = function (i_share) {
      if (i_share === 99) {
        i_share = 0;
      } else if (i_share === 100) {
        i_share = 10;
      }
      let h = "/static/img/pie_" + String(i_share) + ".png";
      console.log('prod/buy shareを' + i_share + 'に設定します');
      this.dom_img_pie.attr('src', h);
    };
    Crop_individual.prototype.getData_FoodWt = function () {
      console.group('Crop_individual:getData_FoodWt');
      let count_all = Number(this.dom_br_count.children("option:selected").val());
      let share_prod_buy_tmp = Number(this.data.share_prod_buy);
      if (share_prod_buy_tmp === 100) {
        share_prod_buy_tmp = 10;
      }
      if (share_prod_buy_tmp === 99) {
        share_prod_buy_tmp = 0;
      }
      let count_prod = Math.trunc(count_all * share_prod_buy_tmp / 10);
      let count_buy = count_all - count_prod;
      let portion_size = this.data.portion_size;
      this.data.count_prod = count_prod;
      this.data.count_buy = count_buy;
      this.data.total_weight = portion_size * count_all;
      console.log(this.data.name + 'を更新します');
      console.log(this.data);
      console.groupEnd();
      return this.data;
    };

    //---------
    function Crop_Portion() {
      this.crop = {};
      this.dom_modal = myfood_portion['modal'];
      this.dom_old_portion = $('#old_portion');
      this.dom_new_portion = $('#new_portion');
      this.dom_btn_set_portion = myfood_portion['save'];
    }

    Crop_Portion.prototype.setData = function (data) {
      console.group('Crop_Portion.setData');
      myfood_volume['modal'].modal('hide');//(Modalの入れ替え)
      this.crop = data;
      let por = this.crop.portion_size;
      this.dom_old_portion.val(por);
      this.dom_new_portion.val('');
      console.groupEnd();
      this.dom_modal.modal('show');
    };
    Crop_Portion.prototype.getData = function () {
      console.group('Crop_Portion.getData');
      let por = this.dom_new_portion.val();
      this.crop.portion_size = por;
      this.dom_modal.modal('hide');
      console.log('Portionサイズを' + por + 'gに変更します');
      console.groupEnd();
      return this.crop;
    };
    /// ---- change portion size (Modalの入れ替え)--------
    myfood_portion['modal'].on('hide.bs.modal', function () {
      myfood_volume['modal'].modal('show');
    });///-------------------------------

    //---------
    function Crop_Share() {
      this.crop = {};
      this.dom_modal = myfood_volume['modal'];
      this.dom_BR_share = myfood_volume['barrating'];
    }

    Crop_Share.prototype.setData = function (crop_data) {
      console.group('Crop_Share.SetData');
      this.crop = crop_data;
      myShare = Number(crop_data.share_prod_buy);
      let res = '';
      if (myShare > 10) {
        let mes = crop_data.name +
                ' is only available from ' + (myShare == 100 ? 'production' : 'the market') + ' for this month';
        alert(mes);
        res = false;
      } else {
        console.log('share_prod_buyを' + myShare + 'に設定します');
        this.dom_BR_share.barrating('set', myShare);// set barrating
        res = true;
      }
      console.groupEnd();
      return res;
    };
    Crop_Share.prototype.getData = function () {
      console.group('Crop_Share.getData');
      let myShare = Number(this.dom_BR_share.children("option:selected").val());
      this.crop.share_prod_buy = myShare;
      let cou = this.crop.count_prod + this.crop.count_share;
      this.crop.count_prod = Math.trunc(myShare * cou / 10);
      this.crop.count_buy = cou - this.crop.count_prod;
      console.groupEnd();
      return this.crop;
    };

    //---------

    ////////// Filter Crop_Selected table ////////////
    $(".myfilter-item a").click(function () {
      let x = $(this).text();
      let i_tmp = Number($(this).parent().parent().find('.myfilter').attr('mypage'));
      i_tmp += Number(c_index);
      myCrop[String(i_tmp)].myfilter(x);
    });


    ////////// start crop selection (local -> selected)
    $('.btn_add_crop').on('click', function () {
      let tmp_num = $(this).attr('myNum');
      let tmp_month = myCrop[tmp_num].month;
      let tmp_crop_selected = myCrop[tmp_num].getCropList();
      Crop_available.data().receive_Selection(tmp_month, tmp_num, tmp_crop_selected);
      $('#Modal_localCrop1').modal('show');
    }); ///////////////////////////////////////////////

    {% comment %}
        ///-------------------------------
        $('#localCrop1 tbody').on('click', 'tr', function () {
          $(this).toggleClass('selected');
          let mydata = Crop_available.row(this).data();
          let num_tbl = $modal_localCrop.attr('myNum');
          myCrop[num_tbl].setData_fromListbox(num_tbl, mydata, $(this).hasClass('selected'));
        });
    {% endcomment %}

    //////////////////set food volume////#
    $(".selected_crops_tbl").on("click", "td", function () {
      console.group('selected_crops_tbl:click');
      let myNum_tmp = $(this).parents('.selected_crops_tbl').attr('myNum');//テーブル番号の取得
      let myrow = $(this).closest('tbody tr')[0].rowIndex;
      if (myrow < $(this).parents().children('tbody tr').length) {
        let dat = myCrop[myNum_tmp]._getCrop_byRow(myrow);
//      myCrop[myNum_tmp].sendData_cropInd(myrow);
        myCrop_individual[myNum_tmp].setData(dat);
        myfood_volume['modal'].attr('myNum', myNum_tmp); //table番号の記録
        myfood_volume['modal'].modal('show');
      }
      console.groupEnd();
    });

    ////////////////// button click to reflect the modification　#
    myfood_volume['save'].click(function () {
      console.group('change_weight1:click');
      let myNum_tmp = myfood_volume.modal.attr('myNum');//テーブル番号の取得
      console.log('table(' + myNum_tmp + ')を変更します');
      let data = myCrop_individual[myNum_tmp].getData_FoodWt();
      myCrop[myNum_tmp].setDataDraw_Crop(data);

      myfood_volume['modal'].modal('hide');
      console.groupEnd();
    });

    ////////////////// change month
    $('.lst_month').change(function () {
      console.group('#lst_month.click');
      if (confirm('Are you sure to change month to ' + $(this).val() + '?')) {
        myCrop[$(this).attr('myNum')].setMonth($(this).prop('selectedIndex'));
      } else {
        $(this).prop('selectedIndex', $(this).attr('previousIndex'));
      }
      console.groupEnd();
    });
    $(".lst_month").click(function () {
      $(this).attr('previousIndex', $(this).prop('selectedIndex'));
    });

    /// ---- set portion size --------
    myfood_volume['portion'].on('click', function () {
      console.group('#btn_change_portion.click');
      let myNum_tmp = myfood_volume.modal.attr('myNum');//テーブル番号の取得
      console.log(myNum_tmp);
      let crop = myCrop_individual[myNum_tmp].data;
      myCrop_portion.setData(crop);
      console.groupEnd();
    });

    /// ---- set portion size --------
    myfood_portion['save'].on('click', function () {
      console.group('#btn_set_portion.click');
      let myNum_tmp = myfood_volume.modal.attr('myNum');//テーブル番号の取得
      console.log(myNum_tmp);
      let crop = myCrop_portion.getData();
      myCrop_individual[myNum_tmp].setData_portion(crop);   //Crop_individualのdata更新
      myCrop[myNum_tmp].setData_Crop(crop);                 //Crop_selectedのdata更新
      console.groupEnd();
    });

    //---------set balance prodoce/purchase -----------
    myfood_volume['share'].on('click', function () {
      console.group('#BR_buy_prod_pie_img.click');
      let myNum_tmp = myfood_volume.modal.attr('myNum');//テーブル番号の取得
      console.log(myNum_tmp);
      let crop = myCrop_individual[myNum_tmp].data;
      let res = myCrop_share.setData(crop);
      if (res) {
        myfood_volume['modal'].modal('hide');//(Modalの入れ替え)
        myfood_share['modal'].modal('show');
      }
      console.groupEnd();
    });

    //// set balance produce/purchase ---------------------------
    myfood_share['save'].on('click', function () {
      console.group('#change_share1.click');
      let myNum_tmp = myfood_volume['modal'].attr('myNum');//テーブル番号の取得
      let crop = myCrop_share.getData();
      console.log(crop);
      console.log('count_p=' + crop.count_prod + ', count_b= ' + crop.count_buy + ', myShare=' + crop.share_prod_buy);
      myCrop_individual[myNum_tmp].setData(crop);   //Crop_individualのdata更新
      myCrop[myNum_tmp].setData_Crop(crop);          //Crop_selectedのdata更新
      myfood_volume['modal'].attr('myNum', myNum_tmp); //table番号の記録
      myfood_volume['modal'].modal('show');
      myfood_share['modal'].modal('hide');
      console.groupEnd();
    });


    //////////////////btn_save_crop
    $('#btn_save_crop').click(function () {
      console.group('#btn_save_crop.click');
      let hostUrl = myRoot + 'registDiet/';
      let mydat = getTblData();
      return;

      console.log('データを保存する準備ができました');
      Set_CRSF();
      sendJson(mydat, hostUrl);
      console.groupEnd();
    }); ////////btn_save_crop///////////

    //////////////////getTblData
    function getTblData() {
      console.group('getTblData');
      let d = [];
      $('.selected_crops_tbl').each(function (i, myTbl) {
        $(myTbl).children('tbody').children('tr').each(function (j, myRow) {
          let dd = {};
          if ($(myRow).children('td').eq(0).text() !== '' && $(myRow).children('td').eq(0).text() !== 'total'
                  && $(myRow).children('td').eq(5).text() !== '0') {
            //   dd["myName"] = $(myRow).children('td').eq(0).text();
            dd["total_weight"] = $(myRow).children('td').eq(5).text();
            dd["food_item_id"] = $(myRow).children('td').eq(7).text();
            dd["portion_size"] = $(myRow).children('td').eq(8).text();
            dd["count_prod"] = $(myRow).children('td').eq(9).text();
            dd["count_buy"] = $(myRow).children('td').eq(10).text();
            dd["share_prod_buy"] = $(myRow).children('td').eq(15).text();

            let myNum_tmp = $(myTbl).attr('myNum');
            let myMonth = 0;
            myMonth = Number($('.lst_month[myNum=' + myNum_tmp + ']').text());
            console.log(myNum_tmp + 'hey hey-- ' + myMonth);
            dd["month"] = myMonth;
            dd["myid_tbl"] = myNum_tmp;
            dd["myLocation"] = myLocation_id;
            dd["target_scope"] = Math.trunc(myNum_tmp / 100);

            d.push(dd);
            //------------同一季節内の他の月に複製------------
            const current_season = season12['m' + String(myMonth) + '_season'];
            for (let j = 1; j < 13; j++) {
              if (String(season12['m' + String(j) + '_season']) === String(current_season) && j !== myMonth) {
                let dd2 = {};
                Object.assign(dd2, dd);
                dd2["month"] = j;
                dd2["myid_tbl"] = -1;
                d.push(dd2);
              }
            }
          }
        })
      });
      console.log('selected_crops_tblのデータを送信します');
      console.log(d);
      console.groupEnd();
      return {"myJson": d};
    }


    //////////////////getTblData //// csrf_tokenの取得に使う//////////////
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = jQuery.trim(cookies[i]);
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function csrfSafeMethod(method) {
      // these HTTP methods do not require CSRF protection
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    function Set_CRSF() {
      var csrf_token = getCookie("csrftoken");
      $.ajaxSetup({
        crossDomain: false, // obviates need for sameOrigin test
        beforeSend: function (xhr, settings) {
          if (!csrfSafeMethod(settings.type)) {
            xhr.setRequestHeader("X-CSRFToken", csrf_token);
          }
        }
      });
    }

    //////////////////sendJson////
    function sendJson(myjson, hostUrl) {
      $.ajax({
        type: 'post',
        url: hostUrl,
        data: JSON.stringify(myjson),
        contentType: 'application/JSON',
        dataType: 'JSON',
        scriptCharset: 'utf-8',
        success: function (response) {
          window.location.href = response.url;
        },
        error: function (jqXHR, textStatus, errorThrown) {
          alert("fail");
          console.log(jqXHR.responseText);
          console.log(jqXHR.status); //例：404
          console.log(textStatus); //例：error
          console.log(errorThrown); //例：NOT FOUND
          console.log(JSON.stringify(myjson)); //例：NOT FOUND
          console.log(myjson); //例：NOT FOUND
        }
      });
    }

    //---------------------------------------------
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////

    let myCrop = {};
    for (let i in myRange) {
      myCrop[myRange[i]] = new Crop_Selected(myRange[i]);
    }

    let myCrop_individual = {};
    for (let i in myRange) {
      myCrop_individual[myRange[i]] = new Crop_individual(myRange[i]);
    }

    let myCrop_portion = new Crop_Portion();
    let myCrop_share = new Crop_Share();

    //  myRating_**を配列に組み込む -----------
    $('.rating_DRI').each(function (i) {
      let tmp_myNum = $(this).attr('myNum');
      i = (i) % 4;
      switch (i) {
        case 0:
          myCrop[tmp_myNum].dom_myRating_en = $(this);
          break;
        case 1:
          myCrop[tmp_myNum].dom_myRating_pr = $(this);
          break;
        case 2:
          myCrop[tmp_myNum].dom_myRating_va = $(this);
          break;
        case 3:
          myCrop[tmp_myNum].dom_myRating_fe = $(this);
          break;
      }
    });

    //  selected_crops_tbl_**を配列に組み込む -----------
    $('.selected_crops_tbl').each(function () {
      let num_tbl = $(this).attr('myNum');
      myCrop[num_tbl].dom_tbl_Crop = $(this);
    });

    //  btn_add_crop_**を配列に組み込む -----------
    $('.btn_add_crop').each(function () {
      let num_tbl = $(this).attr('myNum');
      myCrop[num_tbl].dom_btn_add = $(this);
    });

    //  lst_monthを配列に組み込む -----------
    $('.lst_month').each(function () {
      let num_tbl = $(this).attr('myNum');
      myCrop[num_tbl].dom_lst_month = $(this);
    });

    //  shareを配列に組み込む -----------
    $('.share_Prod_Buy').each(function () {
      let num_tbl = $(this).attr('myNum');
      myCrop[num_tbl].dom_share = $(this);
    });

    //  PFCを配列に組み込む -----------
    $('.PFC').each(function () {
      console.log('PFCを配列に組み込む');
      let num_tbl = $(this).attr('myNum');
      let id_category = $(this).attr('index_Food_grp');
      console.log('PFCを配列に組み込む' + num_tbl);
      myCrop[num_tbl].dom_PFC[id_category] = $(this);
    });

    //  Diversityを配列に組み込む -----------
    $('.diversity_check').each(function () {
      console.log('PFCを配列に組み込む');
      let num_tbl = $(this).attr('myNum');
      let id_category = $(this).attr('index_Food_grp');
      console.log('Diversityを配列に組み込む' + num_tbl);
      myCrop[num_tbl].dom_diversity_check[id_category] = $(this);
    });

    //  テーブルごとのmonthを配列に組み込む -----------
    for (let i in myRange) {
      let num_tbl = myRange[i];
      let tmp_dat = myCrop[num_tbl];
      console.error(num_tbl);
      myCrop[num_tbl].month = Number(tmp_dat.dom_lst_month.text());
      console.error(num_tbl);
      myCrop[num_tbl].dom_btn_add.attr('myNum', num_tbl);
    }

    //  lbl_target_**を配列に組み込む -----------
    $('.lbl_target_en').each(function () {
      let num_tbl = $(this).attr('myNum');
      myCrop[num_tbl].dom_lbl_target_en = $(this);
    });

    $('.lbl_target_pr').each(function () {
      let num_tbl = $(this).attr('myNum');
      myCrop[num_tbl].dom_lbl_target_pr = $(this);
    });

    $('.lbl_target_va').each(function () {
      let num_tbl = $(this).attr('myNum');
      myCrop[num_tbl].dom_lbl_target_va = $(this);
    });

    $('.lbl_target_fe').each(function () {
      let num_tbl = $(this).attr('myNum');
      myCrop[num_tbl].dom_lbl_target_fe = $(this);
    });
    //-------------

    //初期データの読み込み
    let num_tbl = 0;
    let month = 0;
    for (let i in myRange) {
      num_tbl = myRange[i];
      month = myCrop[num_tbl].month;
      json_crop_local.forEach(data => {
        if (data['m' + month] > 0) {
          myCrop[num_tbl].setData_fromAvailable(num_tbl, data, true);
        }
      })
    }

    for (var i = 0; i < json_crop_selected.length; i++) {
      data = json_crop_selected[i];
      if (data.myLocation === Number(myLocation_id)) {
        //let num_tbl = data.num_tbl;
        myCrop[data.num_tbl].setData_Crop(data);
      }
    }


    Crop_available.data().hello("test desu");

    //---tabの切替処理-------------
    let activeTab = $('#myTabs a').filter('.active');

    $('#myTabs a').click(function (e) {
      e.preventDefault();

      activeTab.removeClass('active');
      $(activeTab.attr('href')).removeClass('active');

      activeTab = $(this);

      activeTab.addClass("active");
      $(activeTab.attr('href')).addClass('active');
    });
    //---tabの切替処理-------------

    //---carouselの切替処理-------------
    let myMonth = ['January', 'February', 'March', 'April', 'May', 'June', 'July',
      'August', 'September', 'Octoer', 'November', 'December'];
    $('#btn_car_prev1').click(function () {
      $('#carouselControl1').carousel('prev');
      c_index = $('#carouselControl1 div.active').index() || season_count;
      $('#title_diet1').text("Diet for Season " + c_index);
    });
    $('#btn_car_next1').click(function () {
      $('#carouselControl1').carousel('next');
      c_index = ($('#carouselControl1 div.active').index() + 2) % season_count || season_count;
      $('#title_diet1').text("Diet for Season " + c_index);
    });
    $('#btn_car_prev2').click(function () {
      $('#carouselControl2').carousel('prev');
      c_index = $('#carouselControl2 div.active').index() || season_count;
      $('#title_diet2').text('Diet for Season ' + c_index);
    });
    $('#btn_car_next2').click(function () {
      $('#carouselControl2').carousel('next');
      c_index = ($('#carouselControl2 div.active').index() + 2) % season_count || season_count;
      $('#title_diet2').text('Diet for Season ' + c_index);
    });
    $('#btn_car_prev3').click(function () {
      $('#carouselControl3').carousel('prev');
      c_index = $('#carouselControl3 div.active').index() || season_count;
      $('#title_diet3').text('Diet for Season' + c_index);
    });
    $('#btn_car_next3').click(function () {
      $('#carouselControl3').carousel('next');
      c_index = ($('#carouselControl3 div.active').index() + 2) % season_count || season_count;
      $('#title_diet3').text('Diet for Season ' + c_index);
    });

    //---carouselの切替処理-------------
    //---carouselの初期値-------------
    $('#title_diet1').text('Diet for Season 1');
    $('#title_diet2').text('Diet for Season 1');
    $('#title_diet3').text('Diet for Season 1');
    //---carouselの初期値-------------

    //全ての変数を読み込んでからBarratingをセット
    $(window).on("load", function () {
      // Handler when all assets (including images) are loaded
      for (let i in myRange) {
        myCrop[myRange[i]].drawTable();
      }
      $('.selected_crops_tbl').tablesorter();
    });

  </script>


{% endblock %}
