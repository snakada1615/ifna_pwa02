{% extends 'myApp/base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
  <script type="text/javascript" src="{% static 'DataTables/js/jquery.dataTables.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'DataTables/js/dataTables.select.min.js' %}"></script>
  <link rel="stylesheet" type="text/css" href="{% static 'DataTables/css/jquery.dataTables.min.css' %}" media="screen">
  <link rel="stylesheet" type="text/css" href="{% static 'DataTables/css/select.dataTables.min.css' %}" media="screen">

  <script>
    // URLパラメータの取得
    var myFamily = '';
    var myRoot = '';
    var items = [];
    var myList1 = [];

    // グローバル変数の作成
    var selected_rows_id = []

    getHTML_param = function () {
      var url_tmp = window.location.href.split('/');
      var tmp1 = url_tmp[url_tmp.length - 4];
      var tmp2 = url_tmp[url_tmp.length - 3];
      var tmp3 = url_tmp[url_tmp.length - 2];
      url_tmp.pop();
      url_tmp.pop();
      url_tmp.pop();
      url_tmp.pop();
      url_tmp.pop();
      myRoot = url_tmp.join("/") + '/';
      myFamily = tmp1;
      items.length = 0;
      if (tmp3 == '0') {
        items.push('0');
      } else if (tmp3.indexOf('-') < 0) {
        items.push(tmp3);
      } else {
        items = tmp3.split('-');
      }

      myList1.length = 0;
      if (tmp2 == '0') {
        myList1.push('0');
      } else if (tmp2.indexOf('-') < 0) {
        myList1.push(tmp2);
      } else {
        myList1 = tmp2.split('-');
      }
      return tmp1;
    }

    $(document).ready(function () {
      var mytable = $('#example').DataTable({
        "ajax": "{% static 'DataTables/data/FCT2.txt' %}",
        "pageLength": 50,
        "columns": [
          {
            "data": "row_sel"
          }, {
            "data": "Food_name"
          }, {
            "data": "Protein"
          }, {
            "data": "VITA_RAE"
          }, {
            "data": "FE"
          }, {
            "data": "row_filter"
          }, {
            "data": "Food_grp"
          }, {
            "data": "Weight"
          }
        ],

        "columnDefs": [
          {
            targets: [
              0,
              1,
              2,
              3,
              4,
              5
            ],
            visible: true
          }, {
            targets: '_all',
            visible: false
          }, {
            "orderSequence": ["desc"],
            "targets": [2]
          }, {
            "orderSequence": ["desc"],
            "targets": [3]
          }, {
            "orderSequence": ["desc"],
            "targets": [4]
          }, {
            "orderSequence": ["desc"],
            "targets": [5]
          }
        ],

        "initComplete": function (settings, json) {
          getHTML_param();
          mytable.rows().every(function (rowIdx, tableLoop, rowLoop) {
            var data = this.data();
            if (myList1.indexOf(data.food_item_id) >= 0) {
              this.cell(rowIdx, 5).data("1");
              if (items.indexOf(data.food_item_id) >= 0) {
                this.select();
                this.cell(rowIdx, 0).data("1");
              }
            }
          });

          ////////////////// fllter only date with column(5) = 1

          this.api().columns([5]).every(function () {
            var column = this;
            console.log('test');
            val = 1;
            column.search(
              val
                ? '^' + val + '$'
                : '',
              true,
              false
            ).draw();
          });

          //////////////////add filtering dropdown list
          this.api().columns([6]).every(function () {
            var column = this;
            var select = $('<select><option value=""></option></select>').appendTo($('#myFilter')).on('change', function () {
              var val = $.fn.dataTable.util.escapeRegex($(this).val());

              column.search(
                val
                  ? '^' + val + '$'
                  : '',
                true,
                false
              ).draw();
            });

            column.data().unique().sort().each(function (d, j) {
              select.append('<option value="' + d + '">' + d + '</option>');
            });
          })
        }
      });

      //////////////////add selected rows to text box
      $('#example tbody').on('click', 'tr', function () {
        $(this).toggleClass('selected');

        jQuery('#selected_crops_tbl tr').remove();
        selected_rows_id.length = 0;
        sum_pr = 0;
        sum_va = 0;
        sum_fe = 0;
        cr = '<tr><th>name</th><th>Pr</th><th>Va</th><th>Fe</th><th>Wt</th></tr><tr>';
        mytable.rows('.selected').every(function (rowIdx, tableLoop, rowLoop) {
          var data = this.data();
          cr += '<td>' + data.Food_name + '</td>';
          cr += '<td>' + Math.round(data.Protein * data.Weight / 100, 1) + '</td>';
          cr += '<td>' + Math.round(data.VITA_RAE * data.Weight / 100, 1) + '</td>';
          cr += '<td>' + Math.round(data.FE * data.Weight / 100, 1) + '</td>';
          cr += '<td>' + data.Weight + '</td>';
          cr += '</tr>';
          sum_pr += data.Protein * data.Weight / 100;
          sum_va += data.VITA_RAE * data.Weight / 100;
          sum_fe += data.FE * data.Weight / 100;
          selected_rows_id.push(rowIdx);
        });
        cr += '<tr><td>total</td><td>' + Math.round(sum_pr) + '</td><td>' + Math.round(sum_va) + '</td><td>' + Math.round(sum_fe) + '</td><td></td></tr>';
        jQuery('#selected_crops_tbl').append(cr);
      });

      //////////////////register selected commodity ////
      $('#button').click(function () {
        var w = "";
        var n = "";
        mytable.rows('.selected').every(function (rowIdx, tableLoop, rowLoop) {
          var data = this.data();
          n += "-" + data.food_item_id;
          w += "-" + data.Weight;

          // ... do something with data(), or this.node(), etc
        });
        n = n.substring(1);
        if (n == '') {
          n = 0;
        }
        w = w.substring(1);
        if (w == '') {
          w = 0;
        }
        location.href = myRoot + 'registCrops/' + myFamily + '/' + n + '/' + w + '/1/';
      });

      //////////////////add table edit function////
      $("#selected_crops_tbl").on("click", "td", function () {
        $('#selected_row').val($(this).closest('tr').index());
        $('#rewriteCell').val($(this).text());
      });

      ////////////////// button click to reflect the modification ////
      $('#button2').click(function () {
        var tmp_v = $('#rewriteCell').val();
        $('#selected_crops_tbl tr').eq($('#selected_row').val()).children('td').eq(4).text(tmp_v);
        mytable.row(selected_rows_id[$('#selected_row').val()-1]).data().Weight = tmp_v;

        ///////////////////
        jQuery('#selected_crops_tbl tr').remove();
        selected_rows_id.length = 0;
        sum_pr = 0;
        sum_va = 0;
        sum_fe = 0;
        cr = '<tr><th>name</th><th>Pr</th><th>Va</th><th>Fe</th><th>Wt</th></tr><tr>';
        mytable.rows('.selected').every(function (rowIdx, tableLoop, rowLoop) {
          var data = this.data();
          cr += '<td>' + data.Food_name + '</td>';
          cr += '<td>' + Math.round(data.Protein * data.Weight / 100, 1) + '</td>';
          cr += '<td>' + Math.round(data.VITA_RAE * data.Weight / 100, 1) + '</td>';
          cr += '<td>' + Math.round(data.FE * data.Weight / 100, 1) + '</td>';
          cr += '<td>' + data.Weight + '</td>';
          cr += '</tr>';
          sum_pr += data.Protein * data.Weight / 100;
          sum_va += data.VITA_RAE * data.Weight / 100;
          sum_fe += data.FE * data.Weight / 100;
          selected_rows_id.push(rowIdx);
        });
        cr += '<tr><td>total</td><td>' + Math.round(sum_pr) + '</td><td>' + Math.round(sum_va) + '</td><td>' + Math.round(sum_fe) + '</td><td></td></tr>';
        jQuery('#selected_crops_tbl').append(cr);
        //////////////////
      });
    });
  </script>


  <input type="hidden" value="" id="selected_row">

  <div class="container" style="max-width: 540px;">
    <div class="row">
      <div class="col-2 my-0 px-3">
        <img src="{% static 'img/no5.png' %}">
      </div>
      <div class="col-10 my-0 px-1">
        <h5>
          Diet planning for
          {{name}}
        </h5>
      </div>
    </div>
  </div>

  <div class="container text-white" style="max-width: 540px;">
    <div id="accordion">
      <div class="card border-primary bg-info col-12 mt-2 py-0" style="max-width: 540px;">
        <div class="row">
          <div class="col-12">
            <div class="card-body py-0 px-0">
              <p class="card-text text-warning my-0">
                name:
                {{ name }}
              </p>
              <p class="card-text my-0">
                country:
                {{ name.country_test.NAME_0 }}
              </p>
              <p class="card-text my-0">
                region:
                {{ name.country_test.NAME_1 }}
              </p>
              <p class="card-text my-0">
                province:
                {{ name.country_test.NAME_2 }}
              </p>
              <p class="card-text my-0">
                nutrition target:
                {{ name.nutrition_target }}
              </p>
              <button class="btn btn-link" data-toggle="collapse" data-target="#more_info" aria-expanded="true" aria-controls="more_info">
                more info
              </button>

              <div id="more_info" class="collapse" aria-labelledby="heading{{crop.food_item_id}}" data-parent="#accordion">
                <p class="card-text my-0">
                  stunting rate:
                  {{ name.stunting_rate }}
                </p>
                <p class="card-text my-0">
                  wasting rate:
                  {{ name.wasting_rate }}
                </p>
                <p class="card-text my-0">
                  anemia rate:
                  {{ name.anemia_rate }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container text-white" style="max-width: 540px;">
    <div class="card border-primary bg-info col-12 mt-2" style="max-width: 540px;">
      <div class="card-body py-2 px-0">
        <p class="card-text my-0">
          Nutrition Target:
        </p>
        <div class="table-responsive table-bordered table-striped text-white">
          <table>
            <tbody>
              <tr>
                <td class="text-warning px-1">Target group</td>
                {% for family in families %}
                  <td class="px-1">{{family.nut_group}}</td>
                {% endfor %}
              </tr>
              <tr>
                <td class="text-warning px-1">population size</td>
                {% for family in families %}
                  <td class="px-1">{{family.target_pop}}</td>
                {% endfor %}
              </tr>
              <tr>
                <td class="text-warning px-1">protein(g/day)</td>
                {% for family in families %}
                  <td class="px-1">{{family.protein|floatformat:2}}</td>
                {% endfor %}
              </tr>
              <tr>
                <td class="text-warning px-1">VitA(μg/day)</td>
                {% for family in families %}
                  <td class="px-1">{{family.vita|floatformat:2}}</td>
                {% endfor %}
              </tr>
              <tr>
                <td class="text-warning px-1">Fe(mg/day)</td>
                {% for family in families %}
                  <td class="px-1">{{family.fe|floatformat:2}}</td>
                {% endfor %}
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="container text-white" style="max-width: 540px;">
    <div class="card border-primary bg-info col-12 mt-2 py-0" style="max-width: 540px;">
      <div class="row">
        <div class="col-12">
          <div class="card-body py-0 px-0">
            <p class="card-title text-warning my-0">
              selected commodities
            </p>
            <table border="1" id="selected_crops_tbl">
              <tr>
                <th>name</th>
                <th>Pr</th>
                <th>Va</th>
                <th>Fe</th>
                <th>Wt</th>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
            </table>
            <input type="text" id="rewriteCell" value=''>
            <a id="button2" class="btn btn-warning text-dark mt-2 my-0 py-0 btn-sm">change</a>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <span>
          <a class="btn btn-outline-secondary mt-2 my-0 py-0 btn-sm" href="{% url 'person_list' familyid=familyid %}">back</a>
        </span>
        <span>
          <a id="button" class="btn btn-outline-secondary text-dark mt-2 my-0 py-0 btn-sm">save</a>
        </span>
      </div>
    </div>
  </div>

  <hr>

  <div class="container" style="max-width: 540px;">
    <div class="my-2" id="myFilter">Food group:
    </div>
    <table id="example" class="display compact" cellspacing="0" width="100%">
      <thead>
        <tr>
          <th>s</th>
          <th>Name</th>
          <th>Pr</th>
          <th>VA</th>
          <th>Fe</th>
          <th>c</th>
        </tr>
      </thead>

      <tfoot>
        <tr>
          <th>s</th>
          <th>Name</th>
          <th>Pr</th>
          <th>VA</th>
          <th>Fe</th>
          <th>c</th>
        </tr>
      </tfoot>
    </table>
  </div>

{% endblock %}
