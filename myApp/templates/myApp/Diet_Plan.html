{% extends 'myApp/_base.html' %}
{% load static %}
{% block content %}

  <script type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
  <script type="text/javascript" src="{% static 'js/jquery.barrating.min.js' %}"></script>
  <link rel="stylesheet" href="{% static 'css/fontawesome-apple.css' %}">
  <link rel="stylesheet" href="{% static 'css/bars-1to10.css' %}">

  <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css"
        rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>

  <!-------------title--------------------------->
  <div id="stepid" hidden>{{ stepid }}</div>
  <div class="container" aria-live="polite" aria-atomic="true" style="max-width: 540px; position: relative;">

    <div class="container" style="max-width: 540px;">
      <div class="row">
        {% include "./_dialog01.html" %}
        <div class="col-2 my-0 px-3">
          {% if stepid == 400 %}
            <img src="{% static 'img/no4.png' %}" alt="number 4">
          {% elif stepid == 700 %}
            <img src="{% static 'img/no7.png' %}" alt="number 7">
          {% endif %}
        </div>
        <div class="col-8 my-0 px-1">
          <h5>
            Diet planning for
            {{ myLocation.name }}
          </h5>
        </div>
        <div class="col-2 my-0 px-3">
          <div class="row">
            <div class="col-12">
              <span>
              <a class="btn btn-warning mt-2 my-0 py-0 btn-sm pointer_hand" mynum="100" id="btn_save_crop" >save</a>
            </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-------------current tab--------------------------->
    <div hidden id="current_tab"></div>
    <!-------------current page--------------------------->
    <div hidden id="current_page"></div>
    <!-------------location information--------------------------->
    <div class="container" style="max-width: 540px;">
      <div id="accordion">
        <div class="card  border-dark bg-light col-12 mt-2 py-0" style="max-width: 540px;">
          <div class="row">
            <div class="col-12">
              <div class="card-body py-0 px-0">
                <p class="card-text my-0">
                  {{ myLocation.myCountry.NAME_0 }}
                </p>
                <p class="card-text my-0">
                  {{ myLocation.myCountry.NAME_1 }}
                </p>
                <p class="card-text my-0">
                  {{ myLocation.myCountry.NAME_2 }}
                </p>
                <p class="card-text my-0">
                  {{ myLocation.myCountry.NAME_3 }}
                </p>
                <p class="card-text my-0">
                  {{ myLocation.name }}
                </p>
                <p class="card-text my-0">
                  {{ myLocation.nutrition_target }}
                </p>
                <button class="btn btn-link" data-toggle="collapse" data-target="#more_info"
                        aria-expanded="true"
                        aria-controls="more_info">
                  more info
                </button>

                <div id="more_info" class="collapse" aria-labelledby="heading{{ crop.food_item_id }}"
                     data-parent="#accordion">
                  <p class="card-text my-0">
                    stunting rate:
                    {{ myLocation.stunting_rate }}
                  </p>
                  <p class="card-text my-0">
                    wasting rate:
                    {{ myLocation.wasting_rate }}
                  </p>
                  <p class="card-text my-0">
                    anemia rate:
                    {{ myLocation.anemia_rate }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <div id="container_tab_all" class="container border-secondary py-1 my-1 px-0"
         style="max-width: 540px; background-color:#F3F3F3;border-width: 2px;">
      <div class="text-center text-white bg-info">target group</div>
      <!-- ここにタブが入る -->
      <nav class="nav nav-pills" role="tablist" id="myTabs">
      </nav>

      <!-- タブの移動先指定 -->
      <div class="tab-content mt-2" id="tabContent">
      </div>
    </div>

  </div>


  <!-- モーダルの設定 local crop ----------------------------->
  <div class="modal fade" id="Modal_localCrop1" mynum="0" tabindex="-1" role="dialog"
       aria-labelledby="Modal_localCropLabel">
    <div class="modal-dialog " role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add/remove food item</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="close">
            <span class="text-danger" aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-dark">
          <div class="my-2 myFilter" id="myFilter1">Food group:
          </div>
          <table id="localCrop1" style="width: 100%">
            <thead>
            <tr>
              <th>s</th>
              <th>Name</th>
              <th>En</th>
              <th>Pr</th>
              <th>VA</th>
              <th>Fe</th>
              <th>c</th>
            </tr>
            </thead>

            <tfoot>
            <tr>
              <th>s</th>
              <th>Name</th>
              <th>En</th>
              <th>Pr</th>
              <th>VA</th>
              <th>Fe</th>
              <th>c</th>
            </tr>
            </tfoot>
          </table>
          <a id="btn_exit01" class="btn btn-outline-secondary text-dark mt-2 my-0 py-0 btn-sm"
             data-dismiss="modal">close</a>
        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>
  <!-- /.modal -->
  <!-------------------------------------->

  <!-- モーダルの設定 change diet volume----------------------------->
  <div class="container mx-0 my-0 px-0 py-0 ">
    <div class="modal fade" id="Modal_food_volume" tabindex="-1" role="dialog" aria-labelledby="Modal_foodVolLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-dark" id="Modal_foodVolLabel1">Determine the volume of food
              item</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body text-dark">
            <table border="1" class="table table-striped" id="tbl_food_SetWeight">
              <tr>
                <th>name</th>
                <th>En</th>
                <th>Pr</th>
                <th>Va</th>
                <th>Fe</th>
                <th>Wt</th>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
            </table>

            <!-- モーダルの設定 change diet volume (Individual/Family用)----------------------------->
            <div id="toggle_visible_individual">
              <span>*consumption target (1 portion=): <a class="pointer_hand" id="btn_change_portion"></a>g</span>

              <div class="row pl-4">
                <div class="column-11">
                  <select id="BR_food_count">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                  </select>
                </div>
                <div class="column-1">
              <span class="fb fb-help d-inline" data-toggle="tooltip"
                    title="set volume of food by changing the number of apple icon below"></span>
                </div>
              </div>

              <div>*share (
                <span style="color: #5bc0de">production</span> /
                <span style="color: #cc1111">buy</span>):
                <img id="BR_buy_prod_pie_img" src="#" style="width: 30px" alt="">
                <span class="fb fb-help" data-toggle="tooltip"
                      title="you can set buy or produce"></span>
              </div>

            </div>

            <!-- モーダルの設定 change diet volume (Communituy専用)----------------------------->
            <div id="toggle_visible_comm">
              <div class="form-group">
                <label for="food_weight_community">Weight in kg:</label>
                <input type="number" class="form-control" id="food_weight_community">
              </div>
            </div>

            <button type="button" class="btn btn-secondary mt-2" data-dismiss="modal">close</button>
            <button type="button" class="btn btn-primary mt-2" mynum="0" id="change_weight1">change value
            </button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
  </div>
  <!-------------------------------------->

  <!-- モーダルの設定 change balance ----------------------------->
  <div class="modal fade" id="Modal_Prod_Buy" tabindex="-1" role="dialog" aria-labelledby="Modal_foodVolLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-dark" id="Modal_foodVolLabel1">Where do you get food (field or
            market)?</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-dark">
          <label for="my_Prod_Buy" id="my_Prod_Buy-label1">*share (
            <span style="color: #cc1111">buy</span> /
            <span style="color: #5bc0de">production</span>):
          </label>
          <span class="fb fb-help" data-toggle="tooltip" title="Tooltip message"></span>

          <select id="my_Prod_Buy">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
          </select>

          <button type="button" class="btn btn-secondary mt-2" data-dismiss="modal">close</button>
          <button type="button" class="btn btn-primary mt-2" mynum="0" id="change_share1">change share
          </button>
        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>
  <!-- /.modal -->
  <!-------------------------------------->

  <!-- モーダルの設定 change portion ----------------------------->
  <div class="modal fade" id="Modal_Portion" tabindex="-1" role="dialog" aria-labelledby="Modal_PortionLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-dark" id="Modal_PortionLabel1">Please set minimum portion size</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-dark">

          <form>
            <div class="form-group row">
              <label for="old_portion" class="col-sm-4 col-form-label">current value (g)</label>
              <div class="col-sm-8">
                <input type="number" readonly class="form-control-plaintext" class="form-control"
                       id="old_portion"
                       placeholder="portion size" value="30">
              </div>
              <label for="new_portion" class="col-sm-4 col-form-label">new value (g)</label>
              <div class="col-sm-8">
                <input type="number" max="10000" class="form-control" id="new_portion" placeholder="ex.) 50..">
              </div>
            </div>
          </form>

          <button type="button" class="btn btn-secondary mt-2" data-dismiss="modal">cancel</button>
          <button type="button" class="btn btn-primary mt-2" mynum="0" id="btn_set_portion">change portion
          </button>
        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>
  <!-- /.modal -->
  <!-------------------------------------->

  <!-- ここから Tabのテンプレート ----------------------------->
  <script id="template_Tab" type="text/x-custom-template">
    <div class="row d-flex">
      <div class="col-2">
        <a class="btn mt-2 my-0 py-0 btn-sm btn_car_prev class-myNum pointer_hand"
           style="background-color:#ADC757;">prev</a>
        <div class="dropdown my-1 ">
          <button type="button dropdown-filter"
                  class="btn btn-sm btn-secondary dropdown-toggle myfilter class-mypage"
                  data-toggle="dropdown"
                  aria-haspopup="true"
                  aria-expanded="false">
            filter
          </button>
          <div class="dropdown-menu myfilter-item class-myNum">
          </div>
        </div>
      </div>
      <div class="col-8">
        <div class="font-weight-bold row justify-content-center align-self-center title_diet class-mypage"></div>
      </div>
      <div class="col-2">
        <a class="btn mt-2 my-0 py-0 btn-sm btn_car_next class-myNum pointer_hand"
           style="background-color:#ADC757;">next</a>
      </div>
    </div>

    <div class="carousel slide class-myNum" data-interval="false" data-ride="carousel">
      <div class="carousel-inner">
      </div>
    </div>
  </script>
  <!-- templateここまで ----------------------------->

  <!-- ここから Carouselのテンプレート ----------------------------->
  <script id="template_Carousel" type="text/x-custom-template">
    <div class="carousel-item class-myNum">
      <div class="card border-success border-5 rounded col-12 mt-2 py-2"
           style="max-width: 540px; color:#24535F ;background-color:#D9ECDC;">
        <div class="row">
          <div class="col-12">
            <div class="card-body py-0 px-0 ">
              <div class="card border-success bg-white rounded col-12 px-1 py-1 my-1" style="color:#24535F ;background-color:#D9ECDC;
               border-width: 2px;">
                <div class="card-header bg-info text-white p-1 d-flex">
                  <div class="card-header bg-info text-white mr-auto p-2">
                    Diet plan during: <span
                          class="season_name font-weight-bolder text-warning"></span>
                    <span hidden
                          class="lst_month text-dark mx-1 class-myNum season_first_month"></span>
                  </div>
                  <div><a class="btn mt-2 my-0 py-0 btn-sm replicator class-myNum"
                          style="background-color:#ADC757;">copy</a></div>
                  <div class="p-2"><input type="checkbox" data-toggle="toggle" data-on="unhide 0"
                                          class="hide_zero class-myNum" data-off="hide 0"
                                          data-width="100"
                                          data-size="xs"></div>
                </div>

                <!-- この下に季節毎のテーブルが挿入される ----------------------------->
                <table border="1"
                       class="table table-fixed-100 table-success selected_crops_tbl mt-2 class-myNum">
                  <thead style="font-style: italic;background-color: #c0c0c0">
                  <th>
                    name:
                  </th>
                  <th>En</th>
                  <th>Pr</th>
                  <th>Va</th>
                  <th>Fe</th>
                  <th>Wt</th>
                  <th class="tableItem_hide">id</th>
                  <th class="tableItem_hide">food_item_id</th>
                  <th class="tableItem_hide">portion_size</th>
                  <th class="tableItem_hide">count_prod</th>
                  <th class="tableItem_hide">count_buy</th>
                  <th class="tableItem_hide">En0</th>
                  <th class="tableItem_hide">Pr0</th>
                  <th class="tableItem_hide">Va0</th>
                  <th class="tableItem_hide">Fe0</th>
                  <th class="tableItem_hide">share</th>
                  <th class="tableItem_hide">Food_grp</th>
                  <th class="tableItem_hide">Mon_avail</th>
                  </thead>
                  <tbody>
                  </tbody>
                  <tfoot>
                  <tr>
                    <td>total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <th class="tableItem_hide"></th>
                    <th class="tableItem_hide"></th>
                    <th class="tableItem_hide"></th>
                    <th class="tableItem_hide"></th>
                    <th class="tableItem_hide"></th>
                    <th class="tableItem_hide"></th>
                    <th class="tableItem_hide"></th>
                    <th class="tableItem_hide"></th>
                    <th class="tableItem_hide"></th>
                    <th class="tableItem_hide"></th>
                    <th class="tableItem_hide"></th>
                    <th class="tableItem_hide"></th>
                  </tr>
                  </tfoot>
                </table>
                <div hidden
                     class="btn_add_crop btn btn-block btn-secondary text-dark mt-0 my-0 py-0 btn-sm class-myNum"
                     style="background-color:#ADC757;">add food item
                  <span class="fb fb-help" data-toggle="tooltip"
                        title="you can add/edit food item for selected month here"></span>
                </div>

                <p class="card-title text-dark my-1 pl-1">
                  <span>cell color: seasonal availability</span>
                  <span data-toggle="tooltip" style="color:#cce5ff" title="less than 50%">■■ </span>
                  <span data-toggle="tooltip" style="color:#F6B0DC" title="more than 50%"> ■■ </span>
                  <span data-toggle="tooltip" style="color:#E93EAA" title="100%"> ■■ </span>
                </p>
                <p class="card-title text-dark my-1 pl-1">
                  <span>text color: nutrition satisfication</span>
                  <span data-toggle="tooltip" style="color:red" title="less than 50%">■■ </span>
                  <span data-toggle="tooltip" style="color:orange" title="50-100%"> ■■ </span>
                  <span data-toggle="tooltip" style="color:green" title="over 100%"> ■■ </span>
                </p>

              </div>

              <!-- ここから 栄養バランスの評価 ----------------------------->

              <div class="card rounded border-success col-12 px-1 py-1 mt-3" style="color:#24535F ;background-color:#D9ECDC;
               border-width: 2px;">
                <div class="card-header bg-info text-white p-1 mb-2">
                  nutrient balance (daily total)
                  <span class="fb fb-help" data-toggle="tooltip"
                        title="nutrient balance of selected diet combination"></span>
                </div>

                <div class="form-row no-gutters my-0 py-0" style="height:30px;">
                  <div class="col-3">
                    <label class="text-dark" for="rating_en">Energy</label>
                  </div>
                  <div class="col-2">
                    <div class="text-dark lbl_target_en class-myNum"></div>
                  </div>
                  <div class="col-7">
                    <select class="rating_DRI rating_en class-myNum">
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                      <option value="6">6</option>
                      <option value="7">7</option>
                      <option value="8">8</option>
                      <option value="9">9</option>
                      <option value="10">10</option>
                    </select>
                  </div>
                </div>

                <div class="form-row no-gutters my-0 py-0" style="height:30px;">
                  <div class="col-3">
                    <label class="text-dark" for="rating_pr">Protein</label>
                  </div>
                  <div class="col-2">
                    <div class="text-dark lbl_target_pr class-myNum"></div>
                  </div>
                  <div class="col-7">
                    <select class="rating_DRI rating_pr class-myNum">
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                      <option value="6">6</option>
                      <option value="7">7</option>
                      <option value="8">8</option>
                      <option value="9">9</option>
                      <option value="10">10</option>
                    </select>
                  </div>
                </div>

                <div class="form-row no-gutters my-0" style="height:30px;">
                  <div class="col-3">
                    <label class="text-dark" for="rating_va">VitA</label>
                  </div>
                  <div class="col-2">
                    <div class="text-dark lbl_target_va class-myNum"></div>
                  </div>
                  <div class="col-7">
                    <select class="rating_DRI rating_va class-myNum">
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                      <option value="6">6</option>
                      <option value="7">7</option>
                      <option value="8">8</option>
                      <option value="9">9</option>
                      <option value="10">10</option>
                    </select>
                  </div>
                </div>

                <div class="form-row no-gutters my-0" style="height:30px;">
                  <div class="col-3">
                    <label class="text-dark " for="rating_fe">Iron</label>
                  </div>
                  <div class="col-2">
                    <div class="text-dark lbl_target_fe class-myNum"></div>
                  </div>
                  <div class="col-7">
                    <select class="rating_DRI rating_fe class-myNum">
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                      <option value="6">6</option>
                      <option value="7">7</option>
                      <option value="8">8</option>
                      <option value="9">9</option>
                      <option value="10">10</option>
                    </select>
                  </div>
                </div>

                <div class="row no-gutters my-0 py-0" style="height:30px;">
                  <div class="col-3 text-dark">Target group</div>
                </div>

              </div>

              <!-- ここから Dietary Diversityの評価 ----------------------------->

              <div class="card rounded border-success col-12 px-1 py-1 mt-3" style="color:#24535F ;background-color:#D9ECDC;
               border-width: 2px;">
                <div class="card-header bg-info text-white p-1 mb-2">
                  <span>Dietary diversity</span>
                  <span class="fb fb-help" data-toggle="tooltip" data-html="true"
                        title="combination of <b>over three type of food group</b> is recommended"></span>
                </div>
                <div class="card-body bg-white py-0 my-0 px-1">
                  <div class="row">
                    <div class="col">
                      <fieldset disabled>
                        <div class="form-check custom-control custom-checkbox">
                          <input class="form-check-input diversity_check class-myNum custom-control-input"
                                 index_Food_grp="1" type="checkbox"
                                 value="">
                          <label class="form-check-label custom-control-label"
                                 for="diversity_check1">
                            Grains, roots and tubers
                          </label>
                        </div>
                        <div class="form-check custom-control custom-checkbox">
                          <input class="form-check-input diversity_check class-myNum custom-control-input"
                                 index_Food_grp="2"
                                 type="checkbox" value="">
                          <label class="form-check-label custom-control-label"
                                 for="diversity_check2">
                            Legumes and nuts
                          </label>
                        </div>
                        <div class="form-check custom-control custom-checkbox">
                          <input class="form-check-input diversity_check class-myNum custom-control-input"
                                 index_Food_grp="3" type="checkbox"
                                 value="">
                          <label class="form-check-label custom-control-label"
                                 for="diversity_check3">
                            Dairy products
                          </label>
                        </div>
                        <div class="form-check custom-control custom-checkbox">
                          <input class="form-check-input diversity_check class-myNum custom-control-input"
                                 index_Food_grp="4" type="checkbox"
                                 value="">
                          <label class="form-check-label custom-control-label"
                                 for="diversity_check4">
                            Flesh foods
                          </label>
                        </div>
                        <div class="form-check custom-control custom-checkbox">
                          <input class="form-check-input diversity_check class-myNum custom-control-input"
                                 index_Food_grp="5" type="checkbox"
                                 value=""
                          >
                          <label class="form-check-label custom-control-label"
                                 for="diversity_check5">
                            Eggs
                          </label>
                        </div>
                        <div class="form-check custom-control custom-checkbox">
                          <input class="form-check-input diversity_check class-myNum custom-control-input"
                                 index_Food_grp="6" type="checkbox"
                                 value="">
                          <label class="form-check-label custom-control-label"
                                 for="diversity_check6">
                            Vitamin A rich fruits and Vegetable
                          </label>
                        </div>
                        <div class="form-check custom-control custom-checkbox">
                          <input class="form-check-input diversity_check class-myNum custom-control-input"
                                 index_Food_grp="7" type="checkbox"
                                 value="">
                          <label class="form-check-label custom-control-label"
                                 for="diversity_check7">
                            Other fruits and vegetables
                          </label>
                        </div>
                      </fieldset>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ここから PFCバランスの評価 ----------------------------->

              <div class="card rounded border-success col-12 px-1 py-1 mt-3" style="color:#24535F ;background-color:#D9ECDC;
               border-width: 2px;">
                <div class="card-header bg-info text-white p-1 mb-2">
                  Macro nutrient balance
                  <span class="fb fb-help" data-toggle="tooltip" data-html="true"
                        title="<div>recommended PFC balance </div><div>Carbohydrates: 45-65%</div>
                                  <div>Protein: 10-35%</div><div>Fat: 20-35%</div>"></span>
                </div>
                <div class="card-body py-0 my-0 px-1">
                  <div class="row">
                    <div class="col-4">
                      Carbohydrate:
                    </div>
                    <div class="col-4 PFC class-myNum" index_Food_grp="1">
                    </div>
                  </div>
                  <div class="row py-0 my-0">
                    <div class="col-4">
                      Protain:
                    </div>
                    <div class="col-4 PFC class-myNum" index_Food_grp="2">
                    </div>
                  </div>
                  <div class="row py-0 my-0">
                    <div class="col-4">
                      Fat:
                    </div>
                    <div class="col-4 PFC class-myNum" index_Food_grp="3">
                    </div>
                  </div>
                </div>
              </div>

              <!-- ここから 入手先の評価 ----------------------------->

              <div class="card rounded border-success col-12 px-1 py-1 mt-3" style="color:#24535F ;background-color:#D9ECDC;
               border-width: 2px;">
                <div class="card-header bg-info text-white p-1 mb-2">
                  Source of Food
                  <span class="fb fb-help" data-toggle="tooltip" data-html="true"
                        title="<div>sourcing food from farm/market?</div>"></span>
                </div>
                <div class="card-body py-0 my-0 px-1">
                  <div class="row py-0 my-0">
                    <div class="col">
                      <label for=" share_Prod_Buy"
                             class="label_Prod_Buy class-myNum">share (
                        <span style="color: #cc1111">buy</span> /
                        <span style="color: #5bc0de">production</span>):
                      </label>
                      <span class="fb fb-help" data-toggle="tooltip"
                            title="Tooltip message"></span>
                    </div>
                  </div>
                  <div class="row py-0 my-0">
                    <div class="col">
                      <select class="share_Prod_Buy class-myNum">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </script>
  <!-- templateここまで ----------------------------->




  <style media="screen">
    /* set common variable */
    :root {
      --td_wid_normal: 30;
    }

    /* force rotate when screen width less than 450 */
    @media screen and (min-width: 320px) and (max-width: 450px) and (orientation: portrait) {
      html {
        transform: rotate(-90deg);
        transform-origin: left top;
        width: 100vh;
        overflow-x: hidden;
        position: absolute;
        top: 100%;
        left: 0;
      }
    }

    .mod-tbl {
      max-width: 650px;
    }

    .mytable {
      table-layout: fixed;
      border: 2px grey solid;
      border-collapse: collapse;
      width: 100%;
    }

    .mytable tbody th {
      width: var(--td_wid_normal) px;
      min-width: var(--td_wid_normal) px;
      border-collapse: collapse;
      border: 2px grey solid;
    }

    .mytable td {
      width: var(--td_wid_normal) px;
      min-width: var(--td_wid_normal) px;
      border: 2px grey solid;
      border-collapse: collapse;
      text-align: center;
      vertical-align: middle;
    }

    .mytable th {
      color: whitesmoke;
      background-color: #49A0B5;
      border: 2px grey solid;
      border-collapse: collapse;
      text-align: center;
      vertical-align: middle;
    }

    .mytable tr:nth-child(odd) td {
      color: darkblue;
      text-align: left;
      background-color: #49A0B5;
    }

    .mytable tr:nth-child(even) td {
      color: white;
      background-color: #F9F9F9;
    }

    /* 行または列の非表示*/
    .tableItem_hide {
      display: none;
    }

    .zerovalue_hide {
      display: none;
    }

    /* 横幅固定、100% */
    .table-fixed-100 {
      table-layout: fixed;
      width: 100%;
    }

    /* 1列目の横幅固定% */
    .table-fixed-100 tr th:nth-child(1) {
      width: 30%;
    }

    /* tablesorterのsortアイコン表示 */
    .tablesorter-headerUnSorted {
      background-image: url("{% static 'img/sort.png' %}");
      background-repeat: no-repeat;
      background-position: center right;
    }

    .tablesorter-headerAsc {
      background-image: url("{% static 'img/sort_up.png' %}");
      background-repeat: no-repeat;
      background-position: center right;
      border-bottom: #000 2px solid;
    }

    .tablesorter-headerDesc {
      background-image: url("{% static 'img/sort_down.png' %}");
      background-repeat: no-repeat;
      background-position: center right;
      border-bottom: #000 2px solid;
    }

    /* Table row/cellの色設定：青色グラデーション */
    .rowcolor_100 {
      background-color: #971066;
      color: white;
    }

    .rowcolor_75 {
      background-color: #E93EAA;
      color: white;
    }

    .rowcolor_50 {
      background-color: #F6B0DC;
      color: white;
    }

    .rowcolor_0 {
      background-color: white;
      color: black;
    }

    .item-selected {
      background: #ccc;
    }

    /* checkboxの選択時の色 */
    .pointer_hand{
        cursor: pointer;
    }

    /* checkboxの選択時の色 */
    .custom-checkbox .custom-control-input:checked ~ .custom-control-label::before {
      background-color: red;
    }
  </style>



  <script type="text/javascript">


    $('[data-toggle="tooltip"]').tooltip();

    // グローバル変数の作成
    //    const myRange = [101, 102, 103, 104, 201, 202, 203, 204,
    //      301, 302, 303, 304];
    var MAX_VAL_PORTION = 10000;
    const target_name = [
      'child 6-23 month',
      'child 24-59 month',
      'child 6-9 yr',
      'adolescent male',
      'adolescent female',
      'adult male',
      'adult female',
      'pregnant',
      'lactating',
      'adult',
      'adolescent pregnant',
      'adolescent lact',
      'adolescent all'
    ];
    var season_count = {{ season_count }};
    var season_list = {{ season_list|safe }};
    var season12 = {{ season|safe }};
    var season_name = {{ season_name|safe }};
    var season_name_by_index = {{ month_season_start_text|safe }};
    var season_start_month = {{ month_season_start|safe }};
    var myFoodGrp = {{ mylist_Food_grp|safe }};
    var myTarget = {{ myTarget|safe }};
    var dri_target_en = {{ dri_list_en|safe }};
    var dri_target_pr = {{ dri_list_pr|safe }};
    var dri_target_va = {{ dri_list_va|safe }};
    var dri_target_fe = {{ dri_list_fe|safe }};
    var dri_target_vol = {{ dri_list_vo|safe }};
    var template_Tab = $('#template_Tab').html();
    var template_Carousel = $('#template_Carousel').html();
    var myRange = [];
    var season_length = {};
    var season_length2 = {};
    let c_index = 1;  // carouselのインデックス

    ////////////////////////////////////////////////////
    // タブ、テーブルのhtml追加
    ////////////////////////////////////////////////////
    $.each(myTarget, function (index1, val1) {
      let cr = '';
      // タブを追加する

      cr += '<a class="flex-sm-fill text-sm-center nav-link" href="#tab_' + val1 + '" role="tab">';
      cr += target_name[Number(val1)];
      cr += '</a>';
      $('#myTabs').append(cr);

      // タブの中に入るコンテンツ(枠)を追加
      cr = '';
      cr += '<div class="tab-pane" id="' + 'tab_' + String(val1) + '" role="tabpanel">';
      cr += '</div>';
      $('#tabContent').append(cr);
      let tmp_tab = $('#tab_' + String(val1)).append(template_Tab);

      //タブ,carouselにtbl_num1を設定
      const tbl_num1 = (Number(val1) + 1) * 100;
      $.each(tmp_tab.find('.btn_car_prev, .btn_car_next, .carousel, .myfilter-item'), function (index4, val4) {
        if (!(val4.hasAttribute('myNum'))) {
          $(val4).attr('myNum', tbl_num1);
        }
      });

      $.each(season_list, function (index2, val2) {
        // 季節毎のカルーセル(template)を追加する
        let tmp_tab2 = tmp_tab.find('.carousel-inner').append(template_Carousel);

        // テーブル番号の取得
        const tbl_num2 = Number(val2) + (Number(val1) + 1) * 100;
        myRange.push(tbl_num2);

        // 追加されたカルーセルに季節情報、テーブル番号を追加
        $.each(tmp_tab2.find('.carousel-item'), function (index3, val3) {
          if (!(val3.hasAttribute('myNum'))) {
            $(val3).attr('myNum', tbl_num2);
            if (index3 == 0) { // 最初の季節をActivate
              $(val3).addClass('active');
            }

            $(val3).find('.class-myNum').attr('myNum', tbl_num2);
            $(val3).find('.season_name').text(season_name[index2]);
            $(val3).find('.season_first_month').text(season_start_month[String(index2 + 1)]);
          }
        });
        //tmp_tab2.find('.class-myNum').forEach()attr('myNum', tbl_num2);
      });
    });
    ////////////////////////////////////////////////////
    // タブ、テーブルのhtml追加ここまで
    ////////////////////////////////////////////////////

    console.error('season_list');
    console.error(season_list);
    console.error('season_start_month');
    console.error(season_start_month);
    console.error('season_name');
    console.error(season_name);
    console.error('myRange');
    console.error(myRange);
    console.error('season12');
    console.error(season12);
    console.error('dri_target_en');
    console.error(dri_target_en);


    //season12：月毎の季節の値から各季節の長さを記録
    $.each(season12, function (key, value) {
      if (season_length[value] !== undefined) {
        season_length[value] += 1;
      } else {
        season_length[value] = 1;
      }
    });
    console.error('season_length');
    console.error(season_length);

    var selected_rows_id = [];
    var myLocation = '';
    var myRoot = '';
    var json_crop_local_org = {{mylist_available|safe}};
    var json_crop_selected_org = {{mylist_selected|safe}};
    var json_crop_name = {{mylist_local_name|safe}};
    var crop_selected_count = {{crop_ind_count }};
    console.error('crop_selected_count');
    console.error(crop_selected_count);
    console.error('json_crop_selected_org');
    console.error(json_crop_selected_org);

    //
    //作物が一個も選択されていなければ先に進めない
    if (crop_selected_count == 0){
      $('#page_next').addClass('disabled');
    }


    let url_tmp = window.location.href.split('/');
    let tmp1 = url_tmp[url_tmp.length - 2];
    url_tmp.pop();
    url_tmp.pop();
    url_tmp.pop();
    myRoot = url_tmp.join("/") + '/';
    var myLocation_id = tmp1;

    let $modal_localCrop = $('#Modal_localCrop1');
    let myTbl_food_Setweight = $('#tbl_food_SetWeight');
    let myfood_volume = {};
    let myfood_portion = {};
    let myfood_share = {};
    myfood_volume['modal'] = $('#Modal_food_volume');
    myfood_volume['save'] = $('#change_weight1');
    myfood_volume['portion'] = $('#btn_change_portion');
    myfood_volume['share'] = $('#BR_buy_prod_pie_img');
    myfood_volume['barrating'] = $('#my_Prod_Buy');
    myfood_share['modal'] = $('#Modal_Prod_Buy');
    myfood_share['save'] = $('#change_share1');
    myfood_portion['modal'] = $('#Modal_Portion');
    myfood_portion['save'] = $('#btn_set_portion');


    //////////////// initialize Food_grp_filter /////
    $('.myfilter-item').append('<a class="dropdown-item item-selected pointer_hand">--show all--</a>');
    $.each(myFoodGrp, function (index, val) {
      $('.myfilter-item').append('<a class="dropdown-item pointer_hand">' + val + '</a>');
    });

    //////////////// change common name -> local name/////
    let index = {};
    let json_crop_local = [];
    let json_crop_selected = [];
    json_crop_name.forEach(token => index[token.food_item_id] = token);
    json_crop_local_org.forEach(token => {
      if (index[token.food_item_id]) {
        token.Food_grp = index[token.food_item_id].Food_grp;
        token.Food_name = index[token.food_item_id].Food_name;
      }
      json_crop_local.push(token);
    });
    json_crop_selected_org.forEach(token => {
      if (index[token.food_item_id]) {
        token.Food_grp = index[token.food_item_id].Food_grp;
        token.Food_name = index[token.food_item_id].Food_name;
      }
      json_crop_selected.push(token);
    });
    console.log('初期選択品目の一覧：');
    console.log(json_crop_selected);
    console.log('初期利用可能品目の一覧：');
    console.log(json_crop_local);
    //---------------------------------------------

    //////////////// star rating/////
    $(function () {
      $('.rating_DRI').barrating({theme: 'bars-1to10', showSelectedRating: false, readonly: true}); // set barrating
      $('#my_Prod_Buy').barrating({theme: 'bars-1to10', showSelectedRating: true, readonly: false}); // set barrating)
      $('.share_Prod_Buy').barrating({theme: 'bars-1to10', showSelectedRating: true, readonly: true}); // set barrating)
      $('#BR_food_count').barrating({theme: 'fontawesome-apple'});
    });


    //    create object setup "Crop_Selected"   -------------------------------
    /**
     * collection of selected crops
     * @param {Number} num_tbl
     * @constructor
     */
    function Crop_Selected(num_tbl) {
      const found = myRange.find(element => element === num_tbl);
      if (found) {
        this.crops = [];
        this.num_tbl = num_tbl;
        this.sum_en = 0;
        this.sum_pr = 0;
        this.sum_va = 0;
        this.sum_fe = 0;
        this.sum_vol = 0;
        this.month = 0;
        this.season = 0;
        this.season_length = 1;
        this.PFC_carbo = 0;
        this.PFC_prot = 0;
        this.PFC_fat = 0;

        let target_scope = Math.trunc(num_tbl / 100);
        this.target_en = dri_target_en[target_scope];
        this.target_pr = dri_target_pr[target_scope];
        this.target_va = dri_target_va[target_scope];
        this.target_fe = dri_target_fe[target_scope];
        this.target_vol = dri_target_vol[target_scope];

        //関連DOM要素の指定 lbl_target_en
        this.dom_lbl_target_en = '';
        this.dom_lbl_target_pr = '';
        this.dom_lbl_target_va = '';
        this.dom_lbl_target_fe = '';
        this.dom_myRating_en = '';
        this.dom_myRating_pr = '';
        this.dom_myRating_va = '';
        this.dom_myRating_fe = '';
        this.dom_btn_add = '';
        this.dom_lst_month = '';
        this.dom_tbl_Crop = '';
        this.dom_PFC = {};
        this.dom_diversity_check = {};
        this.dom_share = '';

        console.log('オブジェクトCrop_Selected' + num_tbl + 'を作成しました');
      } else {
        console.error('オブジェクトCrop_Selected' + num_tbl + 'を作成できません。テーブル番号が不正です');
      }
    }

    /**
     * setdata -> render data
     * @param {lsit of crop} crop_data
     */
    Crop_Selected.prototype.setDataDraw_Crop = function (crop_data) {
      this.setData_Crop(crop_data);
      this._drawRaw_single(crop_data.food_item_id);
    };
    Crop_Selected.prototype.setData_Crop = function (crop_data) {
      console.group('Crop_Selected.setData_Crop:');
      if (crop_data.food_item_id && myRange.includes(crop_data.num_tbl)) {
        console.log('table_id(' + crop_data.num_tbl + ')に' + crop_data.Food_name + 'を追加します');
        let overwrite = this._delCrop(crop_data.food_item_id);       //重複業あれば削除
        this.crops.push(crop_data);
        console.groupEnd();
        return overwrite;
      } else {
        console.error('crop_data did not registered');
        console.groupEnd();
        return false;
      }
    };
    /**
     *
     * @param {id for table} num_tbl
     * @param {} mydata
     * @param drawFlag
     * @returns {boolean}
     */
    Crop_Selected.prototype.setData_fromAvailable = function (num_tbl, mydata, drawFlag) {
      console.group('Crop_Selected.setData_fromAvailable:');
      let res = false;
      if (drawFlag) {       //rowの追加
        //データセットの作成1:buy_prod_share設定
        let tmp_share = 5;
        let tmp_val = Number(mydata['m' + myCrop[num_tbl].month]);
        if (tmp_val == 2) {
          tmp_share = 100;
        } else if (tmp_val == 3) {
          tmp_share = 99;
        }
        console.log('食品の入手先shareを' + tmp_share + 'に設定します');

        //データセットの作成2(crop_available -> crop_selected)
        let dd = {};
        dd["name"] = mydata['Food_name'];
        dd["Energy"] = mydata['Energy'];
        dd["Protein"] = mydata['Protein'];
        dd["VITA_RAE"] = mydata['VITA_RAE'];
        dd["FE"] = mydata['FE'];
        dd["food_item_id"] = mydata['food_item_id'];
        dd["portion_size"] = mydata['portion_size'];
        dd["share_prod_buy"] = tmp_share;
        dd["total_weight"] = 0;
        dd["count_prod"] = 0;
        dd["count_buy"] = 0;
        month_tmp = myCrop[num_tbl].month;
        dd["month"] = month_tmp;
        dd["month_availability"] = mydata['m' + String(month_tmp)];
        dd["myLocation"] = myLocation_id;
        dd["num_tbl"] = num_tbl;
        dd["target_scope"] = Math.trunc(Number(num_tbl) / 100);
        dd["Food_grp"] = mydata['Food_grp'];
        dd["Food_name"] = mydata['Food_name'];
        dd["Carbohydrate"] = mydata['Carbohydrate'];
        dd["Fat"] = mydata['Fat'];
        //-----

        this.setData_Crop(dd);                           //データの追加
        res = true;
      } else {
        res = false;
      }
      console.groupEnd();
      return res;
    };
    Crop_Selected.prototype._delCrop = function (food_item_id) {
      console.group('Crop_Selected._delCrop:');
      let del_index = -1;
      myArray = this.crops;
      myArray.forEach((ele, index) => {
        if (ele.food_item_id === Number(food_item_id)) {
          console.log('food_item_id(' + ele.food_item_id + ')を削除します');
          del_index = 1;
          myArray.splice(index, 1);
        }
      });
      console.groupEnd();
      return del_index;
    };
    Crop_Selected.prototype._delAll = function () {
      this.crops = [];
      this.dom_tbl_Crop.children('tbody').find('tr').remove();
      console.log('削除しました');
      this._drawRaw_total();
    };
    Crop_Selected.prototype.setMonth = function (month) {
      console.group('Crop_Selected.setMonth:');
      if ((month > -1) && (month < 12)) {
        this._delAll();    //作物を全部消去
        this.month = month;
        console.groupEnd();
        return true;
      }
      console.groupEnd();
      return false;
    };

    Crop_Selected.prototype.getCropList = function () {
      console.group('Crop_Selected.getCropList:');
      let found = [];
      this.crops.forEach(function (ele) {
        found.push(ele.food_item_id);
      });
      console.groupEnd();
      return found || 'none';
    };
    Crop_Selected.prototype._getCrop_byID = function (food_item_id) {
      console.group('Crop_Selected._getCrop_byID:');
      console.log('food_item_idl:' + food_item_id);
      const found = this.crops.find(element => element.food_item_id === Number(food_item_id));
      console.groupEnd();
      return found || 'none';
    };
    Crop_Selected.prototype._getCrop_byRow = function (row_id) {
      let myrow = this.dom_tbl_Crop.find('tr').eq(row_id);
      console.log(myrow.children('td').eq(7).text());
      return this._getCrop_byID(myrow.children('td').eq(7).text());
    };
    Crop_Selected.prototype.drawTable = function () {
      console.group('Crop_Selected.drawTable:');
      this.dom_tbl_Crop.children('tbody').find('tr').remove(); //全ての行を削除
      // 追加行の挿入
      for (let mycrop in this.crops) {
        let mycrop_html = this._drawRaw_setHtml(this.crops[mycrop]);
        this.dom_tbl_Crop.find('tbody').append(mycrop_html);
      }
      // tablesorterの初期化
      $('.selected_crops_tbl').trigger("update");
      console.error('tablesorterの初期化');

      // 合計行の再計算の挿入
      this._drawRaw_total();
      console.groupEnd();
    };
    Crop_Selected.prototype._drawRaw_erase = function (food_item_id) {
      console.group('Crop_Selected._drawRaw_erase:');
      let del_flag = -1;
      let delRow = this.dom_tbl_Crop.find('tbody tr').filter(function () {
        if ($(this).children('td').eq(7).text() === String(food_item_id)) {
          console.log(food_item_id + 'を削除します');
          return true;
        }
      });
      delRow.remove();
      console.error(this.dom_tbl_Crop.find('tbody tr'));

      {% comment %}
            this.dom_tbl_Crop.find('tbody tr').each(function (j, myRow) {
              if ($(myRow).children('td').eq(7).text() === String(food_item_id)) { // 指定行が存在した場合
                del_flag = j;
              }
            });

            if (del_flag > -1) {
              this.dom_tbl_Crop.find('tbody tr').eq(del_flag).remove()
            }
            console.groupEnd();
      {% endcomment %}
      return del_flag;
    };
    Crop_Selected.prototype._drawRaw_eraseLast = function () { //今後使わないので廃止
      console.group('Crop_Selected._drawRaw_eraseLast:');
      // 合計行を削除
      let lastrow = this.dom_tbl_Crop.find('tbody tr').last();
      if (lastrow.children('td').eq(0).text() === 'total') {
        lastrow.remove();
      }
      console.groupEnd();
    };
    Crop_Selected.prototype._drawRaw_single = function (food_item_id) {
      console.group('Crop_Selected._drawRaw_single:');

      let total = '';
      let add_data = this._getCrop_byID(food_item_id);
      if (add_data !== 'none') {
        // 最終行を削除
        //this._drawRaw_eraseLast();
        // 重複行があレバ削除
        let rowNum = this._drawRaw_erase(food_item_id);
        // 追加行の作成
        const add_data_html = this._drawRaw_setHtml(add_data);
        // 追加行の挿入
        if (rowNum == 0) {
          this.dom_tbl_Crop.find('tbody').before(add_data_html);
        } else if (rowNum > 0) {
          this.dom_tbl_Crop.find('tbody tr').eq(rowNum - 1).after(add_data_html);
        } else {
          this.dom_tbl_Crop.find('tbody').append(add_data_html);
        }
        // 合計行の作成と挿入
        this._drawRaw_total();

        // tablesorterの初期化
        $('.selected_crops_tbl').trigger("update");
        console.error('tablesorterの初期化');

        console.log('行の追加と合計行の再計算を終えました');
      } else {
        console.error('指定されたfood_item_id(' + food_item_id + ')は存在しません');
      }
      console.groupEnd();
    };
    Crop_Selected.prototype._drawRaw_setHtml = function (add_data) {
      console.group('Crop_Selected._drawRaw_setHtml:');
      //行の色指定
      const rowcolor = {
        '1': 'rowcolor_100',
        '2': 'rowcolor_75',
        '3': 'rowcolor_50',
        '0': 'rowcolor_0',
      };
      let tmp = '';

      // 追加行の作成
      let cr = '';
      cr += '<tr class="' + rowcolor[add_data.month_availability] + '">';
      cr += '<td>' + add_data.name + '</td>';
      cr += '<td>' + Math.round(add_data.Energy * add_data.total_weight / 100, 1) + '</td>';
      cr += '<td>' + Math.round(add_data.Protein * add_data.total_weight / 100, 1) + '</td>';
      cr += '<td>' + Math.round(add_data.VITA_RAE * add_data.total_weight / 100, 1) + '</td>';
      cr += '<td>' + Math.round(add_data.FE * add_data.total_weight / 100, 1) + '</td>';
      cr += '<td>' + add_data.total_weight + '</td>';
      cr += '<td class="tableItem_hide"></td>';
      cr += '<td class="tableItem_hide">' + add_data.food_item_id + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.portion_size + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.count_prod + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.count_buy + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.Energy + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.Protein + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.VITA_RAE + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.FE + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.share_prod_buy + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.Food_grp + '</td>';
      cr += '<td class="tableItem_hide">' + add_data.month_availability + '</td>';
      cr += '</tr>';

      console.groupEnd();
      return cr;
    };
    Crop_Selected.prototype._drawRaw_total = function () {
      console.group('Crop_Selected._drawRaw_total:');
      // 合計行を削除
      //this._drawRaw_eraseLast();
      // 合計行の再計算
      this._Sum_Nutrition();
      // 合計行の挿入
      target_scope = Math.trunc(this.num_tbl / 100);
      total = '<tr class="bg-light"><td>total</td>' +
              this._setCellColor(Math.round(this.sum_en), dri_target_en[target_scope]) +
              this._setCellColor(Math.round(this.sum_pr), dri_target_pr[target_scope]) +
              this._setCellColor(Math.round(this.sum_va), dri_target_va[target_scope]) +
              this._setCellColor(Math.round(this.sum_fe), dri_target_fe[target_scope]) +
              '<td>' + this.sum_vol + '</td><td class="tableItem_hide"><' + '/td><td class="tableItem_hide">' +
              '</td><td class="tableItem_hide"></td><td class="tableItem_hide">' +
              '</td><td class="tableItem_hide"></td><td class="tableItem_hide"></td>' +
              '<td class="tableItem_hide"></td><td class="tableItem_hide"></td>' +
              '<td class="tableItem_hide"></td><td class="tableItem_hide"></td>' +
              '<td class="tableItem_hide"></td><td class="tableItem_hide"></td></tr>';
      this.dom_tbl_Crop.children('tfoot').children('tr').remove();
      this.dom_tbl_Crop.children('tfoot').append(total);
      // Barratingセット
      this._SetBarrating();

      // PFCの挿入
      try {
        this.dom_PFC[1].text(this.PFC_carbo);
        this.dom_PFC[2].text(this.PFC_prot);
        this.dom_PFC[3].text(this.PFC_fat);
      } catch (e) {
        console.log(e);
        console.log('dom_PFCが見つかりません');
      }

      console.log('合計を再計算しました');
      console.groupEnd();
    };
    Crop_Selected.prototype._SetBarrating = function () {
      console.group('Crop_Selected._SetBarrating:');
      let rate_en = Math.round(this.sum_en * 10 / this.target_en);
      if (rate_en > 10) {
        rate_en = 10;
      } else if (rate_en < 1) {
        rate_en = 1;
      }
      let rate_pr = Math.round(this.sum_pr * 10 / this.target_pr);
      if (rate_pr > 10) {
        rate_pr = 10;
      } else if (rate_pr < 1) {
        rate_pr = 1;
      }
      let rate_va = Math.round(this.sum_va * 10 / this.target_va);
      if (rate_va > 10) {
        rate_va = 10;
      } else if (rate_va < 1) {
        rate_va = 1;
      }
      let rate_fe = Math.round(this.sum_fe * 10 / this.target_fe);
      if (rate_fe > 10) {
        rate_fe = 10;
      } else if (rate_fe < 1) {
        rate_fe = 1;
      }
      this.dom_myRating_en.barrating('set', rate_en); // set barrating
      this.dom_myRating_pr.barrating('set', rate_pr); // set barrating
      this.dom_myRating_va.barrating('set', rate_va); // set barrating
      this.dom_myRating_fe.barrating('set', rate_fe); // set barrating
      console.groupEnd();
    };
    Crop_Selected.prototype._setCellColor = function (i_cell, i_target) {
      let res = '';
      cNum = parseInt(i_cell * 100 / i_target, 10);
      switch (true) {
        case 0 <= cNum && cNum < 50:
          res = '<td style="color:red;">' + i_cell + '</td>';
          break;

        case 50 <= cNum && cNum < 100:
          res = '<td style="color:orange;">' + i_cell + '</td>';
          break;

        case 100 <= cNum:
          res = '<td style="color:green;">' + i_cell + '</td>';
          break;

        default:
          res = '<td>' + i_cell + '</td>';
          break;
      }
      return res;
    };
    Crop_Selected.prototype._Sum_Nutrition = function () {
      console.group('Crop_Selected:_Sum_Nutrition');
      let sum_en_tmp = 0;
      let sum_pr_tmp = 0;
      let sum_va_tmp = 0;
      let sum_fe_tmp = 0;
      let sum_vol_tmp = 0;
      let sum_pfc_carbo_tmp = 0;
      let sum_pfc_prot_tmp = 0;
      let sum_pfc_fat_tmp = 0;
      let share_prod = 0;
      let share_buy = 0;
      let weight = 0;
      let _this = this;
      let myGrp = [
        'Grains, roots and tubers ',
        'Legumes and nuts ',
        'Dairy products ',
        'Flesh foods ',
        'Eggs ',
        'Vitamin A rich fruits and Vegetable ',
        'Other fruits and vegetables '
      ];
      try {
        this.dom_diversity_check[1].prop('checked', false);
        this.dom_diversity_check[2].prop('checked', false);
        this.dom_diversity_check[3].prop('checked', false);
        this.dom_diversity_check[4].prop('checked', false);
        this.dom_diversity_check[5].prop('checked', false);
        this.dom_diversity_check[6].prop('checked', false);
        this.dom_diversity_check[7].prop('checked', false);
      } catch (error) {
        console.error(error);
      }

      this.crops.forEach(function (elem) {
        weight = elem.total_weight;
        sum_en_tmp += elem.Energy * weight / 100;
        sum_pr_tmp += elem.Protein * weight / 100;
        sum_va_tmp += elem.VITA_RAE * weight / 100;
        sum_fe_tmp += elem.FE * weight / 100;
        sum_vol_tmp += weight;
        sum_pfc_carbo_tmp += elem.Carbohydrate * weight / 100;
        sum_pfc_prot_tmp += elem.Protein * weight / 100;
        sum_pfc_fat_tmp += elem.Fat * weight / 100;
        share_prod += elem.portion_size * elem.count_prod;
        share_buy += elem.portion_size * elem.count_buy;
        let food_grp_tmp = elem.Food_grp;
        console.log(elem);
        console.log(food_grp_tmp);
        console.log(myGrp.indexOf(food_grp_tmp));
        if (weight > 0) {
          try {
            _this.dom_diversity_check[Number(myGrp.indexOf(food_grp_tmp) + 1)].prop('checked', true);
          } catch (error) {
            console.error(error);
          }

        }
      });
      this.sum_en = sum_en_tmp;
      this.sum_pr = sum_pr_tmp;
      this.sum_va = sum_va_tmp;
      this.sum_fe = sum_fe_tmp;
      this.sum_vol = sum_vol_tmp;
      let sum = sum_pfc_carbo_tmp + sum_pfc_prot_tmp + sum_pfc_fat_tmp;
      let sum_source = share_buy + share_prod;
      console.log('sum_pfc_carbo_tmp=' + sum_pfc_carbo_tmp);
      console.log('sum_pfc_prot_tmp=' + sum_pfc_prot_tmp);
      console.log('sum_pfc_fat_tmp=' + sum_pfc_fat_tmp);
      console.log('sum_vol_tmp=' + sum_vol_tmp);
      this.PFC_carbo = Math.round(sum_pfc_carbo_tmp * 100 / sum) || 0;
      this.PFC_prot = Math.round(sum_pfc_prot_tmp * 100 / sum) || 0;
      this.PFC_fat = Math.round(sum_pfc_fat_tmp * 100 / sum) || 0;
      this.dom_share.barrating('set', Math.round(share_prod * 10 / sum_source) || 1); // set barrating

      console.groupEnd();
    };
    Crop_Selected.prototype._setDiversity = function (index, setCheck) {
      console.group('Crop_Selected:_setDiversity');
      if (index < 8 && index > 0) {
        let myDom = "";
        switch (index) {
          case 1:
            myDom = this.dom_diversity_check1;
            break;
          case 2:
            myDom = this.dom_diversity_check2;
            break;
          case 3:
            myDom = this.dom_diversity_check3;
            break;
          case 4:
            myDom = this.dom_diversity_check4;
            break;
          case 5:
            myDom = this.dom_diversity_check5;
            break;
          case 6:
            myDom = this.dom_diversity_check6;
            break;
          case 7:
            myDom = this.dom_diversity_check7;
            break;
        }
        if (setCheck) {
          myDom.prop('checked', true);

        } else {

        }
      } else {
        console.error('Index out of range')
      }
      this.dom_diversity_check1.removeAttr('checked');
      this.dom_diversity_check2.removeAttr('checked');
      this.dom_diversity_check3.removeAttr('checked');
      this.dom_diversity_check4.removeAttr('checked');
      this.dom_diversity_check5.removeAttr('checked');
      this.dom_diversity_check6.removeAttr('checked');
      this.dom_diversity_check7.removeAttr('checked');

      console.groupEnd();
    };
    Crop_Selected.prototype._getPFC = function (food_item_id) {
      console.group('Crop_Selected:_getPFC');
      const crop = json_crop_local.filter(function (element) {
        return element.food_item_id === Number(food_item_id);
      });

      let carbo = 0;
      let prot = 0;
      let fat = 0;

      try {
        console.log(crop[0].Food_name + 'のPFCバランスをチェックします');
        // console.log(crop[0]);
        carbo = crop[0].Carbohydrate || 0;
        prot = crop[0].Protein || 0;
        fat = crop[0].Fat || 0;
      } catch (e) {
        console.error(e);
        console.error('該当作物が見つかりません');
      }
      console.groupEnd();
      return {carbo: carbo, prot: prot, fat: fat}
    };


    Crop_Selected.prototype.myfilter = function (key) {
      console.log('Crop_Selected.myfilterにFilter(' + key + ')を適用します');

      this.dom_tbl_Crop.find('tbody tr').each(function (index, val) {
        let tmpval = $(val).children('td').eq(16).text();
        if (key === '--show all--' || tmpval === key) {
          $(val).removeClass('tableItem_hide');
        } else {
          $(val).addClass('tableItem_hide');
        }
      });
      console.groupEnd();
    };

    Crop_Selected.prototype.getCrops = function () {
      return this.crops
    };


    /////    create object setup "Crop_Selected"   -------------------------------
    /**
     * object of single crop
     * @param num_tbl
     * @constructor
     */
    function Crop_individual(num_tbl) {
      const found = myRange.find(element => element === num_tbl);
      if (found) {
        this.num_tbl = num_tbl;
        this.data = {};

        //関連DOM要素の指定 lbl_target_en
        this.dom_tbl = myTbl_food_Setweight;
        this.dom_modal = myfood_volume.modal;
        this.dom_btn_save = myfood_volume['save'];
        this.dom_btn_por = myfood_volume['portion'];
        this.dom_br_count = $('#BR_food_count');
        this.dom_img_pie = myfood_volume['share'];

        console.log('オブジェクトCrop_individual(' + num_tbl + ')を作成しました');
      } else {
        console.error('オブジェクトCrop_individual(' + num_tbl + ')を作成できません。テーブル番号が不正です');
      }
    }

    Crop_individual.prototype.setData = function (data) {
      console.group('Crop_individual:init');
      this.data = data;

      this.dom_tbl.children('tbody').children('tr').remove(); //tbl_food_SetWeightのテーブル初期化

      let cr = '<tr><th>name</th><th>En</th><th>Pr</th><th>Va</th><th>Fe</th><th class="tableItem_hide">por</th>'
              + '<th class="tableItem_hide">count_p</th><th class="tableItem_hide">count_b</th></tr>';
      cr += '<tr>';
      cr += '<td>' + data.name + '</td>';
      cr += '<td>' + Math.round(data.Energy * data.total_weight / 100, 1) + '</td>';
      cr += '<td>' + Math.round(data.Protein * data.total_weight / 100, 1) + '</td>';
      cr += '<td>' + Math.round(data.VITA_RAE * data.total_weight / 100, 1) + '</td>';
      cr += '<td>' + Math.round(data.FE * data.total_weight / 100, 1) + '</td>';
      cr += '<td class="tableItem_hide portion_size">' + data.portion_size + '</td>';
      cr += '<td class="tableItem_hide count_prod">' + data.count_prod + '</td>';
      cr += '<td class="tableItem_hide count_buy">' + data.count_buy + '</td>';
      cr += '<td class="tableItem_hide share_prod_buy">' + data.share_prod_buy + '</td>';
      cr += '</tr>';

      console.log('作物(' + data.name + ')を描画します');
      console.log(data);
      this.dom_tbl.append(cr);
      this.dom_btn_por.text(data.portion_size); //ポーションサイズ設定
//      this.dom_br_count.barrating('set', data.count_prod + data.count_buy); //摂取量の設定
      let count_all = Number(data.count_prod + data.count_buy) || 1;
      this.dom_br_count.barrating('set', count_all); //摂取量の設定
      this.setPie_img(data.share_prod_buy); //Buy＿Prod _shaeの設定

      if (data.num_tbl < 10000) { // individual/familyとcommunityで表示を切り替える #todo 後できちんと修正
        $('#toggle_visible_individual').show();
        $('#toggle_visible_comm').hide();
      } else {
        $('#toggle_visible_individual').hide();
        $('#toggle_visible_comm').show();
      }

      console.groupEnd();
    };
    Crop_individual.prototype.setData_portion = function (data) {
      console.group('Crop_individual:receive_portion');
      let por = data.portion_size;
      if (por) {
        this.data.portion_size = por;
        this.dom_btn_por.text(por);
        this.dom_tbl.find('tr').eq(1).children('td').eq(5).text(por);
        console.log('portion_sizeを' + por + 'に変更しました');
      } else {
        console.error('portion_sizeを変更できません');
      }
      console.groupEnd();
    };

    Crop_individual.prototype.setDataShare = function (data) {
      this.data.share_prod_buy = data.share_prod_buy;
      this.data.count_buy = data.count_buy;
      this.data.count_prod = data.count_prod;
      this.setPie_img(data.share_prod_buy);
    };

    Crop_individual.prototype.setPie_img = function (i_share) {
      if (i_share === 99) {
        i_share = 0;
      } else if (i_share === 100) {
        i_share = 10;
      }
      i_share = 10 - i_share;
      let h = "/static/img/pie_" + String(i_share) + ".png";
      console.log('prod/buy shareを' + i_share + 'に設定します');
      this.dom_img_pie.attr('src', h);
    };
    Crop_individual.prototype.getData_FoodWt = function () {
      console.group('Crop_individual:getData_FoodWt');
      let current_sum = Number(this.dom_modal.attr('sum_vol'));
      let current_vol = Number(this.data.total_weight);
      let max_vol = Number(dri_target_vol[this.data.target_scope]);
      let portion_size = this.data.portion_size;

      if (this.num_tbl < 10000) { // individual/familyとcommunityで計算方法を切り替える #todo 後できちんと修正
        let count_all = Number(this.dom_br_count.children("option:selected").val());
        let new_weight = portion_size * count_all;

        if (current_sum + new_weight - current_vol > max_vol) {
          alert('total volume offood exceeded daily consumption limit.\n' +
                  'please re-adjust volume of each food item so that total volume fit within ' + max_vol + 'g');
          return false;
        }

        let share_prod_buy_tmp = Number(this.data.share_prod_buy);
        if (share_prod_buy_tmp === 100) {
          share_prod_buy_tmp = 10;
        }
        if (share_prod_buy_tmp === 99) {
          share_prod_buy_tmp = 0;
        }
        let count_prod = Math.trunc(count_all * share_prod_buy_tmp / 10);
        let count_buy = count_all - count_prod;
        this.data.count_prod = count_prod;
        this.data.count_buy = count_buy;
        this.data.total_weight = new_weight;

      } else {                        // individual/familyとcommunityで計算方法を切り替える
        let new_weight = Number($('#food_weight_community').val()) * 1000;  //g --> kg への変換
        if (current_sum + new_weight - current_vol > max_vol) {
          alert('total volume offood exceeded daily consumption limit.\n' +
                  'please re-adjust volume of each food item so that total volume fit within ' +
                  String(max_vol / 1000) + 'kg');
          return false;
        }
        let share_prod_buy_tmp = 10;
        this.data.total_weight = new_weight;
        this.data.count_prod = Math.trunc(new_weight / portion_size);
        this.data.count_buy = 0;
      }
      console.log(this.data.name + 'を更新します');
      console.log(this.data);
      console.groupEnd();
      return this.data;
    };

    //---------
    function Crop_Portion() {
      this.crop = {};
      this.dom_modal = myfood_portion['modal'];
      this.dom_old_portion = $('#old_portion');
      this.dom_new_portion = $('#new_portion');
      this.dom_btn_set_portion = myfood_portion['save'];
    }

    Crop_Portion.prototype.setData = function (data) {
      console.group('Crop_Portion.setData');
      myfood_volume['modal'].modal('hide');//(Modalの入れ替え)
      this.crop = data;
      let por = this.crop.portion_size;
      this.dom_old_portion.val(por);
      this.dom_new_portion.val('');
      console.groupEnd();
      this.dom_modal.modal('show');
    };
    Crop_Portion.prototype.getData = function () {
      console.group('Crop_Portion.getData');
      let por = this.dom_new_portion.val();
      this.crop.portion_size = por;
      this.dom_modal.modal('hide');
      console.log('Portionサイズを' + por + 'gに変更します');
      console.groupEnd();
      return this.crop;
    };
    /// ---- change portion size (Modalの入れ替え)--------
    myfood_portion['modal'].on('hide.bs.modal', function () {
      myfood_volume['modal'].modal('show');
    });///-------------------------------

    //---------
    function Crop_Share() {
      this.crop = {};
      this.dom_modal = myfood_volume['modal'];
      this.dom_BR_share = myfood_volume['barrating'];
    }

    Crop_Share.prototype.setData = function (crop_data) {
      console.group('Crop_Share.SetData');
      this.crop = crop_data;
      myShare = Number(crop_data.share_prod_buy);
      let res = '';
      if (myShare > 10) {
        let mes = crop_data.name +
                ' is only available from ' + (myShare == 100 ? 'production' : 'the market') + ' for this month';
        alert(mes);
        res = false;
      } else {
        console.log('share_prod_buyを' + myShare + 'に設定します');
        this.dom_BR_share.barrating('set', myShare);// set barrating
        res = true;
      }
      console.groupEnd();
      return res;
    };
    Crop_Share.prototype.getData = function () {
      console.group('Crop_Share.getData');
      let myShare = Number(this.dom_BR_share.children("option:selected").val());
      this.crop.share_prod_buy = myShare;
      let cou = this.crop.count_prod + this.crop.count_buy;
      this.crop.count_prod = Math.trunc(myShare * cou / 10);
      this.crop.count_buy = cou - this.crop.count_prod;
      console.groupEnd();
      return this.crop;
    };

    myfood_share['modal'].on('hide.bs.modal', function () {
      myfood_volume['modal'].modal('show');
    });///

    //---------

    ////////// Filter Crop_Selected table ////////////
    $(".myfilter-item a").click(function () {
      let x = $(this).text();
      let tblNum = Number($('#current_page').text());
      let tmp_mon = Number(tblNum % 100);
      tblNum = 100 * Math.trunc(tblNum / 100) + (tblNum % 4);
      console.log('tblNum:' + tblNum);
      console.log('season:' + season_name[tmp_mon]);
      myCrop[String(tblNum)].myfilter(x);
    });

    ////////// replicator ////////////
    $(".replicator").on('click', function () {
      const tbl_num = Number($('#current_page').text());
      const tmp_target = target_name[Math.trunc(tbl_num / 100) - 1];
      const tmp_nut0 = dri_target_en[Math.trunc(tbl_num / 100)];
      const tmp_season_id = (tbl_num % 100) - 1;
      const tmpCrop = myCrop[tbl_num];
      let ret = confirm("You are about to copy crop values for " + "\n" + "[" +
              season_name[Number(tmp_season_id)] + "]-[" + tmp_target + "] to other target beneficiaries." +
              "\n" + " Are you sure?");
      if (ret) {
        let crops = tmpCrop.getCrops();
        $.each(myRange, function (i, val) {
          if ((val % 100) == tmp_season_id + 1) {
            let tmp_nut1 = myCrop[val].target_en;
            let tmp_factor = Math.round((tmp_nut1 / tmp_nut0) * 1000) / 1000;
            $.each(crops, function (j, crop) {
              let crop2 = jQuery.extend({}, crop);
              crop2.total_weight = Math.round(crop2.total_weight * tmp_factor);
              crop2.portion_size = Math.round(crop2.portion_size * tmp_factor);
              myCrop[val].setDataDraw_Crop(crop2);
            });
          }
        });
        alert('copy completed!');
      }
    });
    ////////// hide/unhide ////////////
    $(".hide_zero").change(function () {
      const tbl_num = $(this).attr('myNum');
      if ($(this).prop('checked')) {
        console.log(tbl_num);
        const tmp_tbl = $('.selected_crops_tbl[myNum = "' + tbl_num + '"]');
        console.log($(tmp_tbl).find('tr:nth-child(5) td:nth-child(6)').text());

        let myRows = $('.selected_crops_tbl[myNum = "' + tbl_num + '"] tbody tr');
        $(myRows).each(function (index, val) {
          let tmpval = $(val).children('td').eq(5).text();
          if (tmpval === '0') {
            $(val).toggleClass('zerovalue_hide');
          }
        });
      } else {
        $('.selected_crops_tbl[myNum = "' + tbl_num + '"] tr').removeClass('zerovalue_hide');
      }
    });

    ////////// start crop selection (local -> selected)
    $('.btn_add_crop').on('click', function () {
      let tmp_num = $(this).attr('myNum');
      let tmp_month = myCrop[tmp_num].month;
      let tmp_crop_selected = myCrop[tmp_num].getCropList();
      Crop_available.data().receive_Selection(tmp_month, tmp_num, tmp_crop_selected);
      $('#Modal_localCrop1').modal('show');
    }); ///////////////////////////////////////////////

    //////////////////set food volume////#
    $(".selected_crops_tbl tbody").on("click", "td", function () {
      console.group('selected_crops_tbl:click');
      let myNum_tmp = $(this).parents('.selected_crops_tbl').attr('myNum');//テーブル番号の取得
      let myrow = $(this).closest('tr')[0].rowIndex;
//      if (myrow < $(this).parents().children('tbody tr').length) {
      myCrop[myNum_tmp]._Sum_Nutrition();
      let dat = myCrop[myNum_tmp]._getCrop_byRow(myrow);
      myCrop_individual[myNum_tmp].setData(dat);
      myfood_volume['modal'].attr('myNum', myNum_tmp); //table番号の記録
      myfood_volume['modal'].attr('sum_vol', myCrop[myNum_tmp].sum_vol); //摂取量上限の記録
      myfood_volume['modal'].modal('show');
//      }
      console.groupEnd();
    });

    ////////////////// button click to reflect the modification　#
    myfood_volume['save'].click(function () {
      console.group('change_weight1:click');
      let myNum_tmp = myfood_volume.modal.attr('myNum');//テーブル番号の取得
      console.log('table(' + myNum_tmp + ')を変更します');
      let data = myCrop_individual[myNum_tmp].getData_FoodWt();
      if (data == false) {
        return false;
      }
      console.log(data);
      myCrop[myNum_tmp].setDataDraw_Crop(data);

      myfood_volume['modal'].modal('hide');
      console.groupEnd();
    });

    ////////////////// change month
    $('.lst_month').change(function () {
      console.group('#lst_month.click');
      if (confirm('Are you sure to change month to ' + $(this).val() + '?')) {
        myCrop[$(this).attr('myNum')].setMonth($(this).prop('selectedIndex'));
      } else {
        $(this).prop('selectedIndex', $(this).attr('previousIndex'));
      }
      console.groupEnd();
    });
    $(".lst_month").click(function () {
      $(this).attr('previousIndex', $(this).prop('selectedIndex'));
    });

    /// ---- set portion size --------
    myfood_volume['portion'].on('click', function () {
      console.group('#btn_change_portion.click');
      let myNum_tmp = myfood_volume.modal.attr('myNum');//テーブル番号の取得
      console.log(myNum_tmp);
      let crop = myCrop_individual[myNum_tmp].data;
      myCrop_portion.setData(crop);
      console.groupEnd();
    });

    /// ---- set portion size --------
    myfood_portion['save'].on('click', function () {
      console.group('#btn_set_portion.click');
      let myNum_tmp = myfood_volume.modal.attr('myNum');//テーブル番号の取得
      console.log(myNum_tmp);
      let crop = myCrop_portion.getData();
      myCrop_individual[myNum_tmp].setData_portion(crop);   //Crop_individualのdata更新
      myCrop[myNum_tmp].setData_Crop(crop);                 //Crop_selectedのdata更新
      console.groupEnd();
    });

    //---------set balance prodoce/purchase -----------
    myfood_volume['share'].on('click', function () {
      console.group('#BR_buy_prod_pie_img.click');
      let myNum_tmp = myfood_volume.modal.attr('myNum');//テーブル番号の取得
      console.log(myNum_tmp);
      let crop = myCrop_individual[myNum_tmp].data;
      let res = myCrop_share.setData(crop);
      if (res) {
        myfood_volume['modal'].modal('hide');//(Modalの入れ替え)
        myfood_share['modal'].modal('show');
      }
      console.groupEnd();
    });

    //// set balance produce/purchase ---------------------------
    myfood_share['save'].on('click', function () {
      console.group('#change_share1.click');
      let myNum_tmp = myfood_volume['modal'].attr('myNum');//テーブル番号の取得
      let crop = myCrop_share.getData();
      console.log('count_p=' + crop.count_prod + ', count_b= ' + crop.count_buy + ', myShare=' + crop.share_prod_buy);
      myCrop_individual[myNum_tmp].setDataShare(crop);
      myCrop[myNum_tmp].setDataDraw_Crop(crop);          //Crop_selectedのdata更新
      myfood_volume['modal'].attr('myNum', myNum_tmp); //table番号の記録
      myfood_volume['modal'].modal('show');
      myfood_share['modal'].modal('hide');
      console.groupEnd();
    });


    //////////////////btn_save_crop
    $('#btn_save_crop').click(function () {
      console.group('#btn_save_crop.click');
      let hostUrl = myRoot + 'registDiet/';
      let mydat = getTblData();
      console.log('データを保存する準備ができました');
      Set_CRSF();
      sendJson(mydat, hostUrl);
      console.groupEnd();
    }); ////////btn_save_crop///////////

    //////////////////getTblData
    function getTblData() {
      console.group('getTblData');
      let d = [];
      $('.selected_crops_tbl').each(function (i, myTbl) {
        $(myTbl).children('tbody').children('tr').each(function (j, myRow) {
          let dd = {};
          if ($(myRow).children('td').eq(0).text() !== '' && $(myRow).children('td').eq(0).text() !== 'total'
                  && $(myRow).children('td').eq(5).text() !== '0') {
            //   dd["myName"] = $(myRow).children('td').eq(0).text();
            dd["total_weight"] = $(myRow).children('td').eq(5).text();
            dd["food_item_id"] = $(myRow).children('td').eq(7).text();
            dd["portion_size"] = $(myRow).children('td').eq(8).text();
            dd["count_prod"] = $(myRow).children('td').eq(9).text();
            dd["count_buy"] = $(myRow).children('td').eq(10).text();
            dd["share_prod_buy"] = $(myRow).children('td').eq(15).text();

            let myNum_tmp = $(myTbl).attr('myNum');
            let myMonth = 0;
            myMonth = Number($('.lst_month[myNum=' + myNum_tmp + ']').text());
            dd["month"] = myMonth;
            dd["myid_tbl"] = myNum_tmp;
            dd["myLocation"] = myLocation_id;
            dd["target_scope"] = Math.trunc(myNum_tmp / 100);

            d.push(dd);
            //------------同一季節内の他の月に複製------------
            const current_season = season12['m' + String(myMonth) + '_season'];

            for (let j = 1; j < 13; j++) {
              if (String(season12['m' + String(j) + '_season']) === String(current_season) && j !== myMonth) {
                let dd2 = {};
                Object.assign(dd2, dd);
                dd2["month"] = j;
                dd2["myid_tbl"] = -1;
                d.push(dd2);
              }
            }
          }
        })
      });
      console.log('selected_crops_tblのデータを送信します');
      console.log(d);
      console.groupEnd();
      return {"myJson": d};
    }


    //////////////////getTblData //// csrf_tokenの取得に使う//////////////
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = jQuery.trim(cookies[i]);
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function csrfSafeMethod(method) {
      // these HTTP methods do not require CSRF protection
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    function Set_CRSF() {
      var csrf_token = getCookie("csrftoken");
      $.ajaxSetup({
        crossDomain: false, // obviates need for sameOrigin test
        beforeSend: function (xhr, settings) {
          if (!csrfSafeMethod(settings.type)) {
            xhr.setRequestHeader("X-CSRFToken", csrf_token);
          }
        }
      });
    }

    //////////////////sendJson////
    function sendJson(myjson, hostUrl) {
      $.ajax({
        type: 'post',
        url: hostUrl,
        data: JSON.stringify(myjson),
        contentType: 'application/JSON',
        dataType: 'JSON',
        scriptCharset: 'utf-8',
        success: function (response) {
          location.reload();
        },
        error: function (jqXHR, textStatus, errorThrown) {
          alert("Application encountered unknown error in target population setting");
          console.log(jqXHR.responseText);
          console.log(jqXHR.status); //例：404
          console.log(textStatus); //例：error
          console.log(errorThrown); //例：NOT FOUND
          console.log(JSON.stringify(myjson)); //例：NOT FOUND
          console.log(myjson); //例：NOT FOUND
        }
      });
    }

    //---------------------------------------------
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////

    let myCrop = {};
    for (let i in myRange) {
      myCrop[myRange[i]] = new Crop_Selected(myRange[i]);
    }

    let myCrop_individual = {};
    for (let i in myRange) {
      myCrop_individual[myRange[i]] = new Crop_individual(myRange[i]);
    }

    let myCrop_portion = new Crop_Portion();
    let myCrop_share = new Crop_Share();

    //  myRating_**を配列に組み込む -----------
    $('.rating_DRI').each(function (i) {
      let tmp_myNum = $(this).attr('myNum');
      i = (i) % 4;
      switch (i) {
        case 0:
          myCrop[tmp_myNum].dom_myRating_en = $(this);
          break;
        case 1:
          myCrop[tmp_myNum].dom_myRating_pr = $(this);
          break;
        case 2:
          myCrop[tmp_myNum].dom_myRating_va = $(this);
          break;
        case 3:
          myCrop[tmp_myNum].dom_myRating_fe = $(this);
          break;
      }
    });

    //  selected_crops_tbl_**を配列に組み込む -----------
    $('.selected_crops_tbl').each(function () {
      let num_tbl = $(this).attr('myNum');
      myCrop[num_tbl].dom_tbl_Crop = $(this);
    });

    //  btn_add_crop_**を配列に組み込む -----------
    $('.btn_add_crop').each(function () {
      let num_tbl = $(this).attr('myNum');
      myCrop[num_tbl].dom_btn_add = $(this);
    });

    //  lst_monthを配列に組み込む -----------
    $('.lst_month').each(function () {
      let num_tbl = $(this).attr('myNum');
      myCrop[num_tbl].dom_lst_month = $(this);
    });

    //  shareを配列に組み込む -----------
    $('.share_Prod_Buy').each(function () {
      let num_tbl = $(this).attr('myNum');
      myCrop[num_tbl].dom_share = $(this);
    });

    //  PFCを配列に組み込む -----------
    $('.PFC').each(function () {
      console.log('PFCを配列に組み込む');
      let num_tbl = $(this).attr('myNum');
      let id_category = $(this).attr('index_Food_grp');
      console.log('PFCを配列に組み込む' + num_tbl);
      myCrop[num_tbl].dom_PFC[id_category] = $(this);
    });

    //  Diversityを配列に組み込む -----------
    $('.diversity_check').each(function () {
      console.log('Diversityを配列に組み込む');
      let num_tbl = $(this).attr('myNum');
      let id_category = $(this).attr('index_Food_grp');
      console.log('Diversityを配列に組み込む' + num_tbl);
      myCrop[num_tbl].dom_diversity_check[id_category] = $(this);
    });

    //  テーブルごとのmonthを配列に組み込む -----------
    for (let i in myRange) {
      let num_tbl = myRange[i];
      let tmp_dat = myCrop[num_tbl];

      myCrop[num_tbl].month = Number(myCrop[num_tbl].dom_lst_month.text());
      myCrop[num_tbl].season = season12['m' + myCrop[num_tbl].month + '_season'];
      myCrop[num_tbl].season_length = season_length[myCrop[num_tbl].season];
      myCrop[num_tbl].dom_btn_add.attr('myNum', num_tbl);
    }

    //  lbl_target_**を配列に組み込む -----------
    $('.lbl_target_en').each(function () {
      let num_tbl = $(this).attr('myNum');
      let scope = Math.trunc(num_tbl / 100);
      myCrop[num_tbl].dom_lbl_target_en = $(this);
      $(this).text(dri_target_en[scope].toFixed(0));
    });

    $('.lbl_target_pr').each(function () {
      let num_tbl = $(this).attr('myNum');
      let scope = Math.trunc(num_tbl / 100);
      myCrop[num_tbl].dom_lbl_target_pr = $(this);
      $(this).text(dri_target_pr[scope].toFixed(0));
    });

    $('.lbl_target_va').each(function () {
      let num_tbl = $(this).attr('myNum');
      let scope = Math.trunc(num_tbl / 100);
      myCrop[num_tbl].dom_lbl_target_va = $(this);
      $(this).text(dri_target_va[scope].toFixed(0));
    });

    $('.lbl_target_fe').each(function () {
      let num_tbl = $(this).attr('myNum');
      let scope = Math.trunc(num_tbl / 100);
      myCrop[num_tbl].dom_lbl_target_fe = $(this);
      $(this).text(dri_target_fe[scope].toFixed(0));
    });
    //-------------

    //初期データの読み込み
    let num_tbl = 0;
    let month = 0;
    for (let i in myRange) {
      num_tbl = myRange[i];
      month = myCrop[num_tbl].month;
      json_crop_local.forEach(data => {
        if (data['m' + month] > 0) {
          myCrop[num_tbl].setData_fromAvailable(num_tbl, data, true);
        }
      });
      //  myCrop[num_tbl].myfilter(myFoodGrp[1]);
    }

    for (var i = 0; i < json_crop_selected.length; i++) {
      data = json_crop_selected[i];
      if (data.myLocation === Number(myLocation_id)) {
        //let num_tbl = data.num_tbl;
        myCrop[data.num_tbl].setData_Crop(data);
      }
    }


//    Crop_available.data().hello("test desu");

    //---tabの切替処理-------------
    let activeTab = $('#myTabs a').filter('.active');

    $('#myTabs a').click(function (e) {
      e.preventDefault();

      activeTab.removeClass('active');
      $(activeTab.attr('href')).removeClass('active');

      activeTab = $(this);

      activeTab.addClass("active");
      $(activeTab.attr('href')).addClass('active');

      let num_tab = Number($(this).attr('href').replace('#tab_', ''));
      $('#current_tab').text(num_tab + 1);

      //tab切り替え時に一度（next）をクリックする
      $('.btn_car_next[myNum = ' + ((num_tab + 1) * 100) + ']').click();
    });
    //---tabの切替処理-------------

    //---carouselの切替処理-------------
    $('.btn_car_prev').click(function () {
      let num_table1 = Number($(this).attr('myNum'));
      let tmp_car = $('.carousel[myNum=' + num_table1 + ']');
      let tmp_car_active = tmp_car.find('.carousel-item').siblings('.active');

      $(tmp_car).carousel('prev');

      let num_table2 = Number($(tmp_car_active).attr('myNum')) - 1;
      if ((num_table2 % 100) == 0) {
        num_table2 = Math.trunc(num_table2 / 100) * 100 + season_list[season_list.length - 1];
      }
      $('#current_page').text(num_table2);
    });
    $('.btn_car_next').click(function () {
      let num_table1 = Number($(this).attr('myNum'));
      let tmp_car = $('.carousel[myNum=' + num_table1 + ']');
      let tmp_car_active = tmp_car.find('.carousel-item').siblings('.active');

      $(tmp_car).carousel('next');

      let num_table2 = Number($(tmp_car_active).attr('myNum')) + 1;
      if ((num_table2 % 100) > season_list[season_list.length - 1]) {
        num_table2 = Math.trunc(num_table2 / 100) * 100 + 1;
      }
      $('#current_page').text(num_table2);
    });

    $(window).on("load", function () {
      // Handler when all assets (including images) are loaded
      //全ての変数を読み込んでからBarratingをセット
      for (let i in myRange) {
        myCrop[myRange[i]].drawTable();
      }

      //tablesorterの初期化
      $('.selected_crops_tbl').tablesorter();

      //最初のタブをactivate？
      $('#myTabs').find('.nav-link a:first').tab('show');
    });

  </script>


{% endblock %}
