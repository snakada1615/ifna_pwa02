{% extends 'myApp/_base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
  <script type="text/javascript" src="{% static 'DataTables/js/jquery.dataTables.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'DataTables/js/dataTables.select.min.js' %}"></script>
  <link rel="stylesheet" type="text/css" href="{% static 'DataTables/css/jquery.dataTables.min.css' %}" media="screen">
  <link rel="stylesheet" type="text/css" href="{% static 'DataTables/css/select.dataTables.min.css' %}" media="screen">

  <script type="text/javascript" src="{% static 'js/jquery.barrating.min.js' %}"></script>
  <link rel="stylesheet" href="{% static 'css/font-awesome.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/fontawesome-apple.css' %}">
  <link rel="stylesheet" href="{% static 'css/bars-1to10.css' %}">

  <input type="hidden" value="" id="selected_row">

  <div class="container" style="max-width: 540px;">
    <div class="row">
      <div class="col-2 my-0 px-3">
        <img src="{% static 'img/no4.png' %}">
      </div>
      <div class="col-10 my-0 px-1">
        <h5>
          Diet planning for
          {{myLocation}}
        </h5>
      </div>
    </div>
  </div>

  <div class="container" style="max-width: 540px;">
    <div id="accordion">
      <div class="card  border-dark bg-light col-12 mt-2 py-0" style="max-width: 540px;">
        <div class="row">
          <div class="col-12">
            <div class="card-body py-0 px-0">
              <p class="card-text text-success my-0">
                myLocation:
                {{ myLocation }}
              </p>
              <p class="card-text my-0">
                country:
                {{ myLocation.myCountry.NAME_0 }}
              </p>
              <p class="card-text my-0">
                region:
                {{ myLocation.myCountry.NAME_1 }}
              </p>
              <p class="card-text my-0">
                province:
                {{ myLocation.myCountry.NAME_2 }}
              </p>
              <p class="card-text my-0">
                nutrition target:
                {{ myLocation.nutrition_target }}
              </p>
              <button class="btn btn-link" data-toggle="collapse" data-target="#more_info" aria-expanded="true" aria-controls="more_info">
                more info
              </button>

              <div id="more_info" class="collapse" aria-labelledby="heading{{crop.food_item_id}}" data-parent="#accordion">
                <p class="card-text my-0">
                  stunting rate:
                  {{ myLocation.stunting_rate }}
                </p>
                <p class="card-text my-0">
                  wasting rate:
                  {{ myLocation.wasting_rate }}
                </p>
                <p class="card-text my-0">
                  anemia rate:
                  {{ myLocation.anemia_rate }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="container_tab_all" class="container border-secondary py-1 my-1 px-0" style="max-width: 540px; background-color:#F3F3F3;border-width: 2px;">
    <!-- 4個分のタブ -->
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a href="#tab1_link" class="nav-link active" id="tab1" data-toggle="tab">individual</a>
      </li>
      <li class="nav-item">
        <a href="#tab2_link" class="nav-link" id="tab2" data-toggle="tab">family</a>
      </li>
      <li class="nav-item">
        <a href="#tab3_link" class="nav-link" id="tab3" data-toggle="tab">community</a>
      </li>
    </ul>

    <!-- タブの移動先指定 -->
    <div class="tab-content">
      <div id="tab1_link" class="tab-pane active">
        {% include "./Diet_Sub1.html" %}
      </div>
      <div id="tab2_link" class="tab-pane">
        {% include "./Diet_Sub2.html" %}
      </div>
      <div id="tab3_link" class="tab-pane">
        {% include "./Diet_Sub3.html" %}
      </div>
    </div>
  </div>

  <!------------------------------------------------------------->
  <style media="screen">
    /* nav-item activeの文字色 */
    .nav-pills .show > .nav-link,
    .nav-tabs .nav-link.active {
      color: red;
      background-color: #87BFCD;
    }
    /* 行または列の非表示*/
    .tableItem_hide {
      display: none;
    }
  </style>

  <!------------------------------------------------------------->
  <script>
    // グローバル変数の作成
    var selected_rows_id = []
    var myLocation = '';
    var myRoot = '';
    var json_crop_local = {{mylist_available|safe}};
    var json_crop_selected = {{mylist_selected|safe}};
    var target_en1 = {{dri_e1}};
    var target_pr1 = {{dri_p1}};
    var target_va1 = {{dri_v1}};
    var target_fe1 = {{dri_f1}};
    var target_en2 = {{dri_e2}};
    var target_pr2 = {{dri_p2}};
    var target_va2 = {{dri_v2}};
    var target_fe2 = {{dri_f2}};
    var target_en3 = {{dri_e3}};
    var target_pr3 = {{dri_p3}};
    var target_va3 = {{dri_v3}};
    var target_fe3 = {{dri_f3}};

    let url_tmp = window.location.href.split('/');
    let tmp1 = url_tmp[url_tmp.length - 2];
    url_tmp.pop();
    url_tmp.pop();
    url_tmp.pop();
    myRoot = url_tmp.join("/") + '/';
    myLocation_id = tmp1;
    //////////////// star rating/////
    $(function () {
      $('.rating_DRI').barrating({theme: 'bars-1to10', showSelectedRating: false, readonly: true}); // set barrating
      $('#mystar1').barrating({theme: 'fontawesome-apple'});
    });

    ////////////////////////////////
    $('.lbl_target_en[myNum^=1]').text(target_en1);
    $('.lbl_target_pr[myNum^=1]').text(target_pr1);
    $('.lbl_target_va[myNum^=1]').text(target_va1);
    $('.lbl_target_fe[myNum^=1]').text(target_fe1);
    $('.lbl_target_en[myNum^=2]').text(target_en2);
    $('.lbl_target_pr[myNum^=2]').text(target_pr2);
    $('.lbl_target_va[myNum^=2]').text(target_va2);
    $('.lbl_target_fe[myNum^=2]').text(target_fe2);
    $('.lbl_target_en[myNum^=3]').text(target_en3);
    $('.lbl_target_pr[myNum^=3]').text(target_pr3);
    $('.lbl_target_va[myNum^=3]').text(target_va3);
    $('.lbl_target_fe[myNum^=3]').text(target_fe3);
    /////////////////////////////
    var tblObj_localCrop1 = $('#localCrop1').DataTable({
      "data": json_crop_local,
      "pageLength": 50,
      "columns": [
        {
          "data": "selected_status"
        }, {
          "data": "Food_name"
        }, {
          "data": "Energy"
        }, {
          "data": "Protein"
        }, {
          "data": "VITA_RAE"
        }, {
          "data": "FE"
        }, {
          "data": "Food_grp"
        }, {
          "data": "Weight"
        }, {
          "data": "portion_size"
        }, {
          "data": "m1"
        }, {
          "data": "m2"
        }, {
          "data": "m3"
        }, {
          "data": "m4"
        }, {
          "data": "m5"
        }, {
          "data": "m6"
        }, {
          "data": "m7"
        }, {
          "data": "m8"
        }, {
          "data": "m9"
        }, {
          "data": "m10"
        }, {
          "data": "m11"
        }, {
          "data": "m12"
        }
      ],

      "columnDefs": [
        {
          targets: [
            1, 2, 3, 4, 5
          ],
          visible: true
        }, {
          targets: '_all',
          bVisible: false
        }, {
          "orderSequence": ["desc"],
          "targets": [2]
        }, {
          "orderSequence": ["desc"],
          "targets": [3]
        }, {
          "orderSequence": ["desc"],
          "targets": [4]
        }, {
          "orderSequence": ["desc"],
          "targets": [5]
        }
      ],
      "initComplete": function (settings, json) {
        // ////////add filtering dropdown list
        this.api().columns([6]).every(function () {
          var column = this;
          var select = $('<select style="border: 1px grey double;"><option value=""></option></select>').appendTo($('#myFilter1')).on('change', function () {
            var val = $.fn.dataTable.util.escapeRegex($(this).val());

            column.search(
              val
                ? '^' + val + '$'
                : '',
              true,
              false
            ).draw();
          });
          column.data().unique().sort().each(function (d, j) {
            select.append('<option value="' + d + '">' + d + '</option>');
          });
        })
        //////////////////////////////////// ////////////set cell color////////////////
        function SetCellColor(i_cell, i_target) {
          cNum = parseInt(i_cell * 100 / i_target, 10);
          switch (true) {
            case 0 <= cNum && cNum < 50:
              res = '<td style="color:red;">' + i_cell + '</td>';
              break;

            case 50 <= cNum && cNum < 100:
              res = '<td style="color:orange;">' + i_cell + '</td>';
              break;

            case 100 <= cNum:
              res = '<td style="color:green;">' + i_cell + '</td>';
              break;

            default:
              res = '<td>' + i_cell + '</td>';
              break;
          }
          return res;
        }

        ///////////////////////////////////////////// ////////////////////////////////////////////
        $('#lst_month1').change(function () {
          let search_col = 0;
          let tmp_mon = $(this).val();
          if (tmp_mon == 'jan') {
            search_col = 10;
          } else if (tmp_mon == 'feb') {
            search_col = 11;
          } else if (tmp_mon == 'mar') {
            search_col = 12;
          } else if (tmp_mon == 'apr') {
            search_col = 13;
          } else if (tmp_mon == 'may') {
            search_col = 14;
          } else if (tmp_mon == 'jun') {
            search_col = 15;
          } else if (tmp_mon == 'jul') {
            search_col = 16;
          } else if (tmp_mon == 'aug') {
            search_col = 17;
          } else if (tmp_mon == 'sep') {
            search_col = 18;
          } else if (tmp_mon == 'oct') {
            search_col = 19;
          } else if (tmp_mon == 'nov') {
            search_col = 20;
          } else if (tmp_mon == 'dec') {
            search_col = 21;
          }
          tblObj_localCrop1.column(search_col).search('').columns().search('').draw();
          tblObj_localCrop1.column(search_col).search('[123]', true, false).draw();
        });
        ////////////////////////////////////////////// ////////DrawSelected //////////////////////////////
        function DrawSelected() { /// render selected_crops_tbl
          let myNum_tmp = $('#container_tab_all').attr('myNum');
          $('.selected_crops_tbl[myNum=' + myNum_tmp + '] tr').remove(); //remove all rows
          selected_rows_id.length = 0;
          let sum_en = 0;
          let sum_pr = 0;
          let sum_va = 0;
          let sum_fe = 0;
          cr = '<tr><th>name</th><th>En</th><th>Pr</th><th>Va</th><th>Fe</th><th>Wt</th><th class="tableItem_hide">id</th></tr><tr>';
          tblObj_localCrop1.rows('.selected').every(function (rowIdx, tableLoop, rowLoop) {
            var data = this.data();
            cr += '<td>' + data.Food_name + '</td>';
            cr += '<td>' + Math.round(data.Energy * data.Weight / 100, 1) + '</td>';
            cr += '<td>' + Math.round(data.Protein * data.Weight / 100, 1) + '</td>';
            cr += '<td>' + Math.round(data.VITA_RAE * data.Weight / 100, 1) + '</td>';
            cr += '<td>' + Math.round(data.FE * data.Weight / 100, 1) + '</td>';
            cr += '<td>' + data.Weight + '</td>';
            cr += '<td class="tableItem_hide">' + rowIdx + '</td>';
            cr += '</tr>';
            sum_en += data.Energy * data.Weight / 100;
            sum_pr += data.Protein * data.Weight / 100;
            sum_va += data.VITA_RAE * data.Weight / 100;
            sum_fe += data.FE * data.Weight / 100;
            selected_rows_id.push(rowIdx);
          });
          cr += '<tr><td>total</td>' + SetCellColor(Math.round(sum_en), target_en1) + SetCellColor(Math.round(sum_pr), target_pr1) + SetCellColor(Math.round(sum_va), target_va1) + SetCellColor(Math.round(sum_fe), target_fe1) + '<td></td><td class="tableItem_hide"><' +
              '/td></tr>';
          $('.selected_crops_tbl[myNum=' + myNum_tmp + ']').append(cr);

          /////////////// set barrating /
          let rate_en = Math.round(sum_en * 10 / target_en1);
          if (rate_en > 10) {
            rate_en = 10
          } else if (rate_en < 1) {
            rate_en = 1
          };
          let rate_pr = Math.round(sum_pr * 10 / target_pr1);
          if (rate_pr > 10) {
            rate_pr = 10
          } else if (rate_pr < 1) {
            rate_pr = 1
          };
          let rate_va = Math.round(sum_va * 10 / target_va1);
          if (rate_va > 10) {
            rate_va = 10
          } else if (rate_va < 1) {
            rate_va = 1
          };
          let rate_fe = Math.round(sum_fe * 10 / target_fe1);
          if (rate_fe > 10) {
            rate_fe = 10
          } else if (rate_fe < 1) {
            rate_fe = 1
          };

          $('.rating_en[myNum=' + myNum_tmp + ']').barrating('set', rate_en); // set barrating
          $('.rating_pr[myNum=' + myNum_tmp + ']').barrating('set', rate_pr); // set barrating
          $('.rating_va[myNum=' + myNum_tmp + ']').barrating('set', rate_va); // set barrating
          $('.rating_fe[myNum=' + myNum_tmp + ']').barrating('set', rate_fe); // set barrating

          return;
        };
        ////////////////////////////////////////////// //////////////init second table as modal dialog add selected rows to text box
        $('#localCrop1 tbody').on('click', 'tr', function () {
          $(this).toggleClass('selected');
          DrawSelected();
        }); //////////////////////////////////////////////
        ////////////////////////////////////////////// //////////////init second table as modal dialog add selected rows to text box
        $('.btn_add_crop').on('click', function () {
          let selected_list = [];
          let myNum_tmp = $(this).attr('myNum');
          $('#container_tab_all').attr('myNum', myNum_tmp);
          $('#Modal_localCrop1').attr('myNum', myNum_tmp);

          // de-select all crop //
          $('#localCrop1 tr').removeClass('selected');

          //filter crop by month//
          for ( var i = 10;  i < 22;  i++  ) {
            tblObj_localCrop1.column(i).search('').columns().search('').draw();
          }
          let myMonth=$('.lst_month[myNum=' + myNum_tmp + ']').prop("selectedIndex")
          tblObj_localCrop1.column(myMonth + 10).search('[123]', true, false).draw();

          /// get currently selected row//
          $('.selected_crops_tbl[myNum=' + myNum_tmp + '] tr').each(function (myRow) {
            $(this).children().each(function (myIndex, myElement) {
              if (myIndex==0 && myRow!=0){
                if ($(myElement).text()!='' && $(myElement).text()!='total') {
                  selected_list.push($(myElement).text());
                }
              }
            });
          });

          /// give selected status to the currently selected item//
          $('#localCrop1 tr').each(function(myRow){
            $(this).children().each(function (myIndex, myElement) {
              if (myIndex==0 && myRow!=0){
                tmp = $(myElement).text()
                if (selected_list.indexOf(tmp)>=0) {
                  $(this).parent().addClass('selected');
                }
              }
            });
          })

          $('#Modal_localCrop1').modal('show');
        }); //////////////////////////////////////////////
        //////////////////add table edit function////
        $(".selected_crops_tbl").on("click", "td", function () {
          $('#selected_row').val($(this).closest('tr').index());
          $('#foodInfo1 tr').remove();
          let myrowid = $(this).closest('tr').children('td').eq(6).text();
          let por = tblObj_localCrop1.row(myrowid).data().portion_size;
          let cou = Number(tblObj_localCrop1.row(myrowid).data().Weight / por, 10);
          let foodVal = $("td", $(this).parent());
          $('#foodInfo1').attr('myrowid', myrowid);

          myNum_tmp = $(this).parents('.selected_crops_tbl').attr('myNum');
          $('#foodInfo1').attr('myNum', myrowid);
          $('#container_tab_all').attr('myNum', myNum_tmp);

          let cr = '<tr><th>name</th><th>En</th><th>Pr</th><th>Va</th><th>Fe</th></tr><tr>';
          cr += '<td>' + foodVal.eq(0).text() + '</td>';
          cr += '<td>' + foodVal.eq(1).text() + '</td>';
          cr += '<td>' + foodVal.eq(2).text() + '</td>';
          cr += '<td>' + foodVal.eq(3).text() + '</td>';
          cr += '<td>' + foodVal.eq(4).text() + '</td>';
          $('#foodInfo1').append(cr);
          $('#mystar1-label1').text("consumption target(one portion=" + por + 'g)');
          $('#mystar1').barrating('set', cou);

        //  DrawSelected();

          $('#Modal_foodVol1').modal('show');
        });

        ////////////////// button click to reflect the modification
        $('#change_weight1').click(function () {
          let myrowid = $('#foodInfo1').attr('myrowid');
          let por = tblObj_localCrop1.row(myrowid).data().portion_size;
          let cou = $('#mystar1').children("option:selected").val();
          let tmp_v = por * cou
          myNum_tmp = $('#container_tab_all').attr('myNum');
          $('.selected_crops_tbl[myNum=' + myNum_tmp + '] tr').eq($('#selected_row').val()).children('td').eq(5).text(tmp_v);
          tblObj_localCrop1.row(myrowid).data().Weight = tmp_v;

          ///////////////////
          DrawSelected();
          //////////////////
          $('#Modal_foodVol1').modal('hide');
        }); //----------change_weight complete here-------
      } //----initComplete finish here---////////////////////////////////////////////

    });
  </script>

{% endblock %}
