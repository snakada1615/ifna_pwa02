{% extends 'myApp/_base.html' %}
{% load static %}
{% load humanize %}

{% block content %}

  <script type="text/javascript" src="{% static 'js/jquery.barrating.min.js' %}"></script>
  <link rel="stylesheet" href="{% static 'css/fontawesome-apple.css' %}">
  <link rel="stylesheet" href="{% static 'css/bars-1to10.css' %}">

  <div class="container" style="max-width: 780px;">
    <div id="accordion">
      <div class="card  border-dark bg-light col-12 mt-2 py-0" style="max-width: 540px;">
        <div class="row">
          <div class="col-12">
            <div class="card-body py-0 px-0">
              <p class="card-text text-success my-0">
                myLocation:
                {{ myLocation }}
              </p>
              <p class="card-text my-0">
                country:
                {{ myLocation.myCountry.NAME_0 }}
              </p>
              <p class="card-text my-0">
                region:
                {{ myLocation.myCountry.NAME_1 }}
              </p>
              <p class="card-text my-0">
                province:
                {{ myLocation.myCountry.NAME_2 }}
              </p>
              <p class="card-text my-0">
                nutrition target:
                {{ myLocation.nutrition_target }}
              </p>
              <button class="btn btn-link" data-toggle="collapse" data-target="#more_info" aria-expanded="true"
                      aria-controls="more_info">
                more info
              </button>

              <div id="more_info" class="collapse" aria-labelledby="heading{{ crop.food_item_id }}"
                   data-parent="#accordion">
                <p class="card-text my-0">
                  stunting rate:
                  {{ myLocation.stunting_rate }}
                </p>
                <p class="card-text my-0">
                  wasting rate:
                  {{ myLocation.wasting_rate }}
                </p>
                <p class="card-text my-0">
                  anemia rate:
                  {{ myLocation.anemia_rate }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>



  <div class="container-fluid" style="max-width: 780px;">
    <div class="row">
      <div class="col-12 my-0 px-3">
        <div class="card border-success border-5 rounded col-12 mt-2 py-1"
             style="max-width: 540px; color:#24535F ;background-color:#D9ECDC;">
          <table id="tbl_cropping" class="table table-striped table-sm table-responsive">
            <tr>
              <th class="px-0 mx-0">name</th>
              <th class="px-0 mx-0">Jan</th>
              <th class="px-0 mx-0">Feb</th>
              <th class="px-0 mx-0">Mar</th>
              <th class="px-0 mx-0">Apr</th>
              <th class="px-0 mx-0">May</th>
              <th class="px-0 mx-0">Jun</th>
              <th class="px-0 mx-0">Jul</th>
              <th class="px-0 mx-0">Aug</th>
              <th class="px-0 mx-0">Sep</th>
              <th class="px-0 mx-0">Oct</th>
              <th class="px-0 mx-0">Nov</th>
              <th class="px-0 mx-0">Dec</th>
            </tr>
            <tr>
              <td>aaaaaaaaaaaaaaaaaaaaaaaaa</td>
              <td>Jan</td>
              <td>Feb</td>
              <td>Mar</td>
              <td>Apr</td>
              <td>May</td>
              <td>Jun</td>
              <td>Jul</td>
              <td>Aug</td>
              <td>Sep</td>
              <td>Oct</td>
              <td>Nov</td>
              <td>Dec</td>
            </tr>
          </table>
        </div>
      </div>
    </div>

  </div>
  <!------------------------------------------------------------->
  <style media="screen">

    /* 行または列の非表示*/
    .tableItem_hide {
      display: none;
    }
  </style>

  <script>
    // グローバル変数の作成
    var selected_rows_id = [];
    var myLocation = '';
    var myRoot = '';
    var json_crop_selected = {{mylist_selected|safe}};
    var target_en = [];
    var target_pr = [];
    var target_va = [];
    var target_fe = [];

    target_en[1] = {{dri_e1}};
    target_pr[1] = {{dri_p1}};
    target_va[1] = {{dri_v1}};
    target_fe[1] = {{dri_f1}};
    target_en[2] = {{dri_e2}};
    target_pr[2] = {{dri_p2}};
    target_va[2] = {{dri_v2}};
    target_fe[2] = {{dri_f2}};
    target_en[3] = {{dri_e3}};
    target_pr[3] = {{dri_p3}};
    target_va[3] = {{dri_v3}};
    target_fe[3] = {{dri_f3}};

    let url_tmp = window.location.href.split('/');
    let tmp1 = url_tmp[url_tmp.length - 2];
    url_tmp.pop();
    url_tmp.pop();
    url_tmp.pop();
    myRoot = url_tmp.join("/") + '/';
    var myLocation_id = tmp1;
    //////////////// star rating/////
    $(function () {
      $('.rating_DRI').barrating({theme: 'bars-1to10', showSelectedRating: false, readonly: true}); // set barrating
    });
    ////////////////////////////////
    $('.lbl_target_en[myNum^=4]').text(target_en[1].toFixed(0));
    $('.lbl_target_pr[myNum^=4]').text(target_pr[1].toFixed(0));
    $('.lbl_target_va[myNum^=4]').text(target_va[1].toFixed(0));
    $('.lbl_target_fe[myNum^=4]').text(target_fe[1].toFixed(0));
    $('.lbl_target_en[myNum^=5]').text(target_en[2].toFixed(0));
    $('.lbl_target_pr[myNum^=5]').text(target_pr[2].toFixed(0));
    $('.lbl_target_va[myNum^=5]').text(target_va[2].toFixed(0));
    $('.lbl_target_fe[myNum^=5]').text(target_fe[2].toFixed(0));
    $('.lbl_target_en[myNum^=3]').text(target_en[3].toFixed(0));
    $('.lbl_target_pr[myNum^=3]').text(target_pr[3].toFixed(0));
    $('.lbl_target_va[myNum^=3]').text(target_va[3].toFixed(0));
    $('.lbl_target_fe[myNum^=3]').text(target_fe[3].toFixed(0));
    /////////////////////////////
    //////////////////////////////////// ////////set cell color////////////////
    function SetCellColor(i_cell, i_target) {
      let res = '';
      cNum = parseInt(i_cell * 100 / i_target, 10);
      switch (true) {
        case 0 <= cNum && cNum < 50:
          res = '<td style="color:red;">' + i_cell + '</td>';
          break;

        case 50 <= cNum && cNum < 100:
          res = '<td style="color:orange;">' + i_cell + '</td>';
          break;

        case 100 <= cNum:
          res = '<td style="color:green;">' + i_cell + '</td>';
          break;

        default:
          res = '<td>' + i_cell + '</td>';
          break;
      }
      return res;
    }

    ///////////////////////////////////////////// //////////////////////////////////////// ////////////////////////////////////////// ////DrawSelected //////////////////////////
    /////////////// set barrating /
    function SetBarrating(id_table) {
      $myTable = $('.selected_crops_tbl[myNum=' + id_table + ']');
      let sum_en = 0;
      let sum_pr = 0;
      let sum_va = 0;
      let sum_fe = 0;
      let cr = '';

      //ここからBarratingの記入
      $myTable.children('tbody').children('tr').each(function (j, myRow) {
        sum_en += Number($(myRow).children('td').eq(1).text());
        sum_pr += Number($(myRow).children('td').eq(2).text());
        sum_va += Number($(myRow).children('td').eq(3).text());
        sum_fe += Number($(myRow).children('td').eq(4).text());
      });
      target_scope = Math.trunc((id_table - 300) / 100);

      cr += '<tr><td>total</td>' + SetCellColor(Math.round(sum_en), target_en[target_scope]) +
              SetCellColor(Math.round(sum_pr), target_pr[target_scope]) +
              SetCellColor(Math.round(sum_va), target_va[target_scope]) +
              SetCellColor(Math.round(sum_fe), target_fe[target_scope]) + '<td></td><td class="tableItem_hide"><' +
              '/td><td class="tableItem_hide"></td><td class="tableItem_hide"></td><td class="tableItem_hide">' +
              '</td><td class="tableItem_hide"></td></tr>';
      $myTable.append(cr);

      let rate_en = Math.round(sum_en * 10 / target_en[target_scope]);
      if (rate_en > 10) {
        rate_en = 10
      } else if (rate_en < 1) {
        rate_en = 1
      }
      let rate_pr = Math.round(sum_pr * 10 / target_pr[target_scope]);
      if (rate_pr > 10) {
        rate_pr = 10
      } else if (rate_pr < 1) {
        rate_pr = 1
      }
      let rate_va = Math.round(sum_va * 10 / target_va[target_scope]);
      if (rate_va > 10) {
        rate_va = 10
      } else if (rate_va < 1) {
        rate_va = 1
      }
      let rate_fe = Math.round(sum_fe * 10 / target_fe[target_scope]);
      if (rate_fe > 10) {
        rate_fe = 10
      } else if (rate_fe < 1) {
        rate_fe = 1
      }

      $('.rating_en[myNum=' + id_table + ']').val(rate_en); // set barrating
      $('.rating_pr[myNum=' + id_table + ']').val(rate_pr); // set barrating
      $('.rating_va[myNum=' + id_table + ']').val(rate_va); // set barrating
      $('.rating_fe[myNum=' + id_table + ']').val(rate_fe); // set barrating
    }

    ///////////////////////////////////////////// //////////////////////////////////////// ////////////////////////////////////////// ////DrawSelected //////////////////////////
    function DrawSelected_addRow(id_table, add_data) { /// render selected_crops_tbl
      let sum_en = 0;
      let sum_pr = 0;
      let sum_va = 0;
      let sum_fe = 0;
      let cr = '';
      $myTbl = $('.selected_crops_tbl[myNum=' + id_table + ']');
      $myTbl.children('tbody').children('tr').last().remove();
      //  $("tr:eq(" + ($("tr").length - 2) + ")").remove();
      $myTbl.append(add_data);

      SetBarrating(id_table);
    }

    ///////////////////////////////////////////// //////////////////////////////////////// ////////////////////////////////////////// ////DrawSelected //////////////////////////
    // initialize all table (selected_table)
    $('#tbl_cropping').children('tr').remove();
    let dd = {};
    for (var i = 0; i < json_crop_selected.length; i++) {
      data = json_crop_selected[i];
      if (dd[data.name]) {
        dd[data.name][data.month-1] = data.total_weight;
      } else {
        let d = {};
        d[String(data.month-1)] = data.total_weight;
        dd[data.name] = d;
      }
    }
    console.log(dd);
    for (var tmp in dd) {
      console.log(tmp);
    //  console.log(Object.keys(tmp));
      console.log(dd[tmp]);
      console.log(dd[tmp][0]);

    }


  </script>

{% endblock %}
