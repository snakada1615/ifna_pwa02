<div class="container px-0 mx-0">
  <div class="card border-success border-5 rounded mt-2 py-1 px-0 mx-0"
       style="max-width: 540px; color:#24535F ;background-color:#D9ECDC;">
    <div class="card border-success rounded px-1 mx-1 mt-1 mb-2"
         style="color:#24535F ;background-color:#D9ECDC;border-width: 2px;">
      aaa
    </div>
    <div class="col">
      <form>
        <table id="tbl_pop3" class="table table-sm table-info table-striped table-bordered">
          <thead>
          <tr class="bg-info text-white">
            <th style="width:40%">
              <div class="text-center">Class</div>
            </th>
            <th style="width:20%">
              <div class="text-center">Pop</div>
            </th>
            <th style="width:20%">
              <div class="text-center">Preg</div>
            </th>
            <th style="width:20%">
              <div class="text-center">BF</div>
            </th>
          </tr>
          </thead>
          <tr>
            <td>
              <div class="text-center">age 0-23mon</div>
            </td>
            <td>
              <div class="text-center">
                <input id="inpNum0" type="number" disabled class="form-control-sm input-manual" style="width:90%"
                       placeholder="pop size" value="30">
              </div>
            </td>
            <td>
              <div class="text-center"></div>
            </td>
            <td>
              <div class="text-center"></div>
            </td>
          </tr>
          <tr>
            <td>
              <div class="text-center">age 24-59mon</div>
            </td>
            <td>
              <div class="text-center">
                <input id="inpNum1" type="number" disabled class="form-control-sm input-manual" style="width:90%"
                       placeholder="portion size" value="30">
              </div>
            </td>
            <td>
              <div class="text-center"></div>
            </td>
            <td>
              <div class="text-center"></div>
            </td>
          </tr>
          <tr>
            <td>
              <div class="text-center">age 6-9 yrs</div>
            </td>
            <td>
              <div class="text-center">
                <input id="inpNum2" type="number" disabled class="form-control-sm input-manual" style="width:90%"
                       placeholder="portion size" value="30">
              </div>
            </td>
            <td>
              <div class="text-center"></div>
            </td>
            <td>
              <div class="text-center"></div>
            </td>
          </tr>
          <tr>
            <td>
              <div class="text-center">age 10-17 yrs</div>
            </td>
            <td>
              <div class="text-center">
                <input id="inpNum3" type="number" disabled class="form-control-sm input-manual" style="width:90%"
                       placeholder="portion size" value="30">
              </div>
            </td>
            <td>
              <div class="text-center">
                <input id="inpNum3_p" type="number" disabled class="form-control-sm input-manual" style="width:90%"
                       placeholder="portion size" value="30">
              </div>
            </td>
            <td>
              <div class="text-center">
                <input id="inpNum3_l" type="number" disabled class="form-control-sm input-manual" style="width:90%"
                       placeholder="portion size" value="30">
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <div class="text-center">age 18+</div>
            </td>
            <td>
              <div class="text-center">
                <input id="inpNum4" type="number" disabled class="form-control-sm input-manual" style="width:90%"
                       placeholder="portion size" value="30">
              </div>
            </td>
            <td>
              <div class="text-center">
                <input id="inpNum4_p" type="number" disabled class="form-control-sm input-manual" style="width:90%"
                       placeholder="portion size" value="30">
              </div>
            </td>
            <td>
              <div class="text-center">
                <input id="inpNum4_l" type="number" disabled class="form-control-sm input-manual" style="width:90%"
                       placeholder="portion size" value="30">
              </div>
            </td>
          </tr>
          <tr style="color:#ff0080">
            <td>
              <div class="text-center">total pop</div>
            </td>
            <td>
              <div class="text-center">
                <input id="inpNum5" type="number" class="form-control-sm input-auto" style="width:90%"
                       placeholder="portion size" value="30">
              </div>
            </td>
            <td colspan="2">
              <div class="text-center">
                <input type="checkbox" id="chk-autoCalk" checked>
                <label for="auto-calk" class="ml-1"> auto calculate</label>
              </div>
            </td>
          </tr>
        </table>
      </form>
      <span>
        <a class="btn mb-2 btn-info btn-sm align-middle "
           href="#">clear</a>
      </span>
      <span>
        <a id="btn_update3" class="btn mb-2 btn-info btn-sm align-middle "
           href="#">update</a>
      </span>
    </div>
  </div>
</div>

<script type="text/javascript">
  var myPop = {{ myPop|safe }};
  console.log(myPop);

  $('#chk-autoCalk').change(function () {
    if ($('#chk-autoCalk').prop('checked')) {
      $('.input-manual').prop('disabled', true);
      $('.input-auto').prop('disabled', false);
    } else {
      $('.input-manual').prop('disabled', false);
      $('.input-auto').prop('disabled', true);
    }
  });

  $("#inpNum5").on("input", function () {
    // Print entered value in a div box
    $("#inpNum0").val(Math.round($(this).val() * myPop.class0 / 100));
    $("#inpNum1").val(Math.round($(this).val() * myPop.class1 / 100));
    $("#inpNum2").val(Math.round($(this).val() * myPop.class2 / 100));
    $("#inpNum3").val(Math.round($(this).val() * (myPop.class3 + myPop.class4) / 100));
    $("#inpNum3_p").val(Math.round($(this).val() * myPop.class3_p / 100));
    $("#inpNum3_l").val(Math.round($(this).val() * myPop.class3_l / 100));
    $("#inpNum4").val(Math.round($(this).val() * ((myPop.class5 + myPop.class6)) / 100));
    $("#inpNum4_p").val(Math.round($(this).val() * myPop.class5_p / 100));
    $("#inpNum4_l").val(Math.round($(this).val() * myPop.class5_l / 100));
  });

  //////////////////btn_save_crop
  $('#btn_update3').click(function () {
    // let hostUrl = myRoot + 'registTarget_macro/';
    let mydat = getTblData();

    //console.log(mydat);
    //  Set_CRSF();
    //  sendJson(mydat, hostUrl);
    console.log(mydat);
  }); ////////btn_save_crop///////////

  //////////////////getTblData
  function getTblData() { //
    let d = [];
    $('#tbl_pop3 tr').each(function (i, myRow) {
      if (i > 0 && i < 6) {
        if (i == 4 || i == 5) {
          for (var j = 0; j < 3; j++) {
            let dd = {};
            dd['target_scope'] = 3;
            dd["myLocation"] = {{myLocation.id}};
            dd['myuser'] = {{ myuser }};
            if (i == 4) {
              dd['nut_group_id'] = i + j;
            } else {
              dd['nut_group_id'] = i + j + 2;
            }
            dd['target_pop'] = $(myRow).children('td').eq(j + 1).find('.input-manual').val();
            d.push(dd);
          }
        } else {
          let dd = {};
          dd['target_scope'] = 3;
          dd["myLocation"] = {{myLocation.id}};
          dd['myuser'] = {{ myuser }};
          dd['nut_group_id'] = i;
          dd['target_pop'] = $(myRow).children('td').eq(1).find('.input-manual').val();
          d.push(dd);
        }
      }
    });
    return {"myJson": d};
  }

  //////////////////getTblData //// csrf_tokenの取得に使う//////////////
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = jQuery.trim(cookies[i]);
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  //------------------------------------
  function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
  }

  //------------------------------------
  function Set_CRSF() {
    var csrf_token = getCookie("csrftoken");
    $.ajaxSetup({
      crossDomain: false, // obviates need for sameOrigin test
      beforeSend: function (xhr, settings) {
        if (!csrfSafeMethod(settings.type)) {
          xhr.setRequestHeader("X-CSRFToken", csrf_token);
        }
      }
    });
  }

  //////////////////sendJson////
  function sendJson(myjson, hostUrl) {
    $.ajax({
      type: 'post',
      url: hostUrl,
      data: JSON.stringify(myjson),
      contentType: 'application/JSON',
      dataType: 'JSON',
      scriptCharset: 'utf-8',
      success: function (response) {
        window.location.href = response.url;
      },
      error: function (jqXHR, textStatus, errorThrown) {
        alert("fail");
        console.log(jqXHR.responseText);
        console.log(jqXHR.status); //例：404
        console.log(textStatus); //例：error
        console.log(errorThrown); //例：NOT FOUND
        console.log(JSON.stringify(myjson)); //例：NOT FOUND
        console.log(myjson); //例：NOT FOUND
      }
    });
  }//////////////////sendJson//// scfript end///////////////////

</script>
