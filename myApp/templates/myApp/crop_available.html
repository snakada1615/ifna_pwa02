{% extends 'myApp/_base.html' %}
{% load static %}
{% block content %}

  <script type="text/javascript" src="{% static 'DataTables/js/jquery.dataTables.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'DataTables/js/dataTables.select.min.js' %}"></script>
  <link rel="stylesheet" type="text/css" href="{% static 'DataTables/css/jquery.dataTables.min.css' %}"
        media="screen">
  <link rel="stylesheet" type="text/css" href="{% static 'DataTables/css/select.dataTables.min.css' %}"
        media="screen">

  <div class="container  mt-0 mb-1 text-dark" style="max-width: 540px;">

    <div class="card border-primary bg-info col-12 mt-2 py-0 px-0 mx-0" style="max-width: 560px;">
      <p class="card-title text-warning my-0 pl-2">
        availability
        <span style="color:red">■</span>: market&prod
        <span style="color:green">■</span>: prod only
        <span style="color:blue">■</span>: market only
      </p>

      <div class="mod-tbl">
        <table id="tbl_crop_selected" class="mytable">
          <thead>
          <tr>
            <th class="tableItem_hide">selected_status</th>
            <th class="tableItem_hide">Food_grp</th>
            <th class="tableItem_hide">Food_name</th>
            <th>Jan</th>
            <th>Feb</th>
            <th>Mar</th>
            <th>Apr</th>
            <th>May</th>
            <th>Jun</th>
            <th>Jul</th>
            <th>Aug</th>
            <th>Sep</th>
            <th>Oct</th>
            <th>Nov</th>
            <th>Dec</th>
            <th class="tableItem_hide">food_item_id</th>
          </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <span>
          <a id="btn_save" class="btn btn-outline-secondary text-dark mt-2 my-0 py-0 btn-sm">save</a>
          <a class="btn btn-outline-secondary text-dark mt-2 my-0 py-0 btn-sm" href="{% url  'index02' %}">back</a>
          <a id="btn_add" class="btn btn-outline-secondary text-dark mt-2 my-0 py-0 btn-sm">add</a>
        </span>
      </div>
    </div>

  </div>

  <!-- モーダルの設定 ----------------------------->
  <div class="modal fade" id="myModal01" tabindex="-1" role="dialog" aria-labelledby="myModal01Label">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-dark" id="myModal01Label">Edit the weight of food item</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-dark">
          <div class="my-2" id="newSearchPlace">Food group:
          </div>
          <table id="tbl_crop_candidate" class="display compact" cellspacing="0" width="100%">
            <thead>
            <tr>
              <th>Group</th>
              <th>Group</th>
              <th>Name</th>
            </tr>
            </thead>

            <tfoot>
            <tr>
              <th>Group</th>
              <th>Group</th>
              <th>Name</th>
            </tr>
            </tfoot>
          </table>
          <a id="btn_exit01" class="btn btn-outline-secondary text-dark mt-2 my-0 py-0 btn-sm">close</a>
        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>
  <!-- /.modal -->
  <!-------------------------------------->


  <!------------------------------------------------------------->
  <style media="screen">
    /* set common variable */
    :root {
      --td_wid_normal: 30;
    }

    /* force rotate when screen width less than 450 */
    @media screen and (min-width: 320px) and (max-width: 450px) and (orientation: portrait) {
      html {
        transform: rotate(-90deg);
        transform-origin: left top;
        width: 100vh;
        overflow-x: hidden;
        position: absolute;
        top: 100%;
        left: 0;
      }
    }

    .mod-tbl {
      max-width: 650px;
    }

    .mytable {
      table-layout: fixed;
      border: 2px grey solid;
      border-collapse: collapse;
      width: 100%;
    }

    .mytable tbody th {
      width: var(--td_wid_normal) px;
      min-width: var(--td_wid_normal) px;
      border-collapse: collapse;
      border: 2px grey solid;
    }

    .mytable td {
      width: var(--td_wid_normal) px;
      min-width: var(--td_wid_normal) px;
      border: 2px grey solid;
      border-collapse: collapse;
      text-align: center;
      vertical-align: middle;
    }

    .mytable th {
      color: whitesmoke;
      background-color: #49A0B5;
      border: 2px grey solid;
      border-collapse: collapse;
      text-align: center;
      vertical-align: middle;
    }

    .mytable tr:nth-child(odd) td {
      color: darkblue;
      text-align: left;
      background-color: #49A0B5;
    }

    .mytable tr:nth-child(even) td {
      color: white;
      background-color: #F9F9F9;
    }

    /* 行または列の非表示*/
    .tableItem_hide {
      display: none;
    }


  </style>

  <script type="text/javascript">


    // URLパラメータの取得
    var myLocation = '';
    var myRoot = '';
    var items = [];
    var myTmp;

    // グローバル変数の作成
    var selected_rows_id = [];
    var json_crop_name = {{mylist_local_name|safe}};
    var Json_Crop_All = {{dat_mycrop | safe}};

    //////////////// set local name/////
    let index = {};
    json_crop_name.forEach(token => index[token.food_item_id] = token);
    Json_Crop_All.forEach(token => {
      if (index[token.food_item_id]) {
        token.Food_grp = index[token.food_item_id].Food_grp;
        token.Food_name = index[token.food_item_id].Food_name;
      }
    });
    console.log(Json_Crop_All);
    var $myTbl =  $('#tbl_crop_selected');

    //現在選択されている作物一覧
    var Json_Crop_Selected = Json_Crop_All.filter(function (item, index) {
              if (item.selected_status == '1')
                return true;
            }
    );

    //------------------------
    getHTML_param = function () {
      var url_tmp = window.location.href.split('/');
      var tmp1 = url_tmp[url_tmp.length - 3];
      var tmp2 = url_tmp[url_tmp.length - 2];
      url_tmp.pop();
      url_tmp.pop();
      url_tmp.pop();
      url_tmp.pop();
      myRoot = url_tmp.join("/") + '/';
      myLocation = tmp1;
      items.length = 0;
      if (tmp2 == '0') {
        items.push('0');
      } else if (tmp2.indexOf('-') < 0) {
        items.push(tmp2);
      } else {
        items = tmp2.split('-');
      }
      return tmp1;
    };

    //---------------------------------------
    function Cell_MultiSelect(myNum, start_x, start_y, color) {
      this.selected_status = 0;
      this.start_x = start_x || -1;
      this.start_y = start_y || -1;
      this.goal_x = -1;
      this.goal_y = -1;
      this.color = color || 1;
    }

    Cell_MultiSelect.prototype.setStart = function (x, y) {
      this.start_x = x;
      this.start_y = y;
      this.goal_x = 0;
      this.goal_y = 0;
      this.selected_status = 1;
    };
    Cell_MultiSelect.prototype.setGoal = function (x, y) {
      if (this.selected_status === 1) {
        if (y != this.start_y) {
          console.log('yの値が不正です');
        } else if (x < 1 || x > 12) {
          console.log('xの値が不正です');
        } else {
          this.goal_x = x;
          this.goal_y = y;
          this.selected_status = 0;
          this.drawCell();
        }
      } else {
        console.log('Cell_MultiSelectは選択を開始していませんん');
      }
    };
    Cell_MultiSelect.prototype.getAll = function () {
      start_x = this.start_x;
      start_y = this.start_y;
      goal_x = this.goal_x;
      goal_y = this.goal_y;
      color = this.color;
      selected_status = this.selected_status;
      return {start_x, start_y, goal_x, goal_y, selected_status, color}
    };
    Cell_MultiSelect.prototype.drawCell = function () {
      console.log('i will set color' + this.color + ' to the cell from (' + this.start_x + ', ' + this.start_y +
              ') to (' + this.goal_x + ', ' + this.goal_y + ')');
    };

    const myTest = new Cell_MultiSelect();
    console.log(myTest.getAll());
    myTest.setGoal(1, 4);
    console.log(myTest.getAll());
    myTest.setStart(3, 5);
    console.log(myTest.getAll());
    myTest.setGoal(1, 4);
    console.log(myTest.getAll());
    myTest.setGoal(1, 5);
    console.log(myTest.getAll());


    ///////////////////////////////////////////// //////////////////////////////////////// ////////////////////////////////////////// ////DrawSelected //////////////////////////
    function DrawSelected_addRow(addRow) { /// render selected_crops_tbl
      let cr = '';

      //tableに表示するためのデータ作成
      cr += '<tr>';
      cr += '<td class="tableItem_hide">' + addRow["Food_grp"] + '</td>';
      cr += '<td colspan="12">' + addRow["Food_name"] + '</td>';
      cr += '</tr>';
      cr += '<tr>';
      cr += '<td>' + addRow["m1"] + '</td>';
      cr += '<td>' + addRow["m2"] + '</td>';
      cr += '<td>' + addRow["m3"] + '</td>';
      cr += '<td>' + addRow["m4"] + '</td>';
      cr += '<td>' + addRow["m5"] + '</td>';
      cr += '<td>' + addRow["m6"] + '</td>';
      cr += '<td>' + addRow["m7"] + '</td>';
      cr += '<td>' + addRow["m8"] + '</td>';
      cr += '<td>' + addRow["m9"] + '</td>';
      cr += '<td>' + addRow["m10"] + '</td>';
      cr += '<td>' + addRow["m11"] + '</td>';
      cr += '<td>' + addRow["m12"] + '</td>';
      cr += '<td class="tableItem_hide">' + addRow["food_item_id"] + '</td>';
      cr += '<td class="tableItem_hide">' + addRow["selected_status"] + '</td>';
      cr += '</tr>';

      $myTbl.append(cr);

      let tmpRow = $myTbl.find('tr').last();
      tmpRow.children('td').each(function (i, myCell) {
        switch (Number($(this).text())) { // cellの値に応じて色変化
          case 0:
            $(this).css("background-color", "");
            $(this).css("color", "white");
            break;
          case 1:
            $(this).css("background-color", "red");
            $(this).css("color", "red");
            break;
          case 2:
            $(this).css("background-color", "green");
            $(this).css("color", "green");
            break;
          case 3:
            $(this).css("background-color", "blue");
            $(this).css("color", "blue");
            break;
        }
      });
    }

    ///////////////////////////////////////////// //////////////////////////////////////// ////////////////////////////////////////// ////DrawSelected //////////////////////////
    function DrawSelected_delRow(food_item_id) { /// render selected_crops_tbl
      $myTbl.children('tbody').children('tr').each(function (index_r, myRow) {
        if (index_r % 2 == 1) {
          if ($(myRow).children('td').eq(12).text() == food_item_id) {
            $(myRow).prev('tr').remove();
            $(myRow).remove();
            return false;
          }
        }
      })
    }

    ////////////////  read initial value for crop selected  table ////////////
    $.each(Json_Crop_Selected, function (i, row_tmp) {
      dd = {};
      //データセットの作成
      dd["selected_status"] = row_tmp.selected_status;
      dd["Food_grp"] = row_tmp.Food_grp;
      dd["Food_name"] = row_tmp.Food_name;
      dd["m1"] = row_tmp.m1;
      dd["m2"] = row_tmp.m2;
      dd["m3"] = row_tmp.m3;
      dd["m4"] = row_tmp.m4;
      dd["m5"] = row_tmp.m5;
      dd["m6"] = row_tmp.m6;
      dd["m7"] = row_tmp.m7;
      dd["m8"] = row_tmp.m8;
      dd["m9"] = row_tmp.m9;
      dd["m10"] = row_tmp.m10;
      dd["m11"] = row_tmp.m11;
      dd["m12"] = row_tmp.m12;
      dd["food_item_id"] = row_tmp.food_item_id;

      DrawSelected_addRow(dd);

    });

    ////////////////  install tbl_crop_candidate  ////////////
    var mytable_all = $('#tbl_crop_candidate').DataTable({
      data: Json_Crop_All,
      "pageLength": 20,
      "ordering": false,
      ///initialize selection///
      "createdRow": function (row, data, dataIndex) {
        if (data.selected_status === 1) {
          $(row).addClass('selected');
        }
      },
      /////////////////////////
      "columns": [
        {
          "data": "selected_status"
        }, {
          "data": "Food_grp"
        }, {
          "data": "Food_name"
        }, {
          "data": "m1"
        }, {
          "data": "m2"
        }, {
          "data": "m3"
        }, {
          "data": "m4"
        }, {
          "data": "m5"
        }, {
          "data": "m6"
        }, {
          "data": "m7"
        }, {
          "data": "m8"
        }, {
          "data": "m9"
        }, {
          "data": "m10"
        }, {
          "data": "m11"
        }, {
          "data": "m12"
        }, {
          "data": "food_item_id"
        }
      ],
      "columnDefs": [
        {
          targets: [
            1, 2
          ],
          visible: true
        }, {
          targets: '_all',
          visible: false
        }
      ],


      //////////////////all the initialization process after this
      "initComplete": function (settings, json) {
        getHTML_param();

        //////////////////add filtering dropdown list
        this.api().columns([1]).every(function () {
          var column = this;
          var select = $('<select class="selectpicker" style="max-width: 250px;border: 1px grey double;"><option value=""></option></select>').appendTo($('#newSearchPlace')).on('change', function () {
            var val = $.fn.dataTable.util.escapeRegex($(this).val());

            column.search(
                    val
                            ? '^' + val + '$'
                            : '',
                    true,
                    false
            ).draw();
          });

          column.data().unique().sort().each(function (d, j) {
            select.append('<option value="' + d + '">' + d + '</option>');
          });
        });

        //////////////////on click -> crop list /
        $('#tbl_crop_candidate tbody').on('click', 'tr', function () {
          $(this).toggleClass('selected');
          mydata = mytable_all.row(this).data();

          //削除用フラグのセット
          dd = {};
          dd["food_item_id"] = mydata['food_item_id'];

          if ($(this).hasClass('selected')) {

            //データセットの作成
            dd["selected_status"] = 1;
            dd["Food_grp"] = mydata['Food_grp'];
            dd["Food_name"] = mydata['Food_name'];
            dd["m1"] = mydata['m1'];
            dd["m2"] = mydata['m2'];
            dd["m3"] = mydata['m3'];
            dd["m4"] = mydata['m4'];
            dd["m5"] = mydata['m5'];
            dd["m6"] = mydata['m6'];
            dd["m7"] = mydata['m7'];
            dd["m8"] = mydata['m8'];
            dd["m9"] = mydata['m9'];
            dd["m10"] = mydata['m10'];
            dd["m11"] = mydata['m11'];
            dd["m12"] = mydata['m12'];
            dd["food_item_id"] = mydata['food_item_id'];

            DrawSelected_addRow(dd);

          } else {
            DrawSelected_delRow(dd["food_item_id"]);
          }

          //SetFoodNameColor();
        });

        //////////////open dialog////
        $("#btn_add").click(function () {
          $('#myModal01').modal('show');
        }); ///////////////////
        //////////////////close dialog
        $('#btn_exit01').click(function () {
          $('#myModal01').modal('hide');
        }); ///////////////////

        //////////////////on click -> chabge available status /
        $myTbl.on('click', 'td', function () {
          let myrow = $(this).closest('tr').index();
          let mycol = this.cellIndex;
          if (myrow % 2 == 1) {
            let tmp = Number($(this).text());
            tmp = (tmp + 1) % 4;
            $(this).text(tmp); // cellの値+1

            switch (tmp) { // cellの値に応じて色変化
              case 0:
                $(this).css("background-color", "");
                $(this).css("color", "white");
                break;
              case 1:
                $(this).css("background-color", "red");
                $(this).css("color", "red");
                break;
              case 2:
                $(this).css("background-color", "green");
                $(this).css("color", "green");
                break;
              case 3:
                $(this).css("background-color", "blue");
                $(this).css("color", "blue");
                break;
            }
          }
        });

        //////////////////get data from table
        function getTblData() {
          let d = [];
          $myTbl.children('tbody').children('tr').each(function (index_r, myRow) {
            if (index_r % 2 == 1) {
              let dd = {};
              dd["selected_status"] = 1;
              for (var j = 0; j < 12; j++) {
                dd["m" + String(j + 1)] = $(this).children('td').eq(j).text();
              }
              dd["myFCT_id"] = $(this).children('td').eq(12).text();
              dd["myLocation"] = {{myLocation}};
              d.push(dd);
            }
          });
          console.log(d);
          return {"myJson": d};
        }

        //////////////send crop list to django////
        $("#btn_save").click(function () {
          let hostUrl = myRoot + 'registCropAvail/';
          let mydat = getTblData();
          console.log(hostUrl);
          Set_CRSF();
          sendJson(mydat, hostUrl);
        }); ///////////////////

        //////////////

        ////// csrf_tokenの取得に使う//////////////
        function getCookie(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
              var cookie = jQuery.trim(cookies[i]);
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }

        function csrfSafeMethod(method) {
          // these HTTP methods do not require CSRF protection
          return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        function Set_CRSF() {
          var csrf_token = getCookie("csrftoken");
          $.ajaxSetup({
            crossDomain: false, // obviates need for sameOrigin test
            beforeSend: function (xhr, settings) {
              if (!csrfSafeMethod(settings.type)) {
                xhr.setRequestHeader("X-CSRFToken", csrf_token);
              }
            }
          });
        }

        //////////////////sendJson////
        function sendJson(myjson, hostUrl) {
          $.ajax({
            type: 'post',
            url: hostUrl,
            data: JSON.stringify(myjson),
            contentType: 'application/JSON',
            dataType: 'JSON',
            scriptCharset: 'utf-8',
            success: function (response) {
              window.location.href = response.url;
            },
            error: function (jqXHR, textStatus, errorThrown) {
              alert("fail");
              console.log(jqXHR.responseText);
              console.log(jqXHR.status); //例：404
              console.log(textStatus); //例：error
              console.log(errorThrown); //例：NOT FOUND
              console.log(JSON.stringify(myjson)); //例：NOT FOUND
              console.log(myjson); //例：NOT FOUND
            }
          });
        }

        //////////////////sendJson//// scfript end///////////////////

      }// ---------- initComplete finish here --------------
    });

  </script>


{% endblock %}
